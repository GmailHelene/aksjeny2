{% extends "base.html" %}

{% block title %}Finansiell Dashboard - Aksjeradar{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>{{ t('dashboard.title', fallback='Finansiell Dashboard') }}
                <span class="badge bg-success ms-2" id="market-status">{{ t('market.status.open', fallback='√ÖPEN') }}</span>
                
                <!-- Language Switcher -->
                <div class="float-end">
                    <div class="btn-group" role="group" aria-label="Language switcher">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="lang-no" 
                                onclick="setLanguage('no')" {% if current_language == 'no' %}disabled{% endif %}>
                            üá≥üá¥ Norsk
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="lang-en" 
                                onclick="setLanguage('en')" {% if current_language == 'en' %}disabled{% endif %}>
                            üá∫üá∏ English
                        </button>
                    </div>
                </div>
            </h1>
            
            <!-- Quick Stats Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">{{ t('portfolio.total_value', fallback='Portef√∏lje Verdi') }}</h6>
                                    <h4 id="portfolio-value">{{ user_stats.portfolio_value if user_stats else 'NOK 0' }}</h4>
                                </div>
                                <i class="fas fa-wallet fa-2x opacity-75"></i>
                            </div>
                            <small class="text-light opacity-75">{{ user_stats.monthly_change if user_stats else '+0.0% denne m√•neden' }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">{{ t('portfolio.daily_change', fallback='Daglig Endring') }}</h6>
                                    <h4 id="daily-change">{{ user_stats.daily_change if user_stats else '+0.00%' }}</h4>
                                </div>
                                <i class="fas fa-chart-line fa-2x opacity-75"></i>
                            </div>
                            <small class="text-light opacity-75">{{ t('stats.daily_gain', fallback='Endring i dag') }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">{{ t('portfolio.crypto', fallback='Kryptovaluta') }}</h6>
                                    <h4 id="crypto-count">{{ user_stats.crypto_count if user_stats else '0 coins' }}</h4>
                                </div>
                                <i class="fab fa-bitcoin fa-2x opacity-75"></i>
                            </div>
                            <small class="text-light opacity-75">Crypto i portef√∏lje</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Aksjer i Portef√∏lje</h6>
                                    <h4 id="stock-count">{{ user_stats.stock_count if user_stats else '0 aksjer' }}</h4>
                                </div>
                                <i class="fas fa-chart-bar fa-2x opacity-75"></i>
                            </div>
                            <small class="text-light opacity-75">Aksjer i portef√∏lje</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard Tabs -->
            <ul class="nav nav-tabs mb-4" id="dashboardTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                            type="button" role="tab" aria-controls="overview" aria-selected="true">
                        <i class="fas fa-chart-pie me-2"></i>Oversikt
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stocks-tab" data-bs-toggle="tab" data-bs-target="#stocks" 
                            type="button" role="tab" aria-controls="stocks" aria-selected="false">
                        <i class="fas fa-chart-bar me-2"></i>Aksjer
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="crypto-tab" data-bs-toggle="tab" data-bs-target="#crypto" 
                            type="button" role="tab" aria-controls="crypto" aria-selected="false">
                        <i class="fab fa-bitcoin me-2"></i>Krypto
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="currency-tab" data-bs-toggle="tab" data-bs-target="#currency" 
                            type="button" role="tab" aria-controls="currency" aria-selected="false">
                        <i class="fas fa-coins me-2"></i>Valuta
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="insider-tab" data-bs-toggle="tab" data-bs-target="#insider" 
                            type="button" role="tab" aria-controls="insider" aria-selected="false">
                        <i class="fas fa-user-secret me-2"></i>Innsidehandel
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" 
                            type="button" role="tab" aria-controls="news" aria-selected="false">
                        <i class="fas fa-newspaper me-2"></i>Nyheter
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="dashboardTabContent">
                
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Markedsoversikt</h5>
                                </div>
                                <div class="card-body">
                                    <div id="market-overview-chart" style="height: 400px;">
                                        <!-- Market Overview Data -->
                                        <div class="row">
                                            <div class="col-6">
                                                <h6 class="text-primary">Oslo B√∏rs (OSEBX)</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>1,415.25</span>
                                                    <span class="text-success">+1.2%</span>
                                                </div>
                                                <small class="text-muted">Sist oppdatert: 16:15</small>
                                            </div>
                                            <div class="col-6">
                                                <h6 class="text-primary">S&P 500</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>4,567.89</span>
                                                    <span class="text-success">+0.8%</span>
                                                </div>
                                                <small class="text-muted">Sist oppdatert: 22:00</small>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row mt-3">
                                            <div class="col-6">
                                                <h6 class="text-warning">NASDAQ</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>14,234.56</span>
                                                    <span class="text-danger">-0.3%</span>
                                                </div>
                                                <small class="text-muted">Sist oppdatert: 22:00</small>
                                            </div>
                                            <div class="col-6">
                                                <h6 class="text-warning">Bitcoin</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>$43,250</span>
                                                    <span class="text-success">+2.1%</span>
                                                </div>
                                                <small class="text-muted">Sist oppdatert: 16:10</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">√òkonomiske Indikatorer</h5>
                                </div>
                                <div class="card-body">
                                    <div id="economic-indicators">
                                        <div class="indicator-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Norges Bank Rente</span>
                                                <span class="badge bg-info">4.50%</span>
                                            </div>
                                            <small class="text-muted">Uendret siden juni</small>
                                        </div>
                                        <div class="indicator-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Inflasjon (KPI)</span>
                                                <span class="badge bg-warning">3.2%</span>
                                            </div>
                                            <small class="text-muted">Mai 2025</small>
                                        </div>
                                        <div class="indicator-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Arbeidsledighet</span>
                                                <span class="badge bg-success">3.1%</span>
                                            </div>
                                            <small class="text-muted">Juni 2025</small>
                                        </div>
                                        <div class="indicator-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>USD/NOK</span>
                                                <span class="badge bg-secondary">10.67</span>
                                            </div>
                                            <small class="text-muted">+1.1% i dag</small>
                                        </div>
                                        <div class="indicator-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Oljepris (Brent)</span>
                                                <span class="badge bg-primary">$82.45</span>
                                            </div>
                                            <small class="text-muted">+0.8% i dag</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Sektoranalyse</h5>
                                </div>
                                <div class="card-body">
                                    <div id="sector-analysis">
                                        <div class="list-group">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Energi</strong>
                                                    <br><small class="text-muted">EQNR, AKR, VEI</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+2.1%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Finans</strong>
                                                    <br><small class="text-muted">DNB, NORD, SPOL</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+1.8%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Sj√∏mat</strong>
                                                    <br><small class="text-muted">MOWI, SalMar, LSG</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+1.6%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Industri</strong>
                                                    <br><small class="text-muted">YAR, NHY, AKER</small>
                                                </div>
                                                <span class="badge bg-warning rounded-pill">+0.5%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Teknologi</strong>
                                                    <br><small class="text-muted">TEL, NOR, KAHOT</small>
                                                </div>
                                                <span class="badge bg-danger rounded-pill">-0.8%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stocks Tab -->
                <div class="tab-pane fade" id="stocks" role="tabpanel" aria-labelledby="stocks-tab">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Aksjer</h5>
                                    <div>
                                        <button class="btn btn-outline-primary btn-sm" id="add-stock-btn">
                                            <i class="fas fa-plus me-1"></i>Legg til aksje
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" id="refresh-stocks-btn">
                                            <i class="fas fa-sync-alt me-1"></i>Oppdater
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="stocks-table">
                                            <thead>
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Pris</th>
                                                    <th>Endring</th>
                                                    <th>Endring %</th>
                                                    <th>Volum</th>
                                                    <th>P/E</th>
                                                    <th>Utbytte</th>
                                                    <th>Mkt Cap</th>
                                                    <th>Handlinger</th>
                                                </tr>
                                            </thead>
                            <tbody>
                                                <tr>
                                                    <td><strong>EQNR</strong><br><small class="text-muted">Equinor ASA</small></td>
                                                    <td>NOK 285.40</td>
                                                    <td class="text-success">+4.20</td>
                                                    <td class="text-success">+1.49%</td>
                                                    <td>2.1M</td>
                                                    <td>12.5</td>
                                                    <td>2.8%</td>
                                                    <td>920B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('EQNR.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('EQNR.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>DNB</strong><br><small class="text-muted">DNB Bank ASA</small></td>
                                                    <td>NOK 198.50</td>
                                                    <td class="text-success">+2.80</td>
                                                    <td class="text-success">+1.43%</td>
                                                    <td>1.8M</td>
                                                    <td>8.9</td>
                                                    <td>5.2%</td>
                                                    <td>280B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('DNB.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('DNB.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>TEL</strong><br><small class="text-muted">Telenor ASA</small></td>
                                                    <td>NOK 115.20</td>
                                                    <td class="text-danger">-1.40</td>
                                                    <td class="text-danger">-1.20%</td>
                                                    <td>865K</td>
                                                    <td>15.2</td>
                                                    <td>4.1%</td>
                                                    <td>155B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('TEL.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('TEL.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>YAR</strong><br><small class="text-muted">Yara International</small></td>
                                                    <td>NOK 425.80</td>
                                                    <td class="text-success">+8.60</td>
                                                    <td class="text-success">+2.06%</td>
                                                    <td>445K</td>
                                                    <td>11.8</td>
                                                    <td>1.9%</td>
                                                    <td>108B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('YAR.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('YAR.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>MOWI</strong><br><small class="text-muted">Mowi ASA</small></td>
                                                    <td>NOK 195.40</td>
                                                    <td class="text-success">+3.20</td>
                                                    <td class="text-success">+1.67%</td>
                                                    <td>1.1M</td>
                                                    <td>18.4</td>
                                                    <td>3.5%</td>
                                                    <td>102B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('MOWI.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('MOWI.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>NHY</strong><br><small class="text-muted">Norsk Hydro ASA</small></td>
                                                    <td>NOK 68.45</td>
                                                    <td class="text-danger">-0.85</td>
                                                    <td class="text-danger">-1.23%</td>
                                                    <td>2.3M</td>
                                                    <td>9.2</td>
                                                    <td>6.8%</td>
                                                    <td>140B</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('NHY.OL')">Detaljer</button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="dashboard.buyStock('NHY.OL')">Kj√∏p</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crypto Tab -->
                <div class="tab-pane fade" id="crypto" role="tabpanel" aria-labelledby="crypto-tab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Kryptovaluta Markeder</h5>
                                    <button class="btn btn-outline-success btn-sm" id="refresh-crypto-btn">
                                        <i class="fas fa-sync-alt me-1"></i>Oppdater
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="crypto-table">
                                            <thead>
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>Navn</th>
                                                    <th>Pris (USD)</th>
                                                    <th>24t Endring</th>
                                                    <th>Markedsverdi</th>
                                                    <th>Volum 24t</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>1</td>
                                                    <td><strong>Bitcoin</strong><br><small class="text-muted">BTC</small></td>
                                                    <td>$43,245.67</td>
                                                    <td class="text-success">+2.14%</td>
                                                    <td>$850.2B</td>
                                                    <td>$28.4B</td>
                                                </tr>
                                                <tr>
                                                    <td>2</td>
                                                    <td><strong>Ethereum</strong><br><small class="text-muted">ETH</small></td>
                                                    <td>$2,456.32</td>
                                                    <td class="text-success">+1.87%</td>
                                                    <td>$295.1B</td>
                                                    <td>$12.7B</td>
                                                </tr>
                                                <tr>
                                                    <td>3</td>
                                                    <td><strong>Tether</strong><br><small class="text-muted">USDT</small></td>
                                                    <td>$1.00</td>
                                                    <td class="text-muted">+0.01%</td>
                                                    <td>$118.5B</td>
                                                    <td>$45.2B</td>
                                                </tr>
                                                <tr>
                                                    <td>4</td>
                                                    <td><strong>BNB</strong><br><small class="text-muted">BNB</small></td>
                                                    <td>$591.45</td>
                                                    <td class="text-danger">-0.45%</td>
                                                    <td>$85.4B</td>
                                                    <td>$1.8B</td>
                                                </tr>
                                                <tr>
                                                    <td>5</td>
                                                    <td><strong>Solana</strong><br><small class="text-muted">SOL</small></td>
                                                    <td>$152.78</td>
                                                    <td class="text-success">+4.23%</td>
                                                    <td>$71.2B</td>
                                                    <td>$3.1B</td>
                                                </tr>
                                                <tr>
                                                    <td>6</td>
                                                    <td><strong>USDC</strong><br><small class="text-muted">USDC</small></td>
                                                    <td>$1.00</td>
                                                    <td class="text-muted">+0.00%</td>
                                                    <td>$35.8B</td>
                                                    <td>$6.2B</td>
                                                </tr>
                                                <tr>
                                                    <td>7</td>
                                                    <td><strong>XRP</strong><br><small class="text-muted">XRP</small></td>
                                                    <td>$0.634</td>
                                                    <td class="text-success">+1.92%</td>
                                                    <td>$35.9B</td>
                                                    <td>$1.4B</td>
                                                </tr>
                                                <tr>
                                                    <td>8</td>
                                                    <td><strong>Cardano</strong><br><small class="text-muted">ADA</small></td>
                                                    <td>$0.456</td>
                                                    <td class="text-success">+3.12%</td>
                                                    <td>$16.1B</td>
                                                    <td>$789M</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Trending Krypto</h5>
                                </div>
                                <div class="card-body">
                                    <div id="trending-crypto">
                                        <div class="list-group">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Solana (SOL)</strong>
                                                    <br><small class="text-muted">$152.78</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+4.23%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Cardano (ADA)</strong>
                                                    <br><small class="text-muted">$0.456</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+3.12%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Polygon (MATIC)</strong>
                                                    <br><small class="text-muted">$0.89</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+2.87%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Bitcoin (BTC)</strong>
                                                    <br><small class="text-muted">$43,245</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+2.14%</span>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>XRP (XRP)</strong>
                                                    <br><small class="text-muted">$0.634</small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">+1.92%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Currency Tab -->
                <div class="tab-pane fade" id="currency" role="tabpanel" aria-labelledby="currency-tab">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Valutakurser (USD)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="currency-table">
                                            <thead>
                                                <tr>
                                                    <th>Valuta</th>
                                                    <th>Kurs</th>
                                                    <th>24t Endring</th>
                                                    <th>Bid</th>
                                                    <th>Ask</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>EUR/USD</strong><br><small class="text-muted">Euro</small></td>
                                                    <td>1.0892</td>
                                                    <td class="text-success">+0.15%</td>
                                                    <td>1.0890</td>
                                                    <td>1.0894</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>GBP/USD</strong><br><small class="text-muted">Britiske pund</small></td>
                                                    <td>1.2745</td>
                                                    <td class="text-danger">-0.23%</td>
                                                    <td>1.2743</td>
                                                    <td>1.2747</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>USD/NOK</strong><br><small class="text-muted">Norske kroner</small></td>
                                                    <td>10.6745</td>
                                                    <td class="text-success">+1.12%</td>
                                                    <td>10.6720</td>
                                                    <td>10.6770</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>USD/JPY</strong><br><small class="text-muted">Japanske yen</small></td>
                                                    <td>149.85</td>
                                                    <td class="text-success">+0.45%</td>
                                                    <td>149.82</td>
                                                    <td>149.88</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>USD/CAD</strong><br><small class="text-muted">Kanadiske dollar</small></td>
                                                    <td>1.3567</td>
                                                    <td class="text-danger">-0.18%</td>
                                                    <td>1.3565</td>
                                                    <td>1.3569</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>AUD/USD</strong><br><small class="text-muted">Australske dollar</small></td>
                                                    <td>0.6687</td>
                                                    <td class="text-success">+0.34%</td>
                                                    <td>0.6685</td>
                                                    <td>0.6689</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>USD/CHF</strong><br><small class="text-muted">Sveitsiske franc</small></td>
                                                    <td>0.8734</td>
                                                    <td class="text-danger">-0.12%</td>
                                                    <td>0.8732</td>
                                                    <td>0.8736</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>USD/SEK</strong><br><small class="text-muted">Svenske kroner</small></td>
                                                    <td>10.2345</td>
                                                    <td class="text-success">+0.78%</td>
                                                    <td>10.2320</td>
                                                    <td>10.2370</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Valutakalkulator</h5>
                                </div>
                                <div class="card-body">
                                    <form id="currency-converter-form">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <label class="form-label">Fra</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="amount-from" value="1" min="0" step="0.01">
                                                    <select class="form-select" id="currency-from">
                                                        <option value="USD">USD</option>
                                                        <option value="EUR">EUR</option>
                                                        <option value="NOK" selected>NOK</option>
                                                        <option value="GBP">GBP</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <label class="form-label">&nbsp;</label>
                                                <div class="pt-2">
                                                    <i class="fas fa-exchange-alt fa-lg"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <label class="form-label">Til</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="amount-to" readonly>
                                                    <select class="form-select" id="currency-to">
                                                        <option value="USD" selected>USD</option>
                                                        <option value="EUR">EUR</option>
                                                        <option value="NOK">NOK</option>
                                                        <option value="GBP">GBP</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100 mt-3">
                                            <i class="fas fa-calculator me-2"></i>Konverter
                                        </button>
                                    </form>
                                    <div id="conversion-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insider Trading Tab -->
                <div class="tab-pane fade" id="insider" role="tabpanel" aria-labelledby="insider-tab">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Innsidehandel Analyse</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <form id="insider-search-form">
                                                <div class="mb-3">
                                                    <label for="insider-symbol" class="form-label">Aksjesymbol</label>
                                                    <input type="text" class="form-control" id="insider-symbol" 
                                                           placeholder="f.eks. AAPL" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="fas fa-search me-2"></i>Analyser
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-9">
                                            <div id="insider-analysis-results">
                                                <div class="text-center text-muted py-5">
                                                    <i class="fas fa-user-secret fa-3x mb-3"></i>
                                                    <p>S√∏k etter en aksje for √• se innsidehandel analyse</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insider Trading Tab -->
                <div class="tab-pane fade" id="insider" role="tabpanel" aria-labelledby="insider-tab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Innsidehandel Aktivitet</h5>
                                    <div>
                                        <input type="text" class="form-control form-control-sm" id="insider-search" 
                                               placeholder="S√∏k etter selskap eller insider...">
                                        <button class="btn btn-outline-success btn-sm ms-2" id="refresh-insider-btn">
                                            <i class="fas fa-sync-alt me-1"></i>Oppdater
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm" id="insider-table">
                                            <thead>
                                                <tr>
                                                    <th>Dato</th>
                                                    <th>Selskap</th>
                                                    <th>Insider</th>
                                                    <th>Tittel</th>
                                                    <th>Transaksjon</th>
                                                    <th>Aksjer</th>
                                                    <th>Pris</th>
                                                    <th>Verdi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>2025-08-15</td>
                                                    <td><strong>EQNR</strong></td>
                                                    <td>Anders Opedal</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-success">Kj√∏p</span></td>
                                                    <td>10,000</td>
                                                    <td>NOK 285.40</td>
                                                    <td>NOK 2,854,000</td>
                                                </tr>
                                                <tr>
                                                    <td>2025-08-14</td>
                                                    <td><strong>DNB</strong></td>
                                                    <td>Kjerstin Braathen</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-danger">Salg</span></td>
                                                    <td>5,000</td>
                                                    <td>NOK 198.50</td>
                                                    <td>NOK 992,500</td>
                                                </tr>
                                                <tr>
                                                    <td>2025-08-14</td>
                                                    <td><strong>TEL</strong></td>
                                                    <td>Sigve Brekke</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-success">Kj√∏p</span></td>
                                                    <td>7,500</td>
                                                    <td>NOK 115.20</td>
                                                    <td>NOK 864,000</td>
                                                </tr>
                                                <tr>
                                                    <td>2025-08-13</td>
                                                    <td><strong>YAR</strong></td>
                                                    <td>Svein Tore Holsether</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-success">Kj√∏p</span></td>
                                                    <td>2,000</td>
                                                    <td>NOK 425.80</td>
                                                    <td>NOK 851,600</td>
                                                </tr>
                                                <tr>
                                                    <td>2025-08-13</td>
                                                    <td><strong>MOWI</strong></td>
                                                    <td>Ivan Vindheim</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-danger">Salg</span></td>
                                                    <td>3,000</td>
                                                    <td>NOK 195.40</td>
                                                    <td>NOK 586,200</td>
                                                </tr>
                                                <tr>
                                                    <td>2025-08-12</td>
                                                    <td><strong>NHY</strong></td>
                                                    <td>Hilde Merete Aasheim</td>
                                                    <td>CEO</td>
                                                    <td><span class="badge bg-success">Kj√∏p</span></td>
                                                    <td>15,000</td>
                                                    <td>NOK 68.45</td>
                                                    <td>NOK 1,026,750</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Innsidehandel Statistikk</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <h4 class="text-success mb-0" id="insider-buys">23</h4>
                                                <small class="text-muted">Kj√∏p denne uken</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <h4 class="text-danger mb-0" id="insider-sells">18</h4>
                                                <small class="text-muted">Salg denne uken</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6 class="border-bottom pb-2">Mest Aktive Selskaper</h6>
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>EQNR</span>
                                            <span class="badge bg-primary rounded-pill">8 transaksjoner</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>DNB</span>
                                            <span class="badge bg-primary rounded-pill">6 transaksjoner</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>TEL</span>
                                            <span class="badge bg-primary rounded-pill">5 transaksjoner</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>YAR</span>
                                            <span class="badge bg-primary rounded-pill">4 transaksjoner</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>MOWI</span>
                                            <span class="badge bg-primary rounded-pill">3 transaksjoner</span>
                                        </div>
                                    </div>
                                    
                                    <h6 class="border-bottom pb-2 mt-4">Signifikante Transaksjoner</h6>
                                    <div id="significant-trades">
                                        <div class="small mb-2">
                                            <strong>EQNR:</strong> CEO Anders Opedal kj√∏pte 10,000 aksjer
                                            <span class="text-success">(+NOK 2.85M)</span>
                                        </div>
                                        <div class="small mb-2">
                                            <strong>NHY:</strong> CEO Hilde Aasheim kj√∏pte 15,000 aksjer
                                            <span class="text-success">(+NOK 1.03M)</span>
                                        </div>
                                        <div class="small mb-2">
                                            <strong>DNB:</strong> CEO Kjerstin Braathen solgte 5,000 aksjer
                                            <span class="text-danger">(-NOK 992K)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Tab -->
                <div class="tab-pane fade" id="news" role="tabpanel" aria-labelledby="news-tab">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Finansielle Nyheter</h5>
                                    <div>
                                        <select class="form-select form-select-sm" id="news-filter">
                                            <option value="">Alle nyheter</option>
                                            <option value="positive">Positive</option>
                                            <option value="negative">Negative</option>
                                            <option value="neutral">N√∏ytrale</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="financial-news">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Laster nyheter...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Legg til aksje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-stock-form">
                    <div class="mb-3">
                        <label for="new-stock-symbol" class="form-label">Aksjesymbol</label>
                        <input type="text" class="form-control" id="new-stock-symbol" 
                               placeholder="f.eks. AAPL, EQNR.OL" required>
                        <div class="form-text">Bruk .OL for norske aksjer (f.eks. EQNR.OL)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" class="btn btn-primary" id="save-stock-btn">Legg til</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Containers -->
<div id="error-messages"></div>
<div id="success-messages"></div>

{% endblock %}

{% block scripts %}
<!-- Financial Dashboard JavaScript -->
<script>
class FinancialDashboard {
    constructor() {
        this.userStocks = this.loadUserStocks();
        this.refreshInterval = null;
        this.allNewsData = []; // Store all news for filtering
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadInitialData();
        this.startAutoRefresh();
    }

    bindEvents() {
        // Add stock functionality
        document.getElementById('add-stock-btn').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
            modal.show();
        });

        document.getElementById('save-stock-btn').addEventListener('click', () => {
            this.addStock();
        });

        // Refresh buttons
        document.getElementById('refresh-stocks-btn').addEventListener('click', () => {
            this.loadStockData();
        });

        document.getElementById('refresh-crypto-btn').addEventListener('click', () => {
            this.loadCryptoData();
        });

        // Insider functionality
        if (document.getElementById('refresh-insider-btn')) {
            document.getElementById('refresh-insider-btn').addEventListener('click', () => {
                this.loadInsiderData();
            });
        }

        if (document.getElementById('insider-search')) {
            document.getElementById('insider-search').addEventListener('input', (e) => {
                this.filterInsiderData(e.target.value);
            });
        }

        // Insider search (legacy form)
        if (document.getElementById('insider-search-form')) {
            document.getElementById('insider-search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.searchInsiderData();
            });
        }

        // Currency converter
        document.getElementById('currency-converter-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.convertCurrency();
        });

        // News filter
        document.getElementById('news-filter').addEventListener('change', (e) => {
            this.filterNews(e.target.value);
        });

        // Tab change events
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                this.onTabChange(e.target.getAttribute('data-bs-target'));
            });
        });
    }

    async loadInitialData() {
        try {
            await Promise.all([
                this.loadDashboardData(),
                this.loadEconomicIndicators(),
                this.loadSectorAnalysis(),
                this.loadFinancialNews()
            ]);
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }

    async loadDashboardData() {
        try {
            const response = await fetch(`/api/public/market/data?${this.userStocks.map(s => `symbols=${s}`).join('&')}`);
            const data = await response.json();

            if (data.success) {
                this.updateQuickStats(data.dashboard_data);
                this.populateStockTable(data.dashboard_data.stocks);
                this.populateCryptoTable(data.dashboard_data.crypto);
                this.populateCurrencyTable(data.dashboard_data.currencies);
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    async loadEconomicIndicators() {
        try {
            const response = await fetch('/api/public/economic/indicators');
            const data = await response.json();

            if (data.success) {
                this.displayEconomicIndicators(data.economic_indicators);
            }
        } catch (error) {
            console.error('Error loading economic indicators:', error);
        }
    }

    async loadSectorAnalysis() {
        try {
            const response = await fetch('/api/public/market/sectors');
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Response is not JSON');
            }
            
            const data = await response.json();

            if (data.success) {
                this.displaySectorAnalysis(data.sector_analysis);
            }
        } catch (error) {
            console.error('Error loading sector analysis:', error);
            // Display error message
            const container = document.getElementById('sector-analysis');
            container.innerHTML = '<div class="alert alert-warning">Kunne ikke laste sektoranalyse. Pr√∏v igjen senere.</div>';
        }
    }

    async loadFinancialNews() {
        const container = document.getElementById('financial-news');
        
        try {
            // Show loading indicator
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border" role="status"></div><p class="mt-2">Laster finansnyheter...</p></div>';
            
            // Try multiple real news sources
            const newsEndpoints = [
                '/api/public/news/financial?limit=20',
                '/api/news/financial?limit=20',
                '/news/api/latest?limit=20',
                '/api/financial/news?limit=20'
            ];
            
            let newsData = null;
            
            for (const endpoint of newsEndpoints) {
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            if (data.success && (data.news || data.articles || data.data)) {
                                newsData = data.news || data.articles || data.data;
                                console.log(`‚úÖ Real news data loaded from ${endpoint}`);
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to fetch news from ${endpoint}:`, error);
                }
            }

            if (newsData && newsData.length > 0) {
                this.displayFinancialNews(newsData);
            } else {
                // Handle case when no news data available
                console.warn('No news data available, showing loading state');
                this.displayNewsLoadingState();
            }
            
        } catch (error) {
            console.error('Error loading financial news:', error);
            this.displayNewsLoadingState();
        }
    }
    
    displayNewsLoadingState() {
        const container = document.getElementById('financial-news');
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Laster finansnyheter...</strong> - Vent mens vi henter de nyeste nyhetene.
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="dashboard.loadFinancialNews()">
                    <i class="fas fa-sync me-1"></i>Oppdater
                </button>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Laster...</span>
                                </div>
                            </div>
                            <p class="text-center text-muted mt-2">Laster nyheter...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Laster...</span>
                                </div>
                            </div>
                            <p class="text-center text-muted mt-2">Laster nyheter...</p>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    updateQuickStats(dashboardData) {
        // Calculate portfolio value (demo calculation)
        let totalValue = 0;
        let totalChange = 0;

        Object.values(dashboardData.stocks || {}).forEach(stock => {
            totalValue += stock.price * 100; // Assuming 100 shares each
            totalChange += stock.change * 100;
        });

        document.getElementById('portfolio-value').textContent = `NOK ${totalValue.toLocaleString()}`;
        
        const changePercent = totalValue > 0 ? (totalChange / totalValue) * 100 : 0;
        const changeElement = document.getElementById('daily-change');
        changeElement.textContent = `${changePercent > 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
        changeElement.parentElement.className = `card ${changePercent >= 0 ? 'bg-success' : 'bg-danger'} text-white`;

        document.getElementById('crypto-count').textContent = (dashboardData.crypto || []).length;
        document.getElementById('insider-activity').textContent = Math.floor(Math.random() * 50); // Demo
    }

    populateStockTable(stocks) {
        const tbody = document.querySelector('#stocks-table tbody');
        tbody.innerHTML = '';

        Object.entries(stocks || {}).forEach(([symbol, data]) => {
            const row = tbody.insertRow();
            const changePercent = data.change_percent || 0;
            const change = data.change || 0;
            const changeClass = change >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            // Calculate financial metrics with realistic fallbacks
            const price = data.price || data.last_price || 100;
            const volume = data.volume || 1000000;
            const marketCap = data.market_cap || (price * 50000000);
            const peRatio = data.pe_ratio || (15 + Math.random() * 10).toFixed(1);
            const divYield = data.dividend_yield || (2 + Math.random() * 4).toFixed(2);

            row.innerHTML = `
                <td><strong>${symbol}</strong></td>
                <td>$${price.toFixed(2)}</td>
                <td class="${changeClass}">
                    <i class="fas ${changeIcon} me-1"></i>$${Math.abs(change).toFixed(2)}
                </td>
                <td class="${changeClass}">${changePercent > 0 ? '+' : ''}${changePercent.toFixed(2)}%</td>
                <td>${volume.toLocaleString()}</td>
                <td>${peRatio}</td>
                <td>${divYield}%</td>
                <td>$${(marketCap / 1e9).toFixed(2)}B</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewStockDetails('${symbol}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="dashboard.removeStock('${symbol}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
        });
    }

    populateCryptoTable(cryptos) {
        const tbody = document.querySelector('#crypto-table tbody');
        tbody.innerHTML = '';

        // Convert object to array if needed
        const cryptoArray = Array.isArray(cryptos) ? cryptos : Object.entries(cryptos || {}).map(([symbol, data], index) => ({
            rank: index + 1,
            symbol: data.symbol || symbol.replace('-USD', ''),
            name: data.name || symbol,
            price_usd: data.last_price || data.price || 0,
            price_change_percentage_24h: data.change_percent || 0,
            market_cap: data.market_cap || 1000000000,
            volume_24h: data.volume || 100000000
        }));

        cryptoArray.forEach(crypto => {
            const row = tbody.insertRow();
            const changePercent = crypto.price_change_percentage_24h || 0;
            const changeClass = changePercent >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = changePercent >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

            row.innerHTML = `
                <td><span class="badge bg-secondary">${crypto.rank}</span></td>
                <td>
                    <strong>${crypto.symbol}</strong>
                    <small class="text-muted d-block">${crypto.name}</small>
                </td>
                <td>$${crypto.price_usd.toFixed(6)}</td>
                <td class="${changeClass}">
                    <i class="fas ${changeIcon} me-1"></i>${Math.abs(changePercent).toFixed(2)}%
                </td>
                <td>$${(crypto.market_cap / 1e9).toFixed(2)}B</td>
                <td>$${(crypto.volume_24h / 1e6).toFixed(1)}M</td>
            `;
        });
    }

    populateCurrencyTable(currencies) {
        const tbody = document.querySelector('#currency-table tbody');
        tbody.innerHTML = '';

        // Convert object to array if needed
        const currencyArray = Array.isArray(currencies) ? currencies : Object.entries(currencies || {}).map(([pair, data]) => ({
            pair: pair,
            target: data.pair || pair,
            rate: data.rate || data.last_price || 1.0,
            change_24h: data.change || data.change_percent || 0,
            bid: data.bid || (data.rate || 1.0) * 0.999,
            ask: data.ask || (data.rate || 1.0) * 1.001
        }));

        currencyArray.forEach(currency => {
            const row = tbody.insertRow();
            const change24h = currency.change_24h || 0;
            const changeClass = change24h >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = change24h >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

            row.innerHTML = `
                <td><strong>${currency.target}</strong></td>
                <td>${currency.rate.toFixed(4)}</td>
                <td class="${changeClass}">
                    <i class="fas ${changeIcon} me-1"></i>${Math.abs(change24h).toFixed(4)}
                </td>
                <td>${currency.bid.toFixed(4)}</td>
                <td>${currency.ask.toFixed(4)}</td>
            `;
        });
    }

    displayEconomicIndicators(indicators) {
        const container = document.getElementById('economic-indicators');
        container.innerHTML = '';

        (indicators || []).forEach(indicator => {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'mb-3 p-2 border-start border-3 border-primary';
            indicatorDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${indicator.indicator}</strong>
                    <span class="badge bg-light text-dark">${indicator.value}${indicator.unit}</span>
                </div>
                <small class="text-muted">${indicator.date} - ${indicator.source}</small>
            `;
            container.appendChild(indicatorDiv);
        });
    }

    displaySectorAnalysis(sectors) {
        const container = document.getElementById('sector-analysis');
        container.innerHTML = '';

        Object.entries(sectors || {}).forEach(([sector, data]) => {
            const sectorDiv = document.createElement('div');
            sectorDiv.className = 'mb-2 p-2 bg-light rounded';
            
            const trendColor = data.trend === 'bullish' ? 'success' : data.trend === 'bearish' ? 'danger' : 'warning';
            const trendIcon = data.trend === 'bullish' ? 'fa-arrow-up' : data.trend === 'bearish' ? 'fa-arrow-down' : 'fa-minus';
            
            sectorDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${sector.charAt(0).toUpperCase() + sector.slice(1)}</strong>
                        <small class="text-muted d-block">${data.symbols.join(', ')}</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-${trendColor}">
                            <i class="fas ${trendIcon} me-1"></i>${data.performance}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(sectorDiv);
        });
    }

    displayFinancialNews(news) {
        this.allNewsData = news || []; // Store all news data
        this.renderFilteredNews(this.allNewsData);
    }

    renderFilteredNews(newsToShow) {
        const container = document.getElementById('financial-news');
        container.innerHTML = '';

        newsToShow.forEach(article => {
            const newsDiv = document.createElement('div');
            newsDiv.className = 'border-bottom pb-3 mb-3';
            
            const sentimentColor = article.sentiment === 'positive' ? 'success' : 
                                 article.sentiment === 'negative' ? 'danger' : 'warning';
            
            newsDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-1">${article.title}</h6>
                    <span class="badge bg-${sentimentColor}">${article.sentiment}</span>
                </div>
                <p class="text-muted mb-2">${article.summary}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        ${article.source} - ${new Date(article.published_at).toLocaleDateString()}
                    </small>
                    <a href="${article.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        Les mer <i class="fas fa-external-link-alt ms-1"></i>
                    </a>
                </div>
            `;
            container.appendChild(newsDiv);
        });
    }

    filterNews(sentiment) {
        if (!sentiment) {
            // Show all news
            this.renderFilteredNews(this.allNewsData);
        } else {
            // Filter by sentiment
            const filtered = this.allNewsData.filter(article => article.sentiment === sentiment);
            this.renderFilteredNews(filtered);
        }
    }

    onTabChange(tabTarget) {
        // Load data based on which tab is active
        const tabId = tabTarget.replace('#', '');
        console.log('Tab changed to:', tabId);
        
        switch (tabId) {
            case 'overview':
                this.loadDashboardData();
                break;
            case 'stocks':
                this.loadStockData();
                break;
            case 'crypto':
                this.loadCryptoData();
                break;
            case 'currency':
                this.loadCurrencyData();
                break;
            case 'insider':
                this.loadInsiderData();
                break;
            case 'news':
                this.loadFinancialNews();
                break;
            default:
                break;
        }
    }
    
    async searchInsiderData() {
        const symbol = document.getElementById('insider-symbol').value.toUpperCase();
        const container = document.getElementById('insider-analysis-results');
        
        if (!symbol.trim()) {
            container.innerHTML = '<div class="alert alert-warning">Vennligst skriv inn et aksjesymbol</div>';
            return;
        }
        
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border" role="status"></div></div>';
        
        try {
            // Try multiple real data sources
            const endpoints = [
                `/api/insider/analysis/${symbol}`,
                `/api/public/insider/analysis/${symbol}`,
                `/insider-trading/api/latest?symbol=${symbol}`
            ];
            
            let realDataFound = false;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && (data.data || data.insider_data || data.results)) {
                            this.displayInsiderAnalysis(data.data || data.insider_data || data.results);
                            realDataFound = true;
                            break;
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to fetch from ${endpoint}:`, error);
                }
            }
            
            if (!realDataFound) {
                // Only use fallback if no real data is available
                console.warn(`No real insider data found for ${symbol}, using fallback`);
                const fallbackData = this.generateFallbackInsiderData(symbol);
                fallbackData._isDemo = true; // Mark as demo data
                this.displayInsiderAnalysis(fallbackData);
            }
            
        } catch (error) {
            console.error('Error searching insider data:', error);
            const fallbackData = this.generateFallbackInsiderData(symbol);
            fallbackData._isDemo = true;
            this.displayInsiderAnalysis(fallbackData);
        }
    }
    
    generateFallbackInsiderData(symbol) {
        // Create realistic fallback data for demo purposes
        const insiderSentiments = ['Positive', 'Neutral', 'Bullish', 'Mixed', 'Slightly Bullish'];
        const activities = ['Moderate buying', 'Strong buying', 'Light selling', 'Mixed activity', 'Accumulation'];
        const recommendations = ['Buy', 'Watch', 'Hold', 'Accumulate', 'Research'];
        
        // Generate a confidence score between 6.0 and 9.5
        const confidenceScore = (6.0 + Math.random() * 3.5).toFixed(1);
        
        // Generate random dates within the last 3 months
        const getRandomDate = () => {
            const date = new Date();
            date.setDate(date.getDate() - Math.floor(Math.random() * 90));
            return date.toISOString().split('T')[0];
        };
        
        // Generate random transactions
        const transactions = [];
        const insiderNames = [
            'John Smith, Director', 
            'Sarah Johnson, CFO', 
            'Michael Brown, CEO', 
            'Emily Davis, CTO',
            'Robert Wilson, Board Member'
        ];
        
        const transactionTypes = ['Buy', 'Sell'];
        
        for (let i = 0; i < 5; i++) {
            const isBuy = Math.random() > 0.4; // More buys than sells
            transactions.push({
                date: getRandomDate(),
                insider_name: insiderNames[Math.floor(Math.random() * insiderNames.length)],
                transaction_type: isBuy ? 'Buy' : 'Sell',
                shares: Math.floor(Math.random() * 10000) + 1000,
                price_per_share: (Math.random() * 200 + 50).toFixed(2),
                total_value: ((Math.random() * 200 + 50) * (Math.floor(Math.random() * 10000) + 1000)).toFixed(2)
            });
        }
        
        // Sort by date, most recent first
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        return {
            symbol: symbol,
            company_name: `${symbol} Corporation`,
            analysis: {
                insider_sentiment: insiderSentiments[Math.floor(Math.random() * insiderSentiments.length)],
                recent_activity: activities[Math.floor(Math.random() * activities.length)],
                confidence_score: confidenceScore,
                recommendation: recommendations[Math.floor(Math.random() * recommendations.length)]
            },
            transactions: transactions
        };
    }

    displayInsiderAnalysis(data) {
        const container = document.getElementById('insider-analysis-results');
        
        // Show warning if demo data
        const demoWarning = data._isDemo ? `
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Demo data</strong> - Ekte innsidedata er midlertidig utilgjengelig
            </div>` : '';
        
        const html = `
            ${demoWarning}
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Insider Sentiment</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="text-primary">${data.analysis?.insider_sentiment || 'Positive'}</h4>
                                <p class="text-muted mb-0">Aktivitet: ${data.analysis?.recent_activity || 'Moderate buying'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Konfidens Score</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="text-info">${data.analysis?.confidence_score || '7.5'}/10</h4>
                                <p class="text-muted mb-0">Anbefaling: ${data.analysis?.recommendation || 'Watch'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Siste Transaksjoner:</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Dato</th>
                                <th>Innsider</th>
                                <th>Type</th>
                                <th>Antall</th>
                                <th>Pris</th>
                                <th>Verdi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.transactions || []).map(transaction => `
                                <tr>
                                    <td>${transaction.date}</td>
                                    <td>${transaction.insider_name}</td>
                                    <td>${transaction.transaction_type === 'Buy' ? 
                                         '<span class="badge bg-success">Kj√∏p</span>' : 
                                         '<span class="badge bg-danger">Salg</span>'}</td>
                                    <td>${transaction.shares.toLocaleString()}</td>
                                    <td>$${transaction.price_per_share}</td>
                                    <td>$${parseFloat(transaction.total_value).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Dato</th>
                                <th>Insider</th>
                                <th>Tittel</th>
                                <th>Type</th>
                                <th>Aksjer</th>
                                <th>Pris</th>
                                <th>Verdi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.insider_trades || []).map(trade => `
                                <tr>
                                    <td>${trade.date}</td>
                                    <td>${trade.insider}</td>
                                    <td>${trade.title}</td>
                                    <td><span class="badge ${trade.transaction === 'Purchase' ? 'bg-success' : 'bg-danger'}">${trade.transaction}</span></td>
                                    <td>${trade.shares.toLocaleString()}</td>
                                    <td>$${trade.price}</td>
                                    <td>$${trade.value.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
                        <tbody>
                            ${(analysis.insider_transactions || []).slice(0, 5).map(transaction => `
                                <tr>
                                    <td>${transaction.insider_name}</td>
                                    <td><span class="badge ${transaction.transaction_type.includes('Buy') ? 'bg-success' : 'bg-danger'}">${transaction.transaction_type}</span></td>
                                    <td>${transaction.shares.toLocaleString()}</td>
                                    <td>${transaction.transaction_date}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    async loadInsiderData() {
        try {
            const response = await fetch('/api/insider/recent');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.updateInsiderTable(data.insider_trades);
                    this.updateInsiderStats(data.stats);
                    return;
                }
            }
        } catch (error) {
            console.warn('Failed to load real insider data, using demo data:', error);
        }
        
        // Fallback to demo data
        this.updateInsiderTableWithDemo();
    }

    updateInsiderTable(trades) {
        const tbody = document.querySelector('#insider-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td>${trade.date}</td>
                <td><strong>${trade.symbol}</strong></td>
                <td>${trade.insider_name}</td>
                <td>${trade.title}</td>
                <td><span class="badge ${trade.transaction_type === 'Buy' ? 'bg-success' : 'bg-danger'}">${trade.transaction_type === 'Buy' ? 'Kj√∏p' : 'Salg'}</span></td>
                <td>${trade.shares.toLocaleString()}</td>
                <td>${trade.price}</td>
                <td>${trade.total_value.toLocaleString()}</td>
            </tr>
        `).join('');
    }

    updateInsiderTableWithDemo() {
        const tbody = document.querySelector('#insider-table tbody');
        if (!tbody) return;
        
        // Demo data is already in the HTML template
        console.log('Using demo insider trading data');
    }

    updateInsiderStats(stats) {
        if (document.getElementById('insider-buys')) {
            document.getElementById('insider-buys').textContent = stats.weekly_buys || 23;
        }
        if (document.getElementById('insider-sells')) {
            document.getElementById('insider-sells').textContent = stats.weekly_sells || 18;
        }
    }

    filterInsiderData(searchTerm) {
        const table = document.getElementById('insider-table');
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matches = text.includes(searchTerm.toLowerCase());
            row.style.display = matches ? '' : 'none';
        });
    }

    viewStockDetails(symbol) {
        // Navigate to stock details page
        window.location.href = `/stocks/details/${symbol}`;
    }

    buyStock(symbol) {
        // Show buy stock modal or navigate to buy page
        this.showMessage(`Kj√∏p funksjon for ${symbol} er under utvikling`, 'info');
        // You could also open a modal here:
        // const modal = new bootstrap.Modal(document.getElementById('buyStockModal'));
        // modal.show();
    }

    addStock() {
        const symbolInput = document.getElementById('new-stock-symbol');
        const symbol = symbolInput.value.toUpperCase().trim();
        
        if (!symbol) {
            this.showMessage('Vennligst skriv inn et aksjesymbol', 'warning');
            return;
        }
        
        if (this.userStocks.includes(symbol)) {
            this.showMessage(`${symbol} er allerede i din liste`, 'warning');
            return;
        }
        
        // Add to user stocks
        this.userStocks.push(symbol);
        this.saveUserStocks();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addStockModal'));
        modal.hide();
        
        // Refresh data
        this.loadStockData();
        this.showMessage(`${symbol} lagt til i din aksjeliste`, 'success');
        
        // Clear input
        symbolInput.value = '';
    }

    async convertCurrency() {
        const amountFrom = parseFloat(document.getElementById('amount-from').value);
        const currencyFrom = document.getElementById('currency-from').value;
        const currencyTo = document.getElementById('currency-to').value;
        const resultDiv = document.getElementById('conversion-result');
        
        if (!amountFrom || amountFrom <= 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Skriv inn et gyldig bel√∏p</div>';
            return;
        }
        
        if (currencyFrom === currencyTo) {
            resultDiv.innerHTML = `<div class="alert alert-info">${amountFrom} ${currencyFrom} = ${amountFrom} ${currencyTo}</div>`;
            return;
        }
        
        try {
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Konverterer...';
            
            // Try to get real exchange rates
            const response = await fetch(`/api/currency/rates?from=${currencyFrom}&to=${currencyTo}`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.rate) {
                    const convertedAmount = (amountFrom * data.rate).toFixed(2);
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>${amountFrom} ${currencyFrom} = ${convertedAmount} ${currencyTo}</strong><br>
                            <small>Kurs: 1 ${currencyFrom} = ${data.rate.toFixed(4)} ${currencyTo}</small><br>
                            <small class="text-muted">Live valutakurs</small>
                        </div>`;
                    return;
                }
            }
            
            // Fallback to static rates (clearly marked as approximations)
            const approximateRates = {
                'USD': { 'EUR': 0.85, 'NOK': 10.5, 'GBP': 0.73, 'SEK': 10.8, 'DKK': 6.4 },
                'EUR': { 'USD': 1.18, 'NOK': 12.35, 'GBP': 0.86, 'SEK': 11.2, 'DKK': 7.5 },
                'NOK': { 'USD': 0.095, 'EUR': 0.081, 'GBP': 0.069, 'SEK': 1.03, 'DKK': 0.61 },
                'GBP': { 'USD': 1.37, 'EUR': 1.16, 'NOK': 14.5, 'SEK': 12.9, 'DKK': 8.7 },
                'SEK': { 'USD': 0.093, 'EUR': 0.089, 'NOK': 0.97, 'GBP': 0.078, 'DKK': 0.59 },
                'DKK': { 'USD': 0.16, 'EUR': 0.13, 'NOK': 1.64, 'GBP': 0.11, 'SEK': 1.69 }
            };
            
            const rate = approximateRates[currencyFrom]?.[currencyTo];
            if (rate) {
                const convertedAmount = (amountFrom * rate).toFixed(2);
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>${amountFrom} ${currencyFrom} ‚âà ${convertedAmount} ${currencyTo}</strong><br>
                        <small>Tiln√¶rmet kurs: 1 ${currencyFrom} = ${rate.toFixed(4)} ${currencyTo}</small><br>
                        <small class="text-muted">‚ö†Ô∏è Statisk kurs - ikke sanntid</small>
                    </div>`;
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">Valutapar ikke st√∏ttet</div>';
            }
            
        } catch (error) {
            console.error('Error converting currency:', error);
            resultDiv.innerHTML = '<div class="alert alert-danger">Feil ved valutakonvertering</div>';
        }
    }
    
    populateStockTableFallback() {
        const tbody = document.querySelector('#stocks-table tbody');
        if (!tbody) {
            console.error('Stocks table tbody not found');
            return;
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Kunne ikke laste aksjedata</strong><br>
                        <small>Live data er midlertidig utilgjengelig. Pr√∏v √• oppdatere siden.</small><br>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="dashboard.loadStockData()">
                            <i class="fas fa-sync me-1"></i>Pr√∏v igjen
                        </button>
                    </div>
                </td>
            </tr>`;
    }
    
    showMessage(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
        
        // Add to page
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1050';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Auto remove after showing
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    }

    addStock() {
        const symbol = document.getElementById('new-stock-symbol').value.toUpperCase().trim();
        
        if (symbol && !this.userStocks.includes(symbol)) {
            this.userStocks.push(symbol);
            this.saveUserStocks();
            this.loadStockData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addStockModal'));
            modal.hide();
            
            document.getElementById('new-stock-symbol').value = '';
            this.showMessage('Aksje lagt til!', 'success');
        }
    }

    removeStock(symbol) {
        const index = this.userStocks.indexOf(symbol);
        if (index > -1) {
            this.userStocks.splice(index, 1);
            this.saveUserStocks();
            this.loadStockData();
            this.showMessage('Aksje fjernet!', 'info');
        }
    }

    viewStockDetails(symbol) {
        // Redirect to stock details page
        if (symbol) {
            window.open(`/stocks/details/${symbol}`, '_blank');
        }
    }

    buyStock(symbol) {
        // Add to portfolio functionality
        if (symbol) {
            // Try to add to portfolio
            if (confirm(`Vil du legge til ${symbol} i portef√∏ljen din?`)) {
                fetch('/portfolio/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({
                        ticker: symbol,
                        quantity: 1,
                        purchase_price: 0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.showMessage(`${symbol} ble lagt til i portef√∏ljen!`, 'success');
                    } else {
                        this.showMessage(data.message || 'Kunne ikke legge til aksjen', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error adding stock:', error);
                    this.showMessage('Feil ved tillegging av aksje', 'error');
                });
            }
        }
    }

    async loadStockData() {
        try {
            const loadingDiv = document.querySelector('#stocks .card-body');
            loadingDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Laster aksjedata...</p></div>';
            
            // Try real data first
            const response = await fetch('/api/market/comprehensive', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbols: this.userStocks })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.market_data) {
                    this.populateStockTable(data.market_data);
                    return;
                }
            }
            
            // Fallback to individual stock lookups with real data
            const stockData = {};
            for (const symbol of this.userStocks) {
                try {
                    const stockResponse = await fetch(`/api/stock/${symbol}`);
                    if (stockResponse.ok) {
                        const stockInfo = await stockResponse.json();
                        if (stockInfo.success) {
                            stockData[symbol] = stockInfo.data;
                        }
                    }
                } catch (error) {
                    console.warn(`Could not fetch real data for ${symbol}`);
                }
            }
            
            if (Object.keys(stockData).length > 0) {
                this.populateStockTable(stockData);
            } else {
                // Only use fallback if absolutely no real data is available
                this.populateStockTableFallback();
            }
            
        } catch (error) {
            console.error('Error loading stock data:', error);
            this.populateStockTableFallback();
        }
    }

    async loadCryptoData() {
        try {
            const response = await fetch('/api/crypto/data?limit=20');
            const data = await response.json();
            
            if (data.success) {
                this.populateCryptoTable(data.crypto_data);
            }
            
            // Load trending crypto
            const trendingResponse = await fetch('/api/crypto/trending');
            const trendingData = await trendingResponse.json();
            
            if (trendingData.success) {
                this.displayTrendingCrypto(trendingData.trending_crypto);
            }
        } catch (error) {
            console.error('Error loading crypto data:', error);
        }
    }

    populateCurrencyTable(currencies) {
        const tbody = document.querySelector('#currency-table tbody');
        if (!tbody) {
            console.error('Currency table tbody not found');
            return;
        }
        
        tbody.innerHTML = '';
        
        // Ensure currencies is an object
        if (!currencies || typeof currencies !== 'object') {
            console.error('Invalid currency data:', currencies);
            return;
        }
        
        // Convert to array if it's an object
        const currencyEntries = Object.entries(currencies).map(([pair, data]) => ({
            pair,
            ...data
        }));
        
        currencyEntries.forEach(currency => {
            const row = tbody.insertRow();
            const changeClass = (currency.change_percent >= 0) ? 'text-success' : 'text-danger';
            
            const [base, quote] = currency.pair.split('/');
            
            let currencyName = 'Foreign Currency';
            if (quote === 'NOK') {
                if (base === 'USD') currencyName = 'Amerikanske dollar';
                if (base === 'EUR') currencyName = 'Euro';
                if (base === 'GBP') currencyName = 'Britiske pund';
                if (base === 'SEK') currencyName = 'Svenske kroner';
                if (base === 'DKK') currencyName = 'Danske kroner';
                if (base === 'JPY') currencyName = 'Japanske yen';
                if (base === 'CHF') currencyName = 'Sveitsiske franc';
                if (base === 'CAD') currencyName = 'Kanadiske dollar';
                if (base === 'AUD') currencyName = 'Australske dollar';
                if (base === 'NZD') currencyName = 'New Zealand dollar';
            }
            
            row.innerHTML = `
                <td><strong>${currency.pair}</strong><br><small class="text-muted">${currencyName}</small></td>
                <td>${currency.rate.toFixed(4)}</td>
                <td class="${changeClass}">${currency.change_percent > 0 ? '+' : ''}${currency.change_percent.toFixed(2)}%</td>
                <td>${(currency.rate * 0.999).toFixed(4)}</td>
                <td>${(currency.rate * 1.001).toFixed(4)}</td>
            `;
        });
    }
    
    displayTrendingCrypto(trending) {
        const container = document.getElementById('trending-crypto');
        container.innerHTML = '';
        
        trending.forEach(crypto => {
            const cryptoDiv = document.createElement('div');
            cryptoDiv.className = 'mb-2 p-2 border rounded';
            cryptoDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${crypto.symbol}</strong>
                        <small class="text-muted d-block">${crypto.name}</small>
                    </div>
                    <span class="badge bg-primary">#${crypto.rank}</span>
                </div>
            `;
            container.appendChild(cryptoDiv);
        });
    }

    async loadCurrencyData() {
        try {
            const loadingDiv = document.querySelector('#currency .card-body');
            loadingDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Laster valutadata...</p></div>';
            
            const response = await fetch('/api/currency/rates');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.currency_rates) {
                this.populateCurrencyTable(data.currency_rates);
                this.setupCurrencyConverter(data.currency_rates);
            } else {
                throw new Error('Failed to load currency data');
            }
        } catch (error) {
            console.error('Error loading currency data:', error);
            
            // Create fallback currency data
            const fallbackCurrencies = {
                'USD/NOK': { rate: 10.67, change_percent: 0.12 },
                'EUR/NOK': { rate: 11.82, change_percent: -0.05 },
                'GBP/NOK': { rate: 13.45, change_percent: 0.08 },
                'SEK/NOK': { rate: 0.98, change_percent: 0.01 },
                'DKK/NOK': { rate: 1.58, change_percent: -0.02 },
                'JPY/NOK': { rate: 0.074, change_percent: 0.15 },
                'CHF/NOK': { rate: 12.15, change_percent: -0.08 },
                'CAD/NOK': { rate: 8.05, change_percent: 0.04 },
                'AUD/NOK': { rate: 7.20, change_percent: 0.10 },
                'NZD/NOK': { rate: 6.58, change_percent: -0.15 }
            };
            
            this.populateCurrencyTable(fallbackCurrencies);
            this.setupCurrencyConverter(fallbackCurrencies);
        }
    }
    
    setupCurrencyConverter(currencyRates) {
        // Set up currency converter
        const fromAmount = document.getElementById('amount-from');
        const fromCurrency = document.getElementById('currency-from');
        const toAmount = document.getElementById('amount-to');
        const toCurrency = document.getElementById('currency-to');
        const convertButton = document.querySelector('#currency-converter-form button[type="submit"]');
        
        convertButton.addEventListener('click', (e) => {
            e.preventDefault();
            this.convertCurrency();
        });
        
        // Also convert when inputs change
        [fromAmount, fromCurrency, toCurrency].forEach(element => {
            element.addEventListener('change', () => {
                this.convertCurrency();
            });
        });
        
        // Do an initial conversion
        this.convertCurrency();
    }

    startAutoRefresh() {
        // Refresh data every 5 minutes
        this.refreshInterval = setInterval(() => {
            this.loadDashboardData();
        }, 5 * 60 * 1000);
    }

    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
    }

    loadUserStocks() {
        const stored = localStorage.getItem('aksjeradar_user_stocks');
        return stored ? JSON.parse(stored) : ['EQNR.OL', 'DNB.OL', 'TEL.OL', 'AAPL', 'GOOGL'];
    }

    saveUserStocks() {
        localStorage.setItem('aksjeradar_user_stocks', JSON.stringify(this.userStocks));
    }

    showMessage(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
}

// Language switching functionality
function setLanguage(language) {
    console.log('üåê Switching language to:', language);
    
    // Show loading indicator
    const langButtons = document.querySelectorAll('#lang-no, #lang-en');
    langButtons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = btn.innerHTML.includes('üá≥üá¥') ? 'üá≥üá¥ ...' : 'üá∫üá∏ ...';
    });
    
    // Make request to set language
    fetch(`/set-language/${language}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            // Reload page to apply new language
            window.location.reload();
        } else {
            console.error('‚ùå Failed to set language');
            // Reset buttons
            langButtons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = btn.innerHTML.includes('üá≥üá¥') ? 'üá≥üá¥ Norsk' : 'üá∫üá∏ English';
            });
        }
    })
    .catch(error => {
        console.error('‚ùå Language switch error:', error);
        // Reset buttons
        langButtons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = btn.innerHTML.includes('üá≥üá¥') ? 'üá≥üá¥ Norsk' : 'üá∫üá∏ English';
        });
    });
}

// Initialize dashboard when page loads
let dashboard;
document.addEventListener('DOMContentLoaded', function() {
    dashboard = new FinancialDashboard();
});
</script>
{% endblock %}
