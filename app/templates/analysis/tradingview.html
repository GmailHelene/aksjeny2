{% extends "base.html" %}

{% block title %}TradingView Charts - {{ symbol if symbol else 'Aksjeradar' }}{% endblock %}

{% block head %}
<!-- TradingView Chart Library -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% include 'analysis/_menu.html' %}
    
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="bi bi-graph-up text-primary me-2"></i>
                    TradingView Charts
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Hjem</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('analysis.index') }}">Analyse</a></li>
                        <li class="breadcrumb-item active">TradingView</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> TradingView charts er midlertidig utilgjengelig.
    </div>
    {% endif %}

    <!-- Stock Search -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-3">
                        <i class="bi bi-search me-2"></i>Velg aksje/symbol for analyse
                    </h5>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="symbolSearch" 
                               placeholder="Aksjesymbol (f.eks. EQNR.OL, AAPL, BTC-USD)" 
                               value="{{ symbol if symbol else '' }}">
                        <button class="btn btn-primary" type="button" id="loadChart">
                            <i class="bi bi-bar-chart-line"></i> Last chart
                        </button>
                    </div>
                    <small class="text-muted">
                        <strong>Eksempler:</strong> 
                        <code>EQNR.OL</code> (Oslo Børs), 
                        <code>AAPL</code> (US aksjer), 
                        <code>BTC-USD</code> (Crypto), 
                        <code>EURUSD=X</code> (Forex)
                    </small>
                </div>
                <div class="col-md-4">
                    {% if stock_info %}
                    <div class="text-md-end">
                        <h6 class="mb-1 text-primary">{{ symbol }}</h6>
                        <p class="text-muted mb-1">{{ stock_info.get('shortName', symbol) }}</p>
                        {% if stock_info.get('regularMarketPrice') %}
                        <span class="h5 text-success">{{ "%.2f"|format(stock_info.regularMarketPrice) }} {{ stock_info.get('currency', 'USD') }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-md-end text-muted">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        <p class="small mt-2">TradingView integrert chart</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main TradingView Widget -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart me-2"></i>
                Avansert Chart - {{ symbol if symbol else 'Velg aksje' }}
            </h5>
        </div>
        <div class="card-body p-0">
            <div id="tradingview_main_widget" style="height: 600px;">
                <!-- TradingView Chart will load here -->
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laster chart...</span>
                    </div>
                    <p class="text-muted mt-3">Laster TradingView chart...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick symbol buttons -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="mb-3">Populære aksjer</h6>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('EQNR.OL')">EQNR</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('DNB.OL')">DNB</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('AAPL')">AAPL</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('TSLA')">TSLA</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('MSFT')">MSFT</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('BTC-USD')">Bitcoin</button>
            </div>
        </div>
    </div>

    <!-- Technical Analysis Widget -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">Teknisk Analyse</h6>
                </div>
                <div class="card-body p-0">
                    <div id="tradingview_technical_analysis" style="height: 400px;">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Laster...</span>
                            </div>
                            <p class="text-muted mt-3">Laster teknisk analyse...</p>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Technical Analysis Widget -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">Teknisk Analyse Sammendrag</h6>
                </div>
                <div class="card-body p-0">
                    <div id="tradingview_technical_analysis" style="height: 300px;">
                        <div class="text-center p-4">
                            <i class="fas fa-chart-line text-primary mb-2" style="font-size: 2rem;"></i>
                            <h6>Teknisk Analyse</h6>
                            <p class="text-muted small">Avanserte indikatorer laster...</p>
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Laster...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Economic Calendar -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h6 class="mb-0">Økonomisk Kalender</h6>
        </div>
        <div class="card-body p-0">
            <div id="tradingview_economic_calendar" style="height: 400px;">
                <div class="text-center p-4">
                    <i class="fas fa-calendar text-primary mb-2" style="font-size: 2rem;"></i>
                    <h6>Økonomisk Kalender</h6>
                    <p class="text-muted small">Viktige økonomiske hendelser laster...</p>
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Laster...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentSymbol = '{{ symbol if symbol else "AAPL" }}';
let widgets = {};

// Format symbol for TradingView
function formatSymbolForTradingView(symbol) {
    if (!symbol) return 'NASDAQ:AAPL';
    
    symbol = symbol.toUpperCase();
    
    if (symbol.endsWith('.OL')) {
        return `OSL:${symbol.replace('.OL', '')}`;
    } else if (symbol.endsWith('.L')) {
        return `LSE:${symbol.replace('.L', '')}`;
    } else if (symbol.includes('-USD')) {
        const base = symbol.replace('-USD', '');
        return `BINANCE:${base}USDT`;
    } else if (!symbol.includes(':')) {
        return `NASDAQ:${symbol}`;
    }
    
    return symbol;
}

document.addEventListener('DOMContentLoaded', function() {
    // Ensure TradingView script is loaded before initializing
    function waitForTradingView() {
        if (typeof TradingView !== 'undefined') {
            console.log('✅ TradingView library loaded');
            // Initialize charts with longer delay to ensure stability
            setTimeout(() => {
                try {
                    loadMainChart(currentSymbol);
                    loadTechnicalAnalysis(currentSymbol);
                } catch (error) {
                    console.error('Error initializing charts:', error);
                    showFallbackMessage();
                }
            }, 2000);
        } else {
            console.log('⏳ Waiting for TradingView library...');
            setTimeout(waitForTradingView, 500);
        }
    }
    
    waitForTradingView();
    
    // Search functionality
    document.getElementById('loadChart').addEventListener('click', function() {
        const symbol = document.getElementById('symbolSearch').value.trim().toUpperCase();
        if (symbol) {
            loadSymbol(symbol);
        }
    });
    
    // Enter key search
    document.getElementById('symbolSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const symbol = this.value.trim().toUpperCase();
            if (symbol) {
                loadSymbol(symbol);
            }
        }
    });
});

// Fallback message function
function showFallbackMessage() {
    const container = document.getElementById('tradingview_main_widget');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <h5>TradingView Chart</h5>
                    <p>Charts lastes fra TradingView. Hvis chart ikke vises, prøv å refreshe siden eller sjekk din internettforbindelse.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh side
                    </button>
                </div>
            </div>
        `;
    }
}

// Main chart loader
function loadMainChart(symbol) {
    const container = document.getElementById('tradingview_main_widget');
    if (!container) return;
    
    // Clear container
    container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="text-muted mt-3">Laster TradingView chart...</p></div>';
    
    // Wait for TradingView to load
    function initChart() {
        if (typeof TradingView !== 'undefined' && TradingView.widget) {
            try {
                const formattedSymbol = formatSymbolForTradingView(symbol);
                
                widgets.mainChart = new TradingView.widget({
                    "width": "100%",
                    "height": 600,
                    "symbol": formattedSymbol,
                    "interval": "D",
                    "timezone": "Europe/Oslo",
                    "theme": "light",
                    "style": "1",
                    "locale": "no",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview_main_widget",
                    "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                    "watchlist": [
                        "NASDAQ:AAPL", "NASDAQ:TSLA", "NASDAQ:MSFT", 
                        "OSL:EQNR", "OSL:DNB", "OSL:MOWI"
                    ]
                });
                
                console.log('✅ TradingView main chart loaded for ' + formattedSymbol);
            } catch (error) {
                console.error('❌ Error loading main chart:', error);
                showFallbackChart(container, symbol);
            }
        } else {
            // TradingView not ready, try again
            setTimeout(initChart, 500);
        }
    }
    
    initChart();
}

// Technical analysis widget
function loadTechnicalAnalysis(symbol) {
    const container = document.getElementById('tradingview_technical_analysis');
    if (!container) return;
    
    function initTechAnalysis() {
        if (typeof TradingView !== 'undefined' && TradingView.TechnicalAnalysisWidget) {
            try {
                const formattedSymbol = formatSymbolForTradingView(symbol);
                
                widgets.techAnalysis = new TradingView.TechnicalAnalysisWidget({
                    "interval": "1D",
                    "width": "100%",
                    "isTransparent": false,
                    "height": "400",
                    "symbol": formattedSymbol,
                    "showIntervalTabs": true,
                    "locale": "no",
                    "colorTheme": "light",
                    "container_id": "tradingview_technical_analysis"
                });
                
                console.log('✅ Technical analysis widget loaded');
            } catch (error) {
                console.error('❌ Error loading technical analysis:', error);
                container.innerHTML = '<div class="text-center p-4 text-muted">Teknisk analyse ikke tilgjengelig</div>';
            }
        } else {
            setTimeout(initTechAnalysis, 500);
        }
    }
    
    initTechAnalysis();
}

// Fallback chart display
function showFallbackChart(container, symbol) {
    container.innerHTML = `
        <div class="text-center p-5 border rounded bg-light">
            <i class="bi bi-bar-chart text-primary mb-3" style="font-size: 3rem;"></i>
            <h4>TradingView Chart</h4>
            <p class="text-muted">Symbol: <strong>${symbol}</strong></p>
            <div class="alert alert-info">
                Chart kunne ikke lastes. Prøv å oppdatere siden eller besøk TradingView direkte.
            </div>
            <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Oppdater
                </button>
                <a href="https://www.tradingview.com/symbols/${symbol}" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Åpne i TradingView
                </a>
            </div>
        </div>`;
}

// Load symbol function
function loadSymbol(symbol) {
    currentSymbol = symbol;
    document.getElementById('symbolSearch').value = symbol;
    loadMainChart(symbol);
    loadTechnicalAnalysis(symbol);
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('symbol', symbol);
    window.history.pushState({}, '', url);
}
</script>
{% endblock %}
