{% extends "base.html" %}

{% block title %}TradingView Charts - {{ symbol if symbol else 'Aksjeradar' }}{% endblock %}

{% block head %}
<!-- TradingView Chart Library -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<!-- TradingView Fix Script -->
<script type="text/javascript" src="{{ url_for('static', filename='js/tradingview-fix.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% include 'analysis/_menu.html' %}
    
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="bi bi-graph-up text-primary me-2"></i>
                    TradingView Charts
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Hjem</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('analysis.index') }}">Analyse</a></li>
                        <li class="breadcrumb-item active">TradingView</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> TradingView charts er midlertidig utilgjengelig.
    </div>
    {% endif %}

    <!-- Stock Search -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-3">
                        <i class="bi bi-search me-2"></i>Velg aksje/symbol for analyse
                    </h5>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="symbolSearch" 
                               placeholder="Aksjesymbol (f.eks. EQNR.OL, AAPL, BTC-USD)" 
                               value="{{ symbol if symbol else '' }}">
                        <button class="btn btn-primary" type="button" id="loadChart">
                            <i class="bi bi-bar-chart-line"></i> Last chart
                        </button>
                    </div>
                    <small class="text-muted">
                        <strong>Eksempler:</strong> 
                        <code>EQNR.OL</code> (Oslo B√∏rs), 
                        <code>AAPL</code> (US aksjer), 
                        <code>BTC-USD</code> (Crypto), 
                        <code>EURUSD=X</code> (Forex)
                    </small>
                </div>
                <div class="col-md-4">
                    {% if stock_info %}
                    <div class="text-md-end">
                        <h6 class="mb-1 text-primary">{{ symbol }}</h6>
                        <p class="text-muted mb-1">{{ stock_info.get('shortName', symbol) }}</p>
                        {% if stock_info.get('regularMarketPrice') %}
                        <span class="h5 text-success">{{ "%.2f"|format(stock_info.regularMarketPrice) }} {{ stock_info.get('currency', 'USD') }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-md-end text-muted">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        <p class="small mt-2">TradingView integrert chart</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main TradingView Widget -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart me-2"></i>
                Avansert Chart - {{ symbol if symbol else 'Velg aksje' }}
            </h5>
        </div>
        <div class="card-body p-0">
            <div id="tradingview_main_widget" style="height: 600px;">
                <!-- TradingView Chart will load here -->
                <div class="text-center p-5" id="loading-indicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laster TradingView chart...</span>
                    </div>
                    <p class="text-muted mt-3">Laster TradingView chart...</p>
                    <small class="text-muted">Hvis chartet ikke laster, kan det skyldes ad blocker eller nettverksproblemer</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick symbol buttons -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="mb-3">Popul√¶re aksjer</h6>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('EQNR.OL')">EQNR</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('DNB.OL')">DNB</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('AAPL')">AAPL</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('TSLA')">TSLA</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('MSFT')">MSFT</button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSymbol('BTC-USD')">Bitcoin</button>
            </div>
        </div>
    </div>

    <!-- Technical Analysis Widget -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">Teknisk Analyse</h6>
                </div>
                <div class="card-body p-0">
                    <div id="tradingview_technical_analysis" style="height: 400px;">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Laster...</span>
                            </div>
                            <p class="text-muted mt-3">Laster teknisk analyse...</p>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Technical Analysis Widget -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">Teknisk Analyse Sammendrag</h6>
                </div>
                <div class="card-body p-0">
                    <div id="tradingview_technical_analysis" style="height: 300px;">
                        <div class="text-center p-4">
                            <i class="fas fa-chart-line text-primary mb-2" style="font-size: 2rem;"></i>
                            <h6>Teknisk Analyse</h6>
                            <p class="text-muted small">Avanserte indikatorer laster...</p>
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Laster...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Economic Calendar -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h6 class="mb-0">√òkonomisk Kalender</h6>
        </div>
        <div class="card-body p-0">
            <div id="tradingview_economic_calendar" style="height: 400px;">
                <div class="text-center p-4">
                    <i class="fas fa-calendar text-primary mb-2" style="font-size: 2rem;"></i>
                    <h6>√òkonomisk Kalender</h6>
                    <p class="text-muted small">Viktige √∏konomiske hendelser laster...</p>
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Laster...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentSymbol = '{{ symbol if symbol else "AAPL" }}';
let widgets = {};

// Format symbol for TradingView
// Enhanced symbol validation and formatting
function formatSymbolForTradingView(symbol) {
    if (!symbol || typeof symbol !== 'string') {
        console.warn('Invalid symbol provided:', symbol);
        return 'NASDAQ:AAPL'; // Default fallback
    }
    
    const cleanSymbol = symbol.trim().toUpperCase();
    
    // Validate symbol format
    if (!/^[A-Z0-9\.\-_]+$/i.test(cleanSymbol)) {
        console.warn('Symbol contains invalid characters:', cleanSymbol);
        return 'NASDAQ:AAPL'; // Default fallback
    }
    
    // Enhanced Oslo B√∏rs mapping with validation
    if (cleanSymbol.endsWith('.OL')) {
        const base = cleanSymbol.replace('.OL', '');
        if (base.length >= 2 && base.length <= 6) {
            console.log(`‚úÖ Oslo B√∏rs symbol validated: ${cleanSymbol} ‚Üí OSL:${base}`);
            return `OSL:${base}`;
        }
    }
    
    // Enhanced crypto mapping with validation
    if (cleanSymbol.includes('BTC') || cleanSymbol.includes('ETH') || cleanSymbol.endsWith('-USD')) {
        let base = cleanSymbol;
        if (cleanSymbol.endsWith('-USD')) {
            base = cleanSymbol.replace('-USD', '');
        }
        console.log(`ü™ô Crypto symbol validated: ${cleanSymbol} ‚Üí BINANCE:${base}USDT`);
        return `BINANCE:${base}USDT`;
    }
    
    // Enhanced US stock validation
    const knownNasdaq = ['AAPL', 'MSFT', 'GOOGL', 'GOOG', 'TSLA', 'NVDA', 'META', 'NFLX', 'AMZN', 'INTC', 'ADBE', 'CRM', 'PYPL'];
    const knownNyse = ['JPM', 'BAC', 'WMT', 'DIS', 'KO', 'XOM', 'JNJ', 'V', 'MA', 'PG', 'UNH'];
    
    if (knownNasdaq.includes(cleanSymbol)) {
        console.log(`üìà NASDAQ symbol validated: ${cleanSymbol} ‚Üí NASDAQ:${cleanSymbol}`);
        return `NASDAQ:${cleanSymbol}`;
    }
    
    if (knownNyse.includes(cleanSymbol)) {
        console.log(`üèõÔ∏è NYSE symbol validated: ${cleanSymbol} ‚Üí NYSE:${cleanSymbol}`);
        return `NYSE:${cleanSymbol}`;
    }
    
    // Default to NASDAQ for unknown symbols (most common)
    if (!cleanSymbol.includes(':') && cleanSymbol.length <= 5) {
        console.log(`‚ùì Unknown symbol, defaulting to NASDAQ: ${cleanSymbol} ‚Üí NASDAQ:${cleanSymbol}`);
        return `NASDAQ:${cleanSymbol}`;
    }
    
    console.log(`‚ö†Ô∏è Using symbol as-is: ${cleanSymbol}`);
    return cleanSymbol;
}

// Enhanced error handling functions
function showAdBlockerWarning() {
    const container = document.getElementById('tradingview_main_widget');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-warning text-center p-4">
                <i class="bi bi-shield-exclamation fs-1 text-warning mb-3"></i>
                <h4>TradingView Chart Blokkert</h4>
                <p class="mb-3">TradingView charts kan ikke lastes. Dette skyldes sannsynligvis:</p>
                <ul class="list-unstyled mb-3">
                    <li><i class="bi bi-check text-danger"></i> Ad blocker eller privacy extension</li>
                    <li><i class="bi bi-check text-danger"></i> Nettverksbegrensninger</li>
                    <li><i class="bi bi-check text-danger"></i> Firewall eller proxy-innstillinger</li>
                </ul>
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Pr√∏v igjen
                    </button>
                    <button class="btn btn-outline-primary" onclick="loadChartJsFallback('${currentSymbol}')">
                        <i class="bi bi-bar-chart"></i> Vis fallback chart
                    </button>
                    <a href="https://www.tradingview.com/symbols/${currentSymbol}" target="_blank" class="btn btn-outline-success">
                        <i class="bi bi-box-arrow-up-right"></i> √Öpne i TradingView
                    </a>
                </div>
                <small class="text-muted mt-3 d-block">
                    <strong>Tips:</strong> Deaktiver ad blocker for denne siden eller legg til unntak for tradingview.com
                </small>
            </div>
        `;
    }
}

function handleTradingViewError(error) {
    console.error('TradingView error details:', error);
    
    // Check for specific error types
    if (error.toString().includes('network') || error.toString().includes('fetch')) {
        showNetworkError();
    } else if (error.toString().includes('rate') || error.toString().includes('limit')) {
        showRateLimitError();
    } else {
        showGenericTradingViewError(error);
    }
}

function showRateLimitError() {
    const container = document.getElementById('tradingview_main_widget');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-info text-center p-4">
                <i class="bi bi-clock fs-1 text-info mb-3"></i>
                <h4>TradingView Rate Limit</h4>
                <p class="mb-3">For mange foresp√∏rsler til TradingView. Vennligst vent noen sekunder.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" onclick="setTimeout(() => location.reload(), 5000)">
                        <i class="bi bi-arrow-clockwise"></i> Auto-refresh om 5 sek
                    </button>
                    <button class="btn btn-outline-primary" onclick="loadChartJsFallback('${currentSymbol}')">
                        <i class="bi bi-bar-chart"></i> Vis fallback chart
                    </button>
                </div>
            </div>
        `;
    }
}

function showNetworkError() {
    const container = document.getElementById('tradingview_main_widget');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-danger text-center p-4">
                <i class="bi bi-wifi-off fs-1 text-danger mb-3"></i>
                <h4>Nettverksfeil</h4>
                <p class="mb-3">Kan ikke koble til TradingView. Sjekk internettforbindelsen.</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Pr√∏v igjen
                </button>
            </div>
        `;
    }
}

function showGenericTradingViewError(error) {
    const container = document.getElementById('tradingview_main_widget');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-warning text-center p-4">
                <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
                <h4>Chart feil</h4>
                <p class="mb-3">En feil oppstod under lasting av TradingView chart.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Pr√∏v igjen
                    </button>
                    <button class="btn btn-outline-primary" onclick="loadChartJsFallback('${currentSymbol}')">
                        <i class="bi bi-bar-chart"></i> Fallback chart
                    </button>
                </div>
                <small class="text-muted mt-2 d-block">Feil: ${error.toString()}</small>
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Enhanced TradingView loading with ad blocker and network detection
    let tradingViewLoadAttempts = 0;
    const maxLoadAttempts = 10;
    
    function waitForTradingView() {
        tradingViewLoadAttempts++;
        
        if (typeof TradingView !== 'undefined') {
            console.log('‚úÖ TradingView library loaded successfully');
            // Test if TradingView actually works (not blocked)
            testTradingViewAccess();
        } else if (tradingViewLoadAttempts >= maxLoadAttempts) {
            console.warn('‚ùå TradingView library failed to load - likely blocked by ad blocker or network issues');
            showAdBlockerWarning();
        } else {
            console.log(`‚è≥ Waiting for TradingView library... (attempt ${tradingViewLoadAttempts}/${maxLoadAttempts})`);
            setTimeout(waitForTradingView, 1000);
        }
    }
    
    function testTradingViewAccess() {
        try {
            // Test if we can create a widget (basic access test)
            if (TradingView && TradingView.widget) {
                console.log('‚úÖ TradingView widget constructor available');
                // Initialize charts with enhanced error handling
                setTimeout(() => {
                    try {
                        loadMainChart(currentSymbol);
                        loadTechnicalAnalysis(currentSymbol);
                    } catch (error) {
                        console.error('Error initializing charts:', error);
                        handleTradingViewError(error);
                    }
                }, 1500);
            } else {
                throw new Error('TradingView.widget not available');
            }
        } catch (error) {
            console.error('TradingView access test failed:', error);
            showAdBlockerWarning();
        }
    }
    
    waitForTradingView();
    
    // Search functionality
    document.getElementById('loadChart').addEventListener('click', function() {
        const symbol = document.getElementById('symbolSearch').value.trim().toUpperCase();
        if (symbol) {
            loadSymbol(symbol);
        }
    });
    
    // Enter key search
    document.getElementById('symbolSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const symbol = this.value.trim().toUpperCase();
            if (symbol) {
                loadSymbol(symbol);
            }
        }
    });
});

// Enhanced Chart.js fallback for when TradingView is blocked
function loadChartJsFallback(symbol) {
    const container = document.getElementById('tradingview_main_widget');
    if (!container) return;
    
    // Create canvas for Chart.js
    container.innerHTML = `
        <div class="bg-light border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart-fill text-primary"></i> 
                    Fallback Chart - ${symbol}
                </h5>
                <span class="badge bg-secondary">Chart.js</span>
            </div>
            <canvas id="fallbackChart" width="400" height="200"></canvas>
            <div class="mt-2 text-center">
                <small class="text-muted">
                    TradingView utilgjengelig - viser sample data med Chart.js
                </small>
            </div>
        </div>
    `;
    
    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => initFallbackChart(symbol);
        document.head.appendChild(script);
    } else {
        initFallbackChart(symbol);
    }
}

function initFallbackChart(symbol) {
    const canvas = document.getElementById('fallbackChart');
    if (!canvas) return;
    
    // Generate realistic sample data
    const data = generateSampleChartData(symbol);
    
    new Chart(canvas, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: `${symbol} Pris`,
                data: data.prices,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.2,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Pris (NOK)'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Dato'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Teknisk Analyse - ${symbol} (Fallback)`
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function generateSampleChartData(symbol) {
    const labels = [];
    const prices = [];
    
    // Base price varies by symbol type
    let basePrice = 100;
    if (symbol.endsWith('.OL')) basePrice = 150; // Norwegian stocks
    if (symbol.includes('BTC')) basePrice = 45000; // Bitcoin
    if (symbol.includes('ETH')) basePrice = 3000; // Ethereum
    
    let currentPrice = basePrice;
    
    // Generate 30 days of data
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('no-NO', { month: 'short', day: 'numeric' }));
        
        // Realistic price movement
        const volatility = 0.03; // 3% daily volatility
        const change = (Math.random() - 0.5) * 2 * volatility * currentPrice;
        currentPrice = Math.max(currentPrice + change, basePrice * 0.5); // Don't go below 50% of base
        prices.push(Math.round(currentPrice * 100) / 100);
    }
    
    return { labels, prices };
}

// Enhanced main chart loader with robust error handling
function loadMainChart(symbol) {
    const container = document.getElementById('tradingview_main_widget');
    if (!container) return;
    
    // Validate symbol before proceeding
    if (!symbol || typeof symbol !== 'string' || symbol.trim() === '') {
        console.warn('Invalid symbol provided to loadMainChart:', symbol);
        showGenericTradingViewError(new Error('Ugyldig symbol'));
        return;
    }
    
    // Clear container and show loading
    container.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-3">Laster TradingView chart for ${symbol}...</p>
            <small class="text-muted">Dette kan ta noen sekunder</small>
        </div>
    `;
    
    // Enhanced chart initialization with timeout and error handling
    function initChart() {
        if (typeof TradingView !== 'undefined' && TradingView.widget) {
            try {
                const formattedSymbol = formatSymbolForTradingView(symbol);
                console.log(`üéØ Loading TradingView chart: ${symbol} ‚Üí ${formattedSymbol}`);
                
                // Clear any existing widget
                if (widgets.mainChart) {
                    try {
                        widgets.mainChart.remove();
                    } catch (e) {
                        console.log('Previous widget cleanup:', e);
                    }
                }
                
                widgets.mainChart = new TradingView.widget({
                    "width": "100%",
                    "height": 600,
                    "symbol": formattedSymbol,
                    "interval": "D",
                    "timezone": "Europe/Oslo",
                    "theme": "light",
                    "style": "1",
                    "locale": "no",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview_main_widget",
                    "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                    "watchlist": [
                        "NASDAQ:AAPL", "NASDAQ:TSLA", "NASDAQ:MSFT", 
                        "OSL:EQNR", "OSL:DNB", "OSL:MOWI"
                    ],
                    "onChartReady": function() {
                        console.log('‚úÖ TradingView main chart loaded successfully for:', formattedSymbol);
                    },
                    "onerror": function(error) {
                        console.error('‚ùå TradingView widget error:', error);
                        handleTradingViewError(error);
                    }
                });
                
                // Set timeout to detect if chart fails to load
                setTimeout(() => {
                    const iframe = container.querySelector('iframe');
                    if (!iframe || iframe.style.display === 'none') {
                        console.warn('‚è∞ TradingView chart timeout - no iframe detected after 15 seconds');
                        showRateLimitError();
                    }
                }, 15000);
                
            } catch (error) {
                console.error('Error creating TradingView widget:', error);
                handleTradingViewError(error);
            }
        } else {
            console.error('TradingView widget constructor not available');
            showAdBlockerWarning();
        }
    }
    
    initChart();
                });
                
                console.log('‚úÖ TradingView main chart loaded for ' + formattedSymbol);
            } catch (error) {
                console.error('‚ùå Error loading main chart:', error);
                showFallbackChart(container, symbol);
            }
        } else {
            // TradingView not ready, try again
            setTimeout(initChart, 500);
        }
    }
    
    initChart();
}

// Technical analysis widget
function loadTechnicalAnalysis(symbol) {
    const container = document.getElementById('tradingview_technical_analysis');
    if (!container) return;
    
    function initTechAnalysis() {
        if (typeof TradingView !== 'undefined' && TradingView.TechnicalAnalysisWidget) {
            try {
                const formattedSymbol = formatSymbolForTradingView(symbol);
                
                widgets.techAnalysis = new TradingView.TechnicalAnalysisWidget({
                    "interval": "1D",
                    "width": "100%",
                    "isTransparent": false,
                    "height": "400",
                    "symbol": formattedSymbol,
                    "showIntervalTabs": true,
                    "locale": "no",
                    "colorTheme": "light",
                    "container_id": "tradingview_technical_analysis"
                });
                
                console.log('‚úÖ Technical analysis widget loaded');
            } catch (error) {
                console.error('‚ùå Error loading technical analysis:', error);
                container.innerHTML = '<div class="text-center p-4 text-muted">Teknisk analyse ikke tilgjengelig</div>';
            }
        } else {
            setTimeout(initTechAnalysis, 500);
        }
    }
    
    initTechAnalysis();
}

// Fallback chart display
function showFallbackChart(container, symbol) {
    container.innerHTML = `
        <div class="text-center p-5 border rounded bg-light">
            <i class="bi bi-bar-chart text-primary mb-3" style="font-size: 3rem;"></i>
            <h4>TradingView Chart</h4>
            <p class="text-muted">Symbol: <strong>${symbol}</strong></p>
            <div class="alert alert-info">
                Chart kunne ikke lastes. Pr√∏v √• oppdatere siden eller bes√∏k TradingView direkte.
            </div>
            <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Oppdater
                </button>
                <a href="https://www.tradingview.com/symbols/${symbol}" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> √Öpne i TradingView
                </a>
            </div>
        </div>`;
}

// Load symbol function
function loadSymbol(symbol) {
    currentSymbol = symbol;
    document.getElementById('symbolSearch').value = symbol;
    loadMainChart(symbol);
    loadTechnicalAnalysis(symbol);
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('symbol', symbol);
    window.history.pushState({}, '', url);
}
</script>
{% endblock %}
