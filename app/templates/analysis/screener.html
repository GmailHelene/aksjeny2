{% extends "base.html" %}

{% block title %}Avansert Aksje Screener | Aksjeradar{% endblock %}

{% block content %}
{% include 'analysis/_menu.html' %}

<div class="container py-4">
    <div class="row">
        <!-- Screener Loading Spinner -->
        <div id="screener-loading" class="text-center py-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laster...</span>
            </div>
            <div class="mt-2 text-primary">Laster screening...</div>
        </div>
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-funnel text-primary"></i> Avansert Aksje Screener
                    </h1>
                    <p class="text-muted">Finn aksjer basert på detaljerte kriterier med Finviz-teknologi</p>
                </div>
                <div>
                    <span class="badge bg-success fs-6">🚀 Powered by Finviz</span>
                    {% if current_user.is_authenticated %}
                    <span class="badge bg-warning text-dark fs-6">PRO</span>
                    {% else %}
                    <span class="badge bg-info fs-6">DEMO</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filter Panel -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Screening Kriterier</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('analysis.screener') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                        
                        <!-- Preset Screens -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">🎯 Ferdigdefinerte screener</label>
                            <select name="preset" class="form-select" onchange="selectPreset(this.value)">
                                <option value="">-- Velg preset --</option>
                                {% for preset_name, filters in preset_screens.items() %}
                                <option value="{{ preset_name }}">
                                    {% if preset_name == 'value_stocks' %}
                                        🎯 Verdiaksjer
                                    {% elif preset_name == 'growth_stocks' %}
                                        📈 Vekstaksjer
                                    {% elif preset_name == 'dividend_stocks' %}
                                        💰 Utbytteaksjer
                                    {% else %}
                                        {{ preset_name|title }}
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Velg en ferdig screening eller bygg din egen under</small>
                        </div>

                        <hr>

                        <!-- Custom Filters -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">🔧 Tilpassede filtere</label>
                            
                            {% for category, filters in available_filters.items() %}
                            <div class="mb-3">
                                <h6 class="text-primary">{{ category }}</h6>
                                <div class="row">
                                    {% for filter_key in filters %}
                                    <div class="col-12 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="filters" value="{{ filter_key }}" 
                                                   id="filter_{{ filter_key }}"
                                                   {% if filter_key in selected_filters %}checked{% endif %}>
                                            <label class="form-check-label small" for="filter_{{ filter_key }}">
                                                {{ filter_display_names[filter_key] }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Søk aksjer
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Nullstill
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Om Screener</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        Vår screener bruker Finviz-teknologi for å analysere tusenvis av aksjer basert på:
                    </small>
                    <ul class="mt-2 small">
                        <li>Fundamental data (P/E, P/B, ROE, etc.)</li>
                        <li>Teknisk analyse (RSI, momentum, etc.)</li>
                        <li>Markedsdata (volum, market cap, etc.)</li>
                        <li>Performance metrics</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-md-8">
            {% if show_results %}
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check text-success"></i> 
                        Screening Resultater ({{ results|length }} aksjer)
                    </h5>
                    {% if results %}
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                            <i class="bi bi-download"></i> Eksporter CSV
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="saveAsWatchlist()">
                            <i class="bi bi-heart"></i> Lagre som Watchlist
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if results %}
                    <div class="table-responsive">
                        <table id="screenerTable" class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ticker</th>
                                    <th>Selskap</th>
                                    <th>Sektor</th>
                                    <th>Pris</th>
                                    <th>Endring</th>
                                    <th>P/E</th>
                                    <th>P/B</th>
                                    <th>RSI</th>
                                    <th>Anbefaling</th>
                                    <th>Handling</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in results %}
                                <tr>
                                    <td>
                                        <strong>{{ stock.get('ticker', 'Ukjent') }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="fw-bold" title="{{ stock.get('company', 'Ukjent selskap') }}">
                                                {{ stock.get('company', 'Ukjent selskap')[:30] }}{% if (stock.get('company', '')|length) > 30 %}...{% endif %}
                                            </div>
                                            <small class="text-muted" title="{{ stock.get('industry', 'Ukjent bransje') }}">
                                                {{ stock.get('industry', 'Ukjent bransje')[:25] }}{% if (stock.get('industry', '')|length) > 25 %}...{% endif %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ stock.get('sector', 'Ukjent sektor') }}</span>
                                    </td>
                                    <td>
                                        {% set price_val = stock.get('price', 0)|float %}
                                        {% set ticker = stock.get('ticker', '') %}
                                        <strong>
                                        {% if '.OL' in ticker %}
                                            {{ "{:.2f}".format(price_val) }} NOK
                                        {% else %}
                                            ${{ "{:.2f}".format(price_val) }}
                                        {% endif %}
                                        </strong>
                                    </td>
                                    <td>
                                        {% set change_val = stock.get('change_percent', 0)|float %}
                                        <span class="{% if change_val > 0 %}text-success{% elif change_val < 0 %}text-danger{% else %}text-muted{% endif %}">
                                            {% if change_val > 0 %}+{% endif %}{{ "{:.2f}".format(change_val) }}%
                                            <i class="bi bi-{% if change_val > 0 %}arrow-up{% elif change_val < 0 %}arrow-down{% else %}dash{% endif %}"></i>
                                        </span>
                                    </td>
                                    <td>
                                        {% set pe_val = stock.get('pe_ratio', 0) %}
                                        {% if pe_val and pe_val != 0 %}
                                            {{ "{:.2f}".format(pe_val|float) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set pb_val = stock.get('pb_ratio', 0) %}
                                        {% if pb_val and pb_val != 0 %}
                                            {{ "{:.2f}".format(pb_val|float) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set rsi_val = stock.get('rsi', 50) %}
                                        {% if rsi_val and rsi_val != 0 %}
                                            {% set rsi_float = rsi_val|float %}
                                            <span class="{% if rsi_float < 30 %}text-success fw-bold{% elif rsi_float > 70 %}text-danger fw-bold{% else %}text-muted{% endif %}" 
                                                  title="{% if rsi_float < 30 %}Oversolgt{% elif rsi_float > 70 %}Overkjøpt{% else %}Nøytral{% endif %}">
                                                {{ "{:.1f}".format(rsi_float) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set rec_val = stock.get('recommendation', 'HOLD') %}
                                        <span class="badge 
                                            {% if rec_val == 'STRONG BUY' %}bg-success
                                            {% elif rec_val == 'BUY' %}bg-primary
                                            {% elif rec_val == 'HOLD' %}bg-warning text-dark
                                            {% elif rec_val == 'SELL' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ rec_val }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('stocks.details', symbol=stock.get('ticker', 'N/A')) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button class="btn btn-outline-success btn-sm" 
                                                    onclick="addToWatchlist('{{ stock.get('ticker', 'N/A') }}', event)"
                                                    title="Legg til i favoritter">
                                                <i class="bi bi-heart"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">Ingen aksjer fant som oppfyller kriteriene</h5>
                        <p class="text-muted">Prøv å justere filterne eller velg en annen preset</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Welcome Panel -->
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-funnel text-primary" style="font-size: 4rem;"></i>
                    <h3 class="mt-3">Velkommen til Avansert Screener</h3>
                    <p class="lead text-muted">
                        Finn de beste aksjene basert på dine kriterier ved hjelp av Finviz-teknologi
                    </p>
                    
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-lightning-charge text-primary fs-1"></i>
                                    <h5>Rask Screening</h5>
                                    <p class="small">Analyser tusenvis av aksjer på sekunder</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-graph-up text-success fs-1"></i>
                                    <h5>Detaljert Analyse</h5>
                                    <p class="small">Fundamental og teknisk analyse kombinert</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-star text-warning fs-1"></i>
                                    <h5>Smart Anbefalinger</h5>
                                    <p class="small">AI-drevne kjøp/selg anbefalinger</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-muted">Velg et ferdigdefinert preset eller bygg dine egne filtere til venstre for å komme i gang</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Make sure Bootstrap and its dependencies are loaded -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<!-- Load our custom screener JS -->
<script src="{{ url_for('static', filename='js/screener.js') }}"></script>

<script>
// Ensure Bootstrap is available
if (typeof bootstrap === 'undefined') {
    console.error('Bootstrap JS is not loaded. Some features may not work.');
}

// Initialize tooltips and popovers
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initialize all popovers
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function(popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
});

// Filter display names mapping
const filterDisplayNames = {
    'cap_mega': 'Mega Cap (>$200B)',
    'cap_large': 'Large Cap (>$10B)', 
    'cap_mid': 'Mid Cap ($2B-$10B)',
    'cap_small': 'Small Cap (<$2B)',
    'nasdaq': 'NASDAQ',
    'nyse': 'NYSE',
    'sp500': 'S&P 500',
    'sp400': 'S&P 400',
    'sp600': 'S&P 600',
    'nasdaq100': 'NASDAQ 100',
    'russell2000': 'Russell 2000',
    'tech': 'Teknologi',
    'healthcare': 'Helsevesen',
    'finance': 'Finans',
    'energy': 'Energi',
    'consumer': 'Forbruksvarer',
    'industrial': 'Industri',
    'utilities': 'Utilities',
    'realestate': 'Eiendom',
    'materials': 'Materialer',
    'pe_low': 'Lav P/E (<15)',
    'pe_profitable': 'Profitabel (P/E>0)',
    'pe_high': 'Høy P/E (>50)',
    'peg_low': 'Lav PEG (<1)',
    'pb_low': 'Lav P/B (<1)',
    'ps_low': 'Lav P/S (<1)',
    'perf_week_up': 'Uke +',
    'perf_month_up': 'Måned +',
    'perf_ytd_up': 'YTD +',
    'perf_year_up': 'År +',
    'rsi_oversold': 'RSI Oversolgt (<30)',
    'rsi_overbought': 'RSI Overkjøpt (>70)',
    'price_near_high': 'Nær 52W høy',
    'price_near_low': 'Nær 52W lav',
    'volume_high': 'Høyt volum (>2M)',
    'dividend_yield': 'Utbytte >0%',
    'dividend_high': 'Høyt utbytte (>5%)',
    'roe_high': 'ROE >0%',
    'roa_high': 'ROA >0%',
    'debt_low': 'Lav gjeld (<0.5)',
    'current_ratio_high': 'Høy likviditet (>1.5)',
    'sales_growth': 'Salgsvekst 5Y+',
    'eps_growth': 'EPS vekst 5Y+',
    'earnings_growth': 'Inntjeningsvekst+'
};

function getFilterDisplayName(filterKey) {
    return filterDisplayNames[filterKey] || filterKey;
}

function selectPreset(preset) {
    if (!preset) return;
    
    try {
        // Clear all checkboxes first
        document.querySelectorAll('input[name="filters"]').forEach(cb => cb.checked = false);
        
        // Get preset screens data from the server  
        const presetScreens = {{ preset_screens|tojson|safe }};
        
        if (!presetScreens) {
            console.error('Preset screens data not available');
            showToast('Kunne ikke laste preset-data', 'error');
            return;
        }
        
        // Select the correct filters for this preset
        if (presetScreens[preset]) {
            const filters = presetScreens[preset];
            let appliedFilters = 0;
            
            filters.forEach(filterKey => {
                const checkbox = document.querySelector(`input[name="filters"][value="${filterKey}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    appliedFilters++;
                } else {
                    console.warn(`Filter not found: ${filterKey}`);
                }
            });
            
            if (appliedFilters === 0) {
                showToast('Ingen filtere funnet for dette presetet', 'warning');
                return;
            }
        } else {
            showToast('Ugyldig preset valgt', 'error');
            return;
        }
        
        // Show loading indicator
        const btn = document.querySelector('button[type="submit"]');
        if (!btn) {
            console.error('Submit button not found');
            return;
        }
        
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Laster preset...';
        btn.disabled = true;
        
        // Auto-submit form after brief delay
        setTimeout(() => {
            const form = document.querySelector('form');
            if (form) {
                form.submit();
            } else {
                console.error('Form not found');
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('Teknisk feil ved lasting av preset', 'error');
            }
        }, 500);
    } catch (error) {
        console.error('Error in selectPreset:', error);
        showToast('Teknisk feil ved valg av preset', 'error');
    }
}

function exportResults() {
    // Create CSV content
    const table = document.querySelector('table tbody');
    if (!table) return;
    
    let csv = 'Ticker,Selskap,Sektor,Pris,Endring,P/E,P/B,RSI,Anbefaling\n';
    
    table.querySelectorAll('tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 9) {
            const rowData = [
                cells[0].textContent.trim(),
                cells[1].querySelector('.fw-bold').textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim(),
                cells[6].textContent.trim(),
                cells[7].textContent.trim(),
                cells[8].textContent.trim()
            ];
            csv += rowData.map(cell => '"' + cell + '"').join(',') + '\n';
        }
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'screener_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function saveAsWatchlist() {
    // Collect tickers
    const tickers = [];
    document.querySelectorAll('table tbody tr').forEach(row => {
        const ticker = row.querySelector('td:first-child strong')?.textContent.trim();
        if (ticker) tickers.push(ticker);
    });
    
    if (tickers.length === 0) {
        showToast('Ingen aksjer å legge til watchlist', 'error');
        return;
    }
    
    // Create watchlist with selected tickers
    fetch('/watchlist/api/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            name: 'Screener Watchlist',
            description: `Screener resultater fra ${new Date().toLocaleString()}`,
            symbols: tickers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Opprettet watchlist med ${tickers.length} aksjer`, 'success');
            // Redirect to the new watchlist
            if (data.watchlist_id) {
                window.location.href = `/watchlist/${data.watchlist_id}`;
            }
        } else {
            showToast(data.message || 'Kunne ikke opprette watchlist', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating watchlist:', error);
        showToast('Teknisk feil ved opprettelse av watchlist', 'error');
    });
}

function selectPreset(presetName) {
    // Clear all checkboxes first
    document.querySelectorAll('input[name="filters"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // If preset is selected, auto-submit the form
    if (presetName) {
        // Trigger form submission
        document.querySelector('form').submit();
    }
}

function clearFilters() {
    try {
        // Clear preset selection
        const presetSelect = document.querySelector('select[name="preset"]');
        if (presetSelect) {
            presetSelect.value = '';
        }
        
        // Clear all checkboxes
        document.querySelectorAll('input[name="filters"]').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Clear any applied styling classes
        document.querySelectorAll('.filter-applied').forEach(el => {
            el.classList.remove('filter-applied');
        });
        
        // Reset any custom inputs
        document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
            if (input.name.startsWith('custom_')) {
                input.value = '';
            }
        });
        
        // Show feedback
        showToast('Alle filtere nullstilt', 'info');
        
        // Optional: Auto-submit to refresh results
        const shouldAutoSubmit = document.querySelector('input[name="auto_submit"]')?.checked;
        if (shouldAutoSubmit) {
            document.querySelector('form')?.submit();
        }
    } catch (error) {
        console.error('Error clearing filters:', error);
        showToast('Feil ved nullstilling av filtere', 'error');
    }
}

async function addToWatchlist(ticker, event) {
    try {
        // Prevent any default button action and event bubbling
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        // Input validation
        if (!ticker || typeof ticker !== 'string') {
            console.error('Invalid ticker:', ticker);
            showToast('Ugyldig ticker-symbol', 'error');
            return;
        }
        
        // Get the button element with fallbacks
        const btn = event?.target?.closest('button') || 
                   document.querySelector(`button[onclick*="${ticker}"]`) ||
                   document.querySelector(`button[data-ticker="${ticker}"]`);
                   
        if (!btn) {
            console.error('Button not found for ticker:', ticker);
            showToast('Teknisk feil: Knapp ikke funnet', 'error');
            return;
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if (!csrfToken) {
            console.error('CSRF token not found');
            showToast('Sikkerhetsfeil: Mangler CSRF token', 'error');
            return;
        }
        
        // Save original button state
        const originalContent = btn.innerHTML;
        const originalDisabled = btn.disabled;
        
        // Update button to loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        
        try {
            // Make API call
            const response = await fetch('/stocks/api/favorites/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ 
                    symbol: ticker,
                    source: 'screener'
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Show success UI
                btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
                btn.title = 'Lagt til i favoritter';
                btn.setAttribute('data-favorited', 'true');
                showToast(`${ticker} lagt til i favoritter`, 'success');
                
                // Update any matching buttons for the same ticker
                document.querySelectorAll(`button[data-ticker="${ticker}"]`).forEach(otherBtn => {
                    if (otherBtn !== btn) {
                        otherBtn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                        otherBtn.classList.remove('btn-outline-success');
                        otherBtn.classList.add('btn-success');
                        otherBtn.title = 'Lagt til i favoritter';
                        otherBtn.setAttribute('data-favorited', 'true');
                    }
                });
            } else {
                throw new Error(data.message || 'Unknown error');
            }
        } catch (error) {
            console.error('Error adding to watchlist:', error);
            
            // Restore button state
            btn.innerHTML = originalContent;
            btn.disabled = originalDisabled;
            
            // Show error with specific message if available
            const errorMessage = error.message && error.message !== 'Unknown error'
                ? error.message
                : 'Kunne ikke legge til i favoritter';
            showToast(errorMessage, 'error');
        }
    } catch (error) {
        console.error('Critical error in addToWatchlist:', error);
        showToast('Kritisk feil ved tillegg til favoritter', 'error');
    }
}

// Enhanced toast notification system
if (typeof showToast !== 'function') {
    const toastQueue = [];
    let isShowingToast = false;
    
    function showToast(message, type = 'info', duration = 3000) {
        if (!message) {
            console.warn('Toast message is required');
            return;
        }
        
        // Validate type
        const validTypes = ['info', 'success', 'warning', 'error', 'danger'];
        if (!validTypes.includes(type)) {
            console.warn(`Invalid toast type: ${type}. Defaulting to 'info'`);
            type = 'info';
        }
        
        // Map 'error' to bootstrap's 'danger' class
        const bsClass = type === 'error' ? 'danger' : type;
        
        // Create toast container if needed
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '1050';
            document.body.appendChild(container);
        }
        
        // Queue management function
        function showNextToast() {
            if (toastQueue.length === 0) {
                isShowingToast = false;
                return;
            }
            
            isShowingToast = true;
            const { toastEl, duration } = toastQueue.shift();
            
            try {
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap is not loaded');
                    toastEl.remove();
                    showNextToast();
                    return;
                }
                
                container.appendChild(toastEl);
                
                const toast = new bootstrap.Toast(toastEl, {
                    animation: true,
                    autohide: true,
                    delay: duration
                });
                
                toastEl.addEventListener('hidden.bs.toast', () => {
                    toastEl.remove();
                    showNextToast();
                });
                
                toast.show();
            } catch (error) {
                console.error('Error showing toast:', error);
                toastEl.remove();
                showNextToast();
            }
        }
        
        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${bsClass} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        // Add icons based on type
        const icon = type === 'success' ? 'bi-check-circle' :
                    type === 'error' || type === 'danger' ? 'bi-exclamation-triangle' :
                    type === 'warning' ? 'bi-exclamation-circle' :
                    'bi-info-circle';
                    
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${icon} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Queue the toast
        toastQueue.push({ toastEl, duration });
        
        // Show toast if none is currently showing
        if (!isShowingToast) {
            showNextToast();
        }
    }
    
    // Expose queue clear function
    window.clearToasts = function() {
        const container = document.querySelector('.toast-container');
        if (container) {
            container.innerHTML = '';
        }
        toastQueue.length = 0;
        isShowingToast = false;
    };
}
</script>
{% endblock %}
