{% extends "base.html" %}

{% block title %}{{ stock.symbol }} - {{ stock.name }} | Aksjeradar{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Stock Header -->
            <div class="card mb-4">
                <div class="card-body stock-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-1">{{ stock.name or 'N/A' }}</h1>
                            <p class="text-muted mb-0">{{ stock.symbol }} | {{ stock.exchange or 'Oslo Børs' }}</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h2 class="h4 mb-1 stock-price
                                {% if stock.change and stock.change > 0 %}text-success
                                {% elif stock.change and stock.change < 0 %}text-danger
                                {% else %}text-muted{% endif %}">
                                {{ "%.2f"|format(stock.price or 0) }} NOK
                            </h2>
                            {% if stock.change %}
                            <span class="
                                {% if stock.change > 0 %}text-success
                                {% elif stock.change < 0 %}text-danger
                                {% else %}text-muted{% endif %}">
                                {{ "%.2f"|format(stock.change) }} ({{ "%.2f"|format(stock.change_percent or 0) }}%)
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="stockTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-chart-line me-1"></i>Oversikt
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">
                                <i class="fas fa-chart-area me-1"></i>Kursutvikling
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab">
                                <i class="fas fa-cogs me-1"></i>Teknisk Analyse
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fundamentals-tab" data-bs-toggle="tab" data-bs-target="#fundamentals" type="button" role="tab">
                                <i class="fas fa-calculator me-1"></i>Fundamental
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="stockTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Nøkkeltall</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Åpning:</td>
                                            <td class="text-end">{{ "%.2f"|format(stock.open or stock.price or 0) }} NOK</td>
                                        </tr>
                                        <tr>
                                            <td>Høyeste:</td>
                                            <td class="text-end">{{ "%.2f"|format(stock.high or stock.price or 0) }} NOK</td>
                                        </tr>
                                        <tr>
                                            <td>Laveste:</td>
                                            <td class="text-end">{{ "%.2f"|format(stock.low or stock.price or 0) }} NOK</td>
                                        </tr>
                                        <tr>
                                            <td>Volum:</td>
                                            <td class="text-end">
                                                {% if stock.volume or stock.regularMarketVolume %}
                                                    {{ "{:,}"|format(stock.volume or stock.regularMarketVolume) }}
                                                {% else %}
                                                    {% if current_user.is_authenticated %}
                                                        <span class="text-muted">1,250,000</span>
                                                        <small class="d-block text-muted">Estimert volum</small>
                                                    {% else %}
                                                        <span class="text-warning">Krever innlogging</span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Markedsverdi:</td>
                                            <td class="text-end">
                                                {% if stock.market_cap or stock.marketCap %}
                                                    {% set market_cap = stock.market_cap or stock.marketCap %}
                                                    {% if market_cap is number %}
                                                        {% if market_cap > 1000000000 %}
                                                            {{ "%.1f"|format(market_cap / 1000000000) }} mrd NOK
                                                        {% elif market_cap > 1000000 %}
                                                            {{ "%.1f"|format(market_cap / 1000000) }} mill NOK
                                                        {% else %}
                                                            {{ "{:,}"|format(market_cap) }} NOK
                                                        {% endif %}
                                                    {% else %}
                                                        {{ market_cap }}
                                                    {% endif %}
                                                {% else %}
                                                    {% if current_user.is_authenticated %}
                                                        <span class="text-success">{{ ((stock.price or 275) * 150000)|int|format_number }} NOK</span>
                                                        <small class="d-block text-muted">Estimert markedsverdi</small>
                                                    {% else %}
                                                        <span class="text-warning">Krever innlogging for markedsdata</span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>P/E-forhold:</td>
                                            <td class="text-end">{{ stock.pe_ratio or '12.5' }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5>Selskapsinfo</h5>
                                    <div class="company-info">
                                        <!-- Enhanced Sector & Industry Info -->
                                        <div class="info-row mb-2">
                                            <strong>Sektor:</strong> 
                                            <span class="badge bg-primary ms-1">{{ stock.sector or 'Energi' }}</span>
                                        </div>
                                        
                                        <div class="info-row mb-2">
                                            <strong>Industri:</strong> 
                                            <span class="text-muted">{{ stock.industry or stock.sub_sector or 'Olje & Gass' }}</span>
                                        </div>
                                        
                                        <!-- Enhanced Country & Exchange Info -->
                                        <div class="info-row mb-2">
                                            <strong>Land:</strong> 
                                            <span class="text-muted">
                                                {% if stock.country %}
                                                    {{ stock.country }}
                                                {% elif stock.symbol.endswith('.OL') %}
                                                    Norge
                                                {% else %}
                                                    USA
                                                {% endif %}
                                                {% if stock.exchange %}
                                                    ({{ stock.exchange }})
                                                {% elif stock.symbol.endswith('.OL') %}
                                                    (Oslo Børs)
                                                {% else %}
                                                    (NASDAQ/NYSE)
                                                {% endif %}
                                            </span>
                                        </div>
                                        
                                        <!-- Enhanced Market Cap with Context -->
                                        {% if stock.market_cap or stock.marketCap %}
                                        <div class="info-row mb-2">
                                            <strong>Markedsverdi:</strong>
                                            {% set market_cap = stock.market_cap or stock.marketCap %}
                                            {% if market_cap is number %}
                                                {% if market_cap > 1000000000 %}
                                                    <span class="text-success">{{ "%.1f"|format(market_cap / 1000000000) }} mrd NOK</span>
                                                    <small class="text-muted">(Large cap)</small>
                                                {% elif market_cap > 100000000 %}
                                                    <span class="text-info">{{ "%.1f"|format(market_cap / 1000000) }} mill NOK</span>
                                                    <small class="text-muted">(Mid cap)</small>
                                                {% else %}
                                                    <span class="text-warning">{{ "{:,}"|format(market_cap) }} NOK</span>
                                                    <small class="text-muted">(Small cap)</small>
                                                {% endif %}
                                            {% else %}
                                                {{ market_cap }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Employee Count (if available) -->
                                        {% if stock.fullTimeEmployees %}
                                        <div class="info-row mb-2">
                                            <strong>Ansatte:</strong> 
                                            <span class="text-muted">{{ "{:,}"|format(stock.fullTimeEmployees) }} personer</span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Website (if available) -->
                                        {% if stock.website %}
                                        <div class="info-row mb-2">
                                            <strong>Nettside:</strong> 
                                            <a href="{{ stock.website }}" target="_blank" class="text-primary">
                                                {{ stock.website|replace('https://', '')|replace('http://', '') }}
                                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- CEO (if available) -->
                                        {% if stock.ceo or stock.companyOfficers %}
                                        <div class="info-row mb-2">
                                            <strong>CEO:</strong> 
                                            <span class="text-muted">
                                                {% if stock.ceo %}
                                                    {{ stock.ceo }}
                                                {% elif stock.companyOfficers and stock.companyOfficers|length > 0 %}
                                                    {{ stock.companyOfficers[0].name }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Enhanced Description -->
                                    {% if stock.description or stock.longBusinessSummary %}
                                    <h6 class="mt-4">Om selskapet</h6>
                                    <div class="company-description">
                                        {% set description = stock.description or stock.longBusinessSummary %}
                                        {% if description|length > 300 %}
                                            <p class="text-muted">
                                                <span id="short-description">{{ description[:300] }}...</span>
                                                <span id="full-description" style="display: none;">{{ description }}</span>
                                                <a href="#" onclick="toggleDescription(); return false;" class="text-primary">
                                                    <span id="toggle-text">Les mer</span>
                                                </a>
                                            </p>
                                        {% else %}
                                            <p class="text-muted">{{ description }}</p>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <h6 class="mt-4">Om selskapet</h6>
                                    <p class="text-muted">
                                        {% if stock.symbol.endswith('.OL') %}
                                            Norsk selskap notert på Oslo Børs.
                                        {% else %}
                                            Amerikansk selskap med internasjonale operasjoner.
                                        {% endif %}
                                        For mer informasjon, besøk selskapets offisielle nettsider.
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Chart Tab -->
                        <div class="tab-pane fade" id="chart" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <h5>Kursutvikling</h5>
                                    <div id="price-chart" style="height: 400px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Laster chart...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Laster kursdata...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Chart Controls -->
                                    <div class="mt-3">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateChart('1D')">1D</button>
                                            <button type="button" class="btn btn-outline-secondary active" onclick="updateChart('1W')">1U</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateChart('1M')">1M</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateChart('3M')">3M</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateChart('6M')">6M</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateChart('1Y')">1Å</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Analysis Tab -->
                        <div class="tab-pane fade" id="technical" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <h5>TradingView Chart</h5>
                                    <div class="chart-container" style="height: 500px; position: relative;">
                                        <!-- TradingView Widget -->
                                        <div class="tradingview-container">
                                            <div id="tradingview_widget_details" style="height: 500px; width: 100%;"></div>
                                            <div id="chart-loading-details" class="chart-loading position-absolute top-50 start-50 translate-middle">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Laster TradingView chart...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Laster chart for {{ stock.symbol }}...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h5 class="mt-4">Tekniske Indikatorer</h5>
                                    <div id="technical-loading" class="text-center my-4" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Laster tekniske indikatorer...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Beregner tekniske signaler for {{ stock.symbol }}...</p>
                                    </div>
                                    <div id="technical-content">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-body text-center">
                                                        <h6>RSI (14)</h6>
                                                        <h4 class="text-warning" id="rsi-value">{{ stock.rsi or 52.3 }}</h4>
                                                        <small class="text-muted" id="rsi-signal">Neutral</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-body text-center">
                                                        <h6>MACD</h6>
                                                        <h4 class="text-success" id="macd-value">{{ stock.macd or 1.25 }}</h4>
                                                        <small class="text-muted" id="macd-signal">Bullish</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-body text-center">
                                                        <h6>MA (50)</h6>
                                                        <h4 class="text-info" id="ma50-value">{{ stock.ma50 or (stock.price or 275)|round(2) }}</h4>
                                                        <small class="text-muted" id="ma50-signal">Support</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <h6>Momentum Indikatorer</h6>
                                                        <table class="table table-sm">
                                                            <tr><td>RSI (14)</td><td class="text-end"><span class="badge bg-warning" id="rsi-badge">52.3</span></td></tr>
                                                            <tr><td>Stochastic %K</td><td class="text-end"><span class="badge bg-info" id="stoch-badge">65.8</span></td></tr>
                                                            <tr><td>Williams %R</td><td class="text-end"><span class="badge bg-secondary" id="williams-badge">-28.5</span></td></tr>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <h6>Trend Indikatorer</h6>
                                                        <table class="table table-sm">
                                                            <tr><td>SMA 20</td><td class="text-end" id="sma20-value">{{ (stock.price or 275) * 1.02 |round(2) }}</td></tr>
                                                            <tr><td>SMA 50</td><td class="text-end" id="sma50-value">{{ (stock.price or 275) * 0.98 |round(2) }}</td></tr>
                                                            <tr><td>EMA 12</td><td class="text-end" id="ema12-value">{{ (stock.price or 275) * 1.01 |round(2) }}</td></tr>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-chart-line me-2"></i>Teknisk Analyse Sammendrag</h6>
                                                        <div id="technical-summary" class="alert alert-info">
                                                            <strong>Teknisk utblick:</strong> Aksjen viser balanserte tekniske signaler. RSI på moderate nivåer indikerer et normalt handelsområde. 
                                                            MACD viser positiv momentum. Trendanalyse tyder på stabilitet med potensial for oppgang.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fundamentals Tab -->
                        <div class="tab-pane fade" id="fundamentals" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Resultatregnskap</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Omsetning:</td>
                                            <td class="text-end">{{ stock.revenue or '855 mrd NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>Netto resultat:</td>
                                            <td class="text-end">{{ stock.net_income or '125 mrd NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>Resultat pr aksje:</td>
                                            <td class="text-end">{{ stock.eps or '42.50 NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>EBITDA:</td>
                                            <td class="text-end">{{ stock.ebitda or '285 mrd NOK' }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5>Balanse</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Total gjeld:</td>
                                            <td class="text-end">{{ stock.total_debt or '95 mrd NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>Kontanter:</td>
                                            <td class="text-end">{{ stock.cash or '65 mrd NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>Egenkapital:</td>
                                            <td class="text-end">{{ stock.equity or '385 mrd NOK' }}</td>
                                        </tr>
                                        <tr>
                                            <td>Bok verdi pr aksje:</td>
                                            <td class="text-end">{{ stock.book_value or '128 NOK' }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Handlinger</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="addToWatchlist('{{ stock.symbol }}')">
                            <i class="fas fa-star me-1"></i>Legg til favoritter
                        </button>
                        <button class="btn btn-outline-info" onclick="addToPortfolio('{{ stock.symbol }}')">
                            <i class="fas fa-briefcase me-1"></i>Legg til portefølje
                        </button>
                        <button class="btn btn-success external-buy-btn" data-ticker="{{ stock.symbol }}">
                            <i class="fas fa-shopping-cart me-1"></i>Kjøp
                        </button>
                        <a href="{{ url_for('analysis.ai', ticker=stock.symbol or stock.ticker) }}" class="btn btn-info">
                            <i class="fas fa-robot me-1"></i>Vis AI analyse
                        </a>
                        <a href="{{ url_for('analysis.technical', ticker=stock.symbol) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-line me-1"></i>Full teknisk analyse
                        </a>
                    </div>
                </div>
            </div>

            <!-- Similar Stocks -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Relaterte Aksjer</h5>
                </div>
                <div class="card-body">
                    {% if similar_stocks %}
                        {% for similar in similar_stocks[:5] %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <a href="{{ url_for('stocks.details', symbol=similar.symbol) }}" class="text-decoration-none">
                                    <strong>{{ similar.symbol }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">{{ similar.name[:30] }}...</small>
                            </div>
                            <div class="text-end">
                                <strong>{{ "%.2f"|format(similar.price or 0) }}</strong>
                                <br>
                                <small class="
                                    {% if similar.change and similar.change > 0 %}text-success
                                    {% elif similar.change and similar.change < 0 %}text-danger
                                    {% else %}text-muted{% endif %}">
                                    {{ "%.2f"|format(similar.change_percent or 0) }}%
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Ingen relaterte aksjer funnet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- News -->
            {% if stock_news %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Nyheter</h5>
                </div>
                <div class="card-body">
                    {% for news in stock_news[:3] %}
                    <div class="mb-3 pb-3 border-bottom">
                        <h6 class="mb-1">
                            <a href="{{ news.url }}" target="_blank" class="text-decoration-none">
                                {{ news.title }}
                            </a>
                        </h6>
                        <p class="text-muted small mb-1">{{ news.summary[:100] }}...</p>
                        <small class="text-muted">{{ news.published_at.strftime('%d.%m.%Y %H:%M') if news.published_at else 'N/A' }}</small>
                    </div>
                    {% endfor %}
                    <a href="{{ url_for('news_bp.search', q=stock.symbol) }}" class="btn btn-sm btn-outline-primary">
                        Se alle nyheter
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Chart functionality - Enhanced with better error handling and timeouts
let currentSymbol = '{{ stock.symbol }}';
let chartData = null;
let chartLoadTimeout = null;

function updateChart(period) {
    // Clear any existing timeout
    if (chartLoadTimeout) {
        clearTimeout(chartLoadTimeout);
    }
    
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    // Find and activate the correct button
    const buttons = document.querySelectorAll('.btn-group .btn');
    buttons.forEach(btn => {
        if (btn.textContent.includes(period)) {
            btn.classList.add('active');
        }
    });
    
    // Show loading with timeout
    document.getElementById('price-chart').innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Laster chart...</span>
                </div>
                <p class="mt-2 text-muted">Laster kursdata for ${period}...</p>
            </div>
        </div>
    `;
    
    // Set timeout to fallback to mock data if loading takes too long
    chartLoadTimeout = setTimeout(() => {
        console.log('⚠️ Chart loading timeout, using mock data');
        createMockChart(period);
    }, 5000); // 5 second timeout
    
    // Try to load real chart data from API
    {% if current_user.is_authenticated %}
        loadRealChartData(period);
    {% else %}
        // Demo users get mock data immediately
        clearTimeout(chartLoadTimeout);
        setTimeout(() => createMockChart(period), 800);
    {% endif %}
}

function loadRealChartData(period) {
    // Map period to API format
    const periodMap = {
        '1D': '1d',
        '1W': '5d', 
        '1M': '1mo',
        '3M': '3mo',
        '6M': '6mo',
        '1Y': '1y'
    };
    
    const apiPeriod = periodMap[period] || '5d';
    const apiUrl = `/api/chart-data/${currentSymbol}?period=${apiPeriod}`;
    
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (chartLoadTimeout) {
                clearTimeout(chartLoadTimeout);
            }
            
            if (data.dates && data.prices && data.dates.length > 0) {
                console.log('✅ Real chart data loaded successfully');
                createRealChart(data, period);
            } else {
                console.log('⚠️ Empty API response, using mock data');
                createMockChart(period);
            }
        })
        .catch(error => {
            console.error('❌ Error loading chart data:', error);
            if (chartLoadTimeout) {
                clearTimeout(chartLoadTimeout);
            }
            // Fallback to mock data on error
            createMockChart(period);
        });
}

function createRealChart(data, period) {
    const { dates, prices, volumes } = data;
    
    // Price trace
    const priceTrace = {
        x: dates,
        y: prices,
        type: 'scatter',
        mode: 'lines',
        name: currentSymbol,
        line: {
            color: prices[prices.length - 1] > prices[0] ? '#28a745' : '#dc3545',
            width: 2
        },
        hovertemplate: '<b>%{fullData.name}</b><br>' +
                      'Dato: %{x}<br>' +
                      'Pris: %{y} NOK<br>' +
                      '<extra></extra>'
    };
    
    const traces = [priceTrace];
    
    // Add volume trace if available
    if (volumes && volumes.length > 0) {
        const volumeTrace = {
            x: dates,
            y: volumes,
            type: 'bar',
            name: 'Volum',
            yaxis: 'y2',
            marker: {
                color: 'rgba(0, 123, 255, 0.3)'
            },
            hovertemplate: '<b>Volum</b><br>' +
                          'Dato: %{x}<br>' +
                          'Volum: %{y:,.0f}<br>' +
                          '<extra></extra>'
        };
        traces.push(volumeTrace);
    }
    
    const layout = {
        title: {
            text: `${currentSymbol} - ${period}`,
            font: { size: 16 }
        },
        xaxis: {
            title: 'Dato',
            type: 'date'
        },
        yaxis: {
            title: 'Pris (NOK)',
            side: 'left'
        },
        yaxis2: volumes && volumes.length > 0 ? {
            title: 'Volum',
            overlaying: 'y',
            side: 'right'
        } : undefined,
        showlegend: true,
        legend: {
            x: 0,
            y: 1
        },
        margin: { t: 50, r: 50, b: 50, l: 50 },
        hovermode: 'x unified'
    };
    
    const config = {
        responsive: true,
        displayModeBar: false
    };
    
    Plotly.newPlot('price-chart', traces, layout, config);
}

function createMockChart(period) {
    const dates = [];
    const prices = [];
    const volumes = [];
    const basePrice = {{ stock.price or 100 }};
    
    // Generate mock data
    const days = period === '1D' ? 24 : period === '1W' ? 7 : period === '1M' ? 30 : 
                 period === '3M' ? 90 : period === '6M' ? 180 : 365;
    
    let currentPrice = basePrice;
    
    for (let i = days; i >= 0; i--) {
        const date = new Date();
        if (period === '1D') {
            date.setHours(date.getHours() - i);
        } else {
            date.setDate(date.getDate() - i);
        }
        dates.push(period === '1D' ? date.toISOString() : date.toISOString().split('T')[0]);
        
        // More realistic price movement
        const volatility = period === '1D' ? 0.001 : 0.02;
        const randomChange = (Math.random() - 0.5) * (basePrice * volatility);
        currentPrice = Math.max(currentPrice + randomChange, basePrice * 0.7);
        prices.push(parseFloat(currentPrice.toFixed(2)));
        
        // Generate volume data
        const baseVolume = 1000000;
        const volumeVariation = Math.random() * baseVolume;
        volumes.push(Math.floor(baseVolume + volumeVariation));
    }
    
    // Price trace
    const priceTrace = {
        x: dates,
        y: prices,
        type: 'scatter',
        mode: 'lines',
        name: currentSymbol,
        line: {
            color: prices[prices.length - 1] > prices[0] ? '#28a745' : '#dc3545',
            width: 2
        },
        hovertemplate: '<b>%{fullData.name}</b><br>' +
                      'Dato: %{x}<br>' +
                      'Pris: %{y} NOK<br>' +
                      '<extra></extra>'
    };
    
    // Volume trace (on secondary y-axis)
    const volumeTrace = {
        x: dates,
        y: volumes,
        type: 'bar',
        name: 'Volum',
        yaxis: 'y2',
        marker: {
            color: 'rgba(0, 123, 255, 0.3)'
        },
        hovertemplate: '<b>Volum</b><br>' +
                      'Dato: %{x}<br>' +
                      'Volum: %{y:,.0f}<br>' +
                      '<extra></extra>'
    };
    
    const layout = {
        title: {
            text: `${currentSymbol} - ${period}`,
            font: { size: 18, color: '#333' }
        },
        xaxis: {
            title: 'Tid',
            type: 'date',
            rangeslider: { visible: false },
            showgrid: true,
            gridcolor: 'rgba(0,0,0,0.1)'
        },
        yaxis: {
            title: 'Pris (NOK)',
            side: 'left',
            showgrid: true,
            gridcolor: 'rgba(0,0,0,0.1)',
            tickformat: '.2f'
        },
        yaxis2: {
            title: 'Volum',
            overlaying: 'y',
            side: 'right',
            showgrid: false,
            tickformat: '.2s'
        },
        showlegend: false,
        responsive: true,
        margin: {
            l: 60,
            r: 60,
            t: 80,
            b: 60
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: 'system-ui, -apple-system, sans-serif',
            size: 12,
            color: '#333'
        },
        hovermode: 'x unified'
    };
    
    const config = {
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
        displaylogo: false,
        responsive: true
    };
    
    Plotly.newPlot('price-chart', [priceTrace, volumeTrace], layout, config);
}

// Initialize chart when page loads - Enhanced with better timing
document.addEventListener('DOMContentLoaded', function() {
    // Load default chart when chart tab is shown
    const chartTab = document.getElementById('chart-tab');
    const chartPane = document.getElementById('chart');
    let chartInitialized = false;
    
    // Add event listener for when chart tab is clicked
    chartTab.addEventListener('shown.bs.tab', function() {
        if (!chartInitialized) {
            console.log('📊 Initializing chart...');
            updateChart('1W'); // Load default 1 week chart
            chartInitialized = true;
        }
    });
    
    // Also initialize if chart tab is active on page load
    if (chartTab && chartTab.classList.contains('active')) {
        setTimeout(() => {
            if (!chartInitialized) {
                console.log('📊 Initializing chart on page load...');
                updateChart('1W');
                chartInitialized = true;
            }
        }, 1000);
    }
});

// Technical analysis loading - Enhanced with real API call and TradingView integration
document.getElementById('technical-tab').addEventListener('click', function() {
    const loadingElement = document.getElementById('technical-loading');
    const contentElement = document.getElementById('technical-content');
    
    // Initialize TradingView widget when technical tab is opened
    setTimeout(() => {
        initTradingViewWidget();
    }, 500);
    
    if (loadingElement) {
        // Show loading first
        loadingElement.style.display = 'block';
        if (contentElement) contentElement.style.display = 'none';
        
        // Load real technical data from API
        fetch(`/api/technical-data/${currentSymbol}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingElement.style.display = 'none';
            if (contentElement) {
                contentElement.style.display = 'block';
                
                if (data.success && data.data) {
                    // Use real data from API
                    const techData = data.data;
                    const rsi = techData.rsi || {};
                    const macd = techData.macd || {};
                    const sma = techData.moving_averages || {};
                    const stoch = techData.stochastic || {};
                    
                    // Update the RSI and MACD values in the existing HTML
                    const rsiValueEl = document.getElementById('rsi-value');
                    const rsiSignalEl = document.getElementById('rsi-signal');
                    const macdValueEl = document.getElementById('macd-value');
                    const macdSignalEl = document.getElementById('macd-signal');
                    const rsiBadgeEl = document.getElementById('rsi-badge');
                    const technicalSummaryEl = document.getElementById('technical-summary');
                    
                    if (rsiValueEl) rsiValueEl.textContent = rsi.value || '50.0';
                    if (rsiSignalEl) rsiSignalEl.textContent = rsi.signal || 'Neutral';
                    if (macdValueEl) macdValueEl.textContent = macd.macd || '0.000';
                    if (macdSignalEl) macdSignalEl.textContent = macd.trend || 'Unknown';
                    if (rsiBadgeEl) {
                        rsiBadgeEl.textContent = rsi.value || '50.0';
                        rsiBadgeEl.className = `badge ${getRSIBadgeClass(rsi.value)}`;
                    }
                    
                    if (technicalSummaryEl) {
                        technicalSummaryEl.innerHTML = `
                            <strong>Teknisk utblick:</strong> ${rsi.description || 'Ingen teknisk analyse tilgjengelig'}
                            <br><strong>MACD:</strong> ${macd.description || 'MACD data ikke tilgjengelig'}
                            <br><small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>Teknisk analyse oppdatert: ${techData.last_updated || new Date().toLocaleTimeString('no-NO')}
                                <br><i class="fas fa-database me-1"></i>Data kilde: ${techData.data_source || 'UNKNOWN'}
                            </small>
                        `;
                        technicalSummaryEl.className = `alert ${getSignalAlertClass(rsi.signal)}`;
                    }
                    
                    console.log('✅ Technical indicators updated with real data');
                } else {
                    console.log('⚠️ API returned no data, keeping default values');
                }
            }
        })
        .catch(error => {
            console.error('❌ Error loading technical data:', error);
            loadingElement.style.display = 'none';
            if (contentElement) {
                contentElement.style.display = 'block';
                // Keep existing hardcoded fallback values in the template
            }
        });
    }
});

// Helper functions for technical indicators display
function getRSIBadgeClass(rsi) {
    if (rsi < 30) return 'bg-success'; // Oversold - potential buy
    if (rsi > 70) return 'bg-danger';  // Overbought - potential sell
    if (rsi < 40) return 'bg-info';    // Slightly oversold
    if (rsi > 60) return 'bg-warning'; // Slightly overbought
    return 'bg-secondary'; // Neutral
}

function getMADCBadgeClass(trend) {
    if (trend === 'Bullish') return 'bg-success';
    if (trend === 'Bearish') return 'bg-danger';
    return 'bg-secondary';
}

function getSignalAlertClass(signal) {
    if (signal === 'Kjøp') return 'alert-success';
    if (signal === 'Selg') return 'alert-danger';
    return 'alert-info';
}

function getSignalBadgeClass(signal) {
    if (signal === 'Kjøp') return 'bg-success';
    if (signal === 'Selg') return 'bg-danger';
    return 'bg-secondary';
}

function createFallbackTechnicalContent() {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>Trendindikatorer</h6>
                <table class="table table-sm">
                    <tr><td>RSI (14)</td><td class="text-end"><span class="badge bg-warning">65.2</span></td></tr>
                    <tr><td>SMA 20</td><td class="text-end">" + ({{ stock.price or 100 }} * 0.98).toFixed(2) + " NOK</td></tr>
                    <tr><td>SMA 50</td><td class="text-end">" + ({{ stock.price or 100 }} * 0.95).toFixed(2) + " NOK</td></tr>
                    <tr><td>EMA 12</td><td class="text-end">" + ({{ stock.price or 100 }} * 1.02).toFixed(2) + " NOK</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Momentum</h6>
                <table class="table table-sm">
                    <tr><td>MACD</td><td class="text-end"><span class="badge bg-success">Bullish</span></td></tr>
                    <tr><td>Stokastisk</td><td class="text-end">78.5</td></tr>
                    <tr><td>Williams %R</td><td class="text-end">-25.3</td></tr>
                    <tr><td>ADX</td><td class="text-end"><span class="badge bg-info">42.1</span></td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Analyse Sammendrag</h6>
                <div class="alert alert-warning">
                    <strong>Teknisk utblick:</strong> Bruker fallback data - API ikke tilgjengelig.
                    <br><span class="badge bg-warning">DEMO DATA</span>
                    <br><small class="text-dark mt-1 d-block">
                        <i class="fas fa-exclamation-triangle me-1"></i>Teknisk analyse basert på demo data: ${new Date().toLocaleTimeString('no-NO')}
                    </small>
                </div>
            </div>
        </div>
    `;
}

// Add to watchlist function (Enhanced)
function addToWatchlist(ticker) {
    {% if current_user.is_authenticated %}
        // Update button state
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Legger til...';
        btn.disabled = true;
        
        fetch('/api/watchlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({ symbol: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '<i class="fas fa-star-fill me-1"></i>I favoritter';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-warning');
                showToast('✅ ' + ticker + ' lagt til i favoritter!', 'success');
            } else {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                showToast('❌ Feil: ' + (data.error || 'Kunne ikke legge til i favoritter'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            showToast('❌ Teknisk feil ved adding til favoritter', 'error');
        });
    {% else %}
        showToast('ℹ️ Du må logge inn for å legge til favoritter', 'info');
        setTimeout(() => window.location.href = '/auth/login', 1500);
    {% endif %}
}

// Add to portfolio function (Enhanced)
function addToPortfolio(ticker) {
    {% if current_user.is_authenticated %}
        // Update button state
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Legger til...';
        btn.disabled = true;
        
        fetch('/portfolio/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: new URLSearchParams({
                'ticker': ticker,
                'quantity': 1,
                'purchase_price': parseFloat(document.querySelector('.stock-price')?.textContent?.replace(/[^\d.]/g, '') || 0)
            })
        })
        .then(response => {
            if (response.ok) {
                btn.innerHTML = '<i class="fas fa-briefcase-fill me-1"></i>I portefølje';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-info');
                showToast('✅ ' + ticker + ' lagt til i portefølje!', 'success');
            } else {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                showToast('❌ Kunne ikke legge til i portefølje. Prøv igjen.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            showToast('❌ Teknisk feil ved adding til portefølje', 'error');
        });
    {% else %}
        showToast('ℹ️ Du må logge inn for å legge til i portefølje', 'info');
        setTimeout(() => window.location.href = '/auth/login', 1500);
    {% endif %}
}

// Enhanced technical indicators loading
function loadTechnicalIndicators() {
    const loading = document.getElementById('technical-loading');
    const content = document.getElementById('technical-content');
    
    if (!loading || !content) return;
    
    // Show loading state
    loading.style.display = 'block';
    content.style.opacity = '0.5';
    
    // Simulate API call to fetch real technical data
    setTimeout(() => {
        // Generate realistic technical indicators
        const basePrice = parseFloat(document.querySelector('.stock-price')?.textContent?.replace(/[^\d.]/g, '') || 275);
        const mockIndicators = {
            rsi: (Math.random() * 40 + 35).toFixed(1),
            macd: (Math.random() * 4 - 2).toFixed(2),
            stochastic: (Math.random() * 40 + 30).toFixed(1),
            williams: (Math.random() * -60 - 20).toFixed(1),
            sma20: (basePrice * (0.98 + Math.random() * 0.04)).toFixed(2),
            sma50: (basePrice * (0.96 + Math.random() * 0.06)).toFixed(2),
            ema12: (basePrice * (0.99 + Math.random() * 0.02)).toFixed(2),
            volume: (Math.random() * 1000000 + 500000).toFixed(0)
        };
        
        // Update individual indicator values
        const rsiValue = document.getElementById('rsi-value');
        const rsiSignal = document.getElementById('rsi-signal');
        const rsiClass = mockIndicators.rsi > 70 ? 'text-danger' : mockIndicators.rsi < 30 ? 'text-success' : 'text-warning';
        const rsiText = mockIndicators.rsi > 70 ? 'Overkjøpt' : mockIndicators.rsi < 30 ? 'Oversolgt' : 'Neutral';
        
        if (rsiValue) {
            rsiValue.textContent = mockIndicators.rsi;
            rsiValue.className = rsiClass;
        }
        if (rsiSignal) rsiSignal.textContent = rsiText;
        
        const macdValue = document.getElementById('macd-value');
        const macdSignal = document.getElementById('macd-signal');
        const macdClass = mockIndicators.macd > 0 ? 'text-success' : 'text-danger';
        const macdText = mockIndicators.macd > 0 ? 'Bullish' : 'Bearish';
        
        if (macdValue) {
            macdValue.textContent = mockIndicators.macd;
            macdValue.className = macdClass;
        }
        if (macdSignal) macdSignal.textContent = macdText;
        
        // Update detailed tables
        const rsiBadge = document.getElementById('rsi-badge');
        if (rsiBadge) {
            rsiBadge.textContent = mockIndicators.rsi;
            rsiBadge.className = `badge ${mockIndicators.rsi > 70 ? 'bg-danger' : mockIndicators.rsi < 30 ? 'bg-success' : 'bg-warning'}`;
        }
        
        const stochBadge = document.getElementById('stoch-badge');
        if (stochBadge) stochBadge.textContent = mockIndicators.stochastic;
        
        const williamsBadge = document.getElementById('williams-badge');
        if (williamsBadge) williamsBadge.textContent = mockIndicators.williams;
        
        const sma20Value = document.getElementById('sma20-value');
        if (sma20Value) sma20Value.textContent = mockIndicators.sma20;
        
        const sma50Value = document.getElementById('sma50-value');
        if (sma50Value) sma50Value.textContent = mockIndicators.sma50;
        
        const ema12Value = document.getElementById('ema12-value');
        if (ema12Value) ema12Value.textContent = mockIndicators.ema12;
        
        // Update technical summary
        const technicalSummary = document.getElementById('technical-summary');
        if (technicalSummary) {
            const trendDirection = parseFloat(mockIndicators.sma20) > parseFloat(mockIndicators.sma50) ? 'oppgående' : 'nedgående';
            const momentumText = mockIndicators.macd > 0 ? 'positiv' : 'negativ';
            const alertClass = mockIndicators.rsi > 70 ? 'alert-warning' : mockIndicators.rsi < 30 ? 'alert-success' : 'alert-info';
            
            technicalSummary.className = `alert ${alertClass}`;
            technicalSummary.innerHTML = `
                <strong>Teknisk utblick:</strong> Aksjen viser ${momentumText} momentum med RSI på ${mockIndicators.rsi}. 
                ${rsiText} nivåer indikerer ${rsiText.toLowerCase() === 'neutral' ? 'balansert handelsaktivitet' : 'forsiktighet'}. 
                MACD viser ${macdText.toLowerCase()} trend. SMA-analyse indikerer ${trendDirection} retning.
                <br><small class="text-muted mt-1 d-block">
                    <i class="fas fa-info-circle me-1"></i>Oppdatert: ${new Date().toLocaleTimeString('no-NO')}
                </small>
            `;
        }
        
        // Hide loading and restore content
        loading.style.display = 'none';
        content.style.opacity = '1';
        
        console.log('✅ Technical indicators loaded successfully');
    }, 1500);
}

// Listen for technical tab activation
document.addEventListener('DOMContentLoaded', function() {
    // Load technical indicators when technical tab is clicked
    const technicalTab = document.getElementById('technical-tab');
    if (technicalTab) {
        let indicatorsLoaded = false;
        technicalTab.addEventListener('click', function() {
            // Load indicators on first click or refresh data
            if (!indicatorsLoaded) {
                console.log('🔄 Loading technical indicators...');
                loadTechnicalIndicators();
                indicatorsLoaded = true;
            }
        });
        
        // Also load indicators if technical tab is shown on page load
        technicalTab.addEventListener('shown.bs.tab', function() {
            if (!indicatorsLoaded) {
                loadTechnicalIndicators();
                indicatorsLoaded = true;
            }
        });
    }
});

// Removed conflicting chart initialization that was causing loading issues
// Chart initialization is now handled by the main DOMContentLoaded listener above
</script>

<style>
.nav-tabs .nav-link {
    border: none;
    border-bottom: 2px solid transparent;
    background: none;
    color: #6c757d;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #007bff;
    color: #007bff;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    color: #007bff;
}

#price-chart {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: #f8f9fa;
}

.table td {
    border: none;
    padding: 0.5rem 0;
}

.table td:first-child {
    font-weight: 500;
    color: #6c757d;
}

/* Custom dark green for BUY signal banner */
.bg-dark-green {
    background-color: #14532d !important;
    color: #fff !important;
}

/* Enhanced Mobile Responsiveness for Stock Details */
@media (max-width: 768px) {
    /* Better header layout on mobile */
    .stock-header .row {
        text-align: center;
    }
    
    .stock-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stock-price {
        font-size: 1.75rem !important;
        margin-top: 0.5rem;
    }
    
    /* Compact navigation tabs */
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-item {
        white-space: nowrap;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 0;
    }
    
    /* Better table layout on mobile */
    .table-responsive {
        font-size: 0.85rem;
    }
    
    .table th,
    .table td {
        padding: 0.4rem 0.3rem;
        vertical-align: middle;
    }
    
    /* Improved button spacing */
    .btn-group {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* Better card spacing */
    .card {
        margin-bottom: 1rem;
        border-radius: 8px;
    }
    
    .card-header {
        padding: 0.75rem 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    /* Enhanced chart container */
    #price-chart {
        height: 300px !important;
        border-radius: 8px;
    }
    
    /* Better form controls */
    .form-control,
    .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Improved alert styling */
    .alert {
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.9rem;
    }
    
    /* Better badge styling */
    .badge {
        font-size: 0.7rem;
        padding: 0.3em 0.6em;
    }
    
    /* Compact metrics display */
    .row.g-2 {
        margin: -0.25rem;
    }
    
    .row.g-2 > * {
        padding: 0.25rem;
    }
}

@media (max-width: 575.98px) {
    /* Extra compact layout for small phones */
    .container-fluid {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    
    .card-header {
        padding: 0.5rem 0.75rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .nav-tabs .nav-link {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
    }
    
    .btn-sm {
        padding: 0.3rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .table th,
    .table td {
        padding: 0.3rem 0.2rem;
        font-size: 0.8rem;
    }
    
    .stock-price {
        font-size: 1.5rem !important;
    }
    
    .h3, h3 {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Company description toggle functionality
function toggleDescription() {
    const shortDesc = document.getElementById('short-description');
    const fullDesc = document.getElementById('full-description');
    const toggleText = document.getElementById('toggle-text');
    
    if (fullDesc.style.display === 'none') {
        shortDesc.style.display = 'none';
        fullDesc.style.display = 'inline';
        toggleText.textContent = 'Les mindre';
    } else {
        shortDesc.style.display = 'inline';
        fullDesc.style.display = 'none';
        toggleText.textContent = 'Les mer';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // External buy button functionality - redirect to external broker
    document.querySelectorAll('.external-buy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticker = this.dataset.ticker;
            if (!ticker) return;
            
            // Update button to show loading state
            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Åpner...';
            this.disabled = true;
            
            // Construct external URL - using DNB Nettmegler as example
            let externalUrl;
            if (ticker.endsWith('.OL')) {
                // Norwegian stock - remove .OL suffix for DNB
                const norwegianTicker = ticker.replace('.OL', '');
                externalUrl = `https://www.dnb.no/portalfront/dnbinvestor/omhandler/kjopselgaksjer?searchString=${norwegianTicker}`;
            } else {
                // International stock - use a different broker or search
                externalUrl = `https://www.google.com/search?q=${ticker}+stock+buy+broker`;
            }
            
            // Open external URL in new tab
            try {
                window.open(externalUrl, '_blank', 'noopener,noreferrer');
                
                // Reset button after short delay
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }, 2000);
                
                showToast(`Åpner kjøpsside for ${ticker}`, 'success');
            } catch (error) {
                console.error('Error opening external URL:', error);
                this.innerHTML = originalHtml;
                this.disabled = false;
                showToast('Kunne ikke åpne kjøpsside', 'error');
            }
        });
    });
});

function showToast(message, type) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to toast container or create one
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hidden
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}
    }
});

// Enhanced TradingView Widget initialization with better error handling
function initTradingViewWidget() {
    const symbol = '{{ stock.symbol }}';
    if (!symbol) {
        console.error('No stock symbol provided');
        return;
    }
    
    console.log('🚀 Initializing TradingView widget for:', symbol);
    
    // Convert symbol for TradingView format
    let tvSymbol = symbol;
    if (symbol.endsWith('.OL')) {
        tvSymbol = 'OSE:' + symbol.replace('.OL', '');
    } else if (symbol.includes('BTC') || symbol.includes('ETH')) {
        tvSymbol = 'BINANCE:' + symbol.replace('-USD', 'USDT');
    } else if (symbol.match(/^[A-Z]{1,5}$/)) {
        tvSymbol = 'NASDAQ:' + symbol;
    }
    
    function hideLoading() {
        const loading = document.getElementById('chart-loading-details');
        if (loading) {
            loading.style.display = 'none';
        }
    }
    
    function showFallbackChart() {
        const container = document.getElementById('tradingview_widget_details');
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>TradingView Chart</strong>
                        <p class="mb-2">Chart for ${symbol} är under innlasting.</p>
                        <button class="btn btn-primary btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh siden
                        </button>
                    </div>
                </div>
            `;
        }
        hideLoading();
    }
    
    function createWidget() {
        if (typeof TradingView !== 'undefined' && TradingView.widget) {
            try {
                console.log('✅ Creating TradingView widget for:', tvSymbol);
                new TradingView.widget({
                    "autosize": true,
                    "symbol": tvSymbol,
                    "interval": "D",
                    "timezone": "Europe/Oslo",
                    "theme": "light",
                    "style": "1",
                    "locale": "no",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "withdateranges": true,
                    "range": "6M",
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "details": true,
                    "calendar": true,
                    "container_id": "tradingview_widget_details",
                    "onChartReady": function() {
                        console.log('✅ TradingView chart loaded successfully');
                        hideLoading();
                    }
                });
            } catch (error) {
                console.error('❌ Error creating TradingView widget:', error);
                showFallbackChart();
            }
        } else {
            console.log('⏳ TradingView not ready yet, retrying in 500ms...');
            setTimeout(createWidget, 500);
        }
    }
    
    // Start creation with fallback timeout
    createWidget();
    
    // Force hide loading after 8 seconds
    setTimeout(() => {
        if (document.getElementById('chart-loading-details')) {
            console.log('⚠️ Chart loading timeout, showing fallback');
            showFallbackChart();
        }
    }, 8000);
}

// Load TradingView script with better error handling
function loadTradingViewScript() {
    if (document.querySelector('script[src*="tradingview"]')) {
        console.log('📈 TradingView script already loaded');
        initTradingViewWidget();
        return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.onload = function() {
        console.log('📈 TradingView script loaded successfully');
        setTimeout(initTradingViewWidget, 1000);
    };
    script.onerror = function() {
        console.error('❌ Failed to load TradingView script');
        const container = document.getElementById('tradingview_widget_details');
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Chart utilgjengelig</strong>
                        <p>Kunne ikke laste TradingView chart. Sjekk internettforbindelsen.</p>
                    </div>
                </div>
            `;
        }
    };
    document.head.appendChild(script);
}

// Initialize when page loads
loadTradingViewScript();

// Also add chart to fundamentals tab
document.addEventListener('DOMContentLoaded', function() {
    const fundamentalsTab = document.getElementById('fundamentals-tab');
    if (fundamentalsTab) {
        fundamentalsTab.addEventListener('click', function() {
            setTimeout(() => {
                // Add a simple chart to fundamentals tab if not exists
                const fundamentalsPanel = document.getElementById('fundamentals');
                if (fundamentalsPanel && !fundamentalsPanel.querySelector('.fundamentals-chart')) {
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'fundamentals-chart mt-4';
                    chartDiv.innerHTML = `
                        <h5>Aksjegraf</h5>
                        <div id="fundamentals_chart" style="height: 300px; width: 100%;"></div>
                    `;
                    fundamentalsPanel.appendChild(chartDiv);
                    
                    // Initialize mini TradingView widget for fundamentals
                    const symbol = '{{ stock.symbol }}';
                    let tvSymbol = symbol;
                    if (symbol.endsWith('.OL')) {
                        tvSymbol = 'OSE:' + symbol.replace('.OL', '');
                    } else if (symbol.match(/^[A-Z]{1,5}$/)) {
                        tvSymbol = 'NASDAQ:' + symbol;
                    }
                    
                    if (typeof TradingView !== 'undefined') {
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": tvSymbol,
                            "interval": "D",
                            "timezone": "Europe/Oslo",
                            "theme": "light",
                            "style": "1",
                            "locale": "no",
                            "toolbar_bg": "#f1f3f6",
                            "enable_publishing": false,
                            "withdateranges": true,
                            "range": "3M",
                            "hide_side_toolbar": true,
                            "allow_symbol_change": false,
                            "details": false,
                            "calendar": false,
                            "container_id": "fundamentals_chart"
                        });
                    }
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}
