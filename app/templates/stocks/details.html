}

function createTechnicalWidget(symbol, container, loading) {
    try {
    new TradingView.widget({
            "autosize": true,
            "symbol": symbol,
            "interval": "1D",
            "timezone": "Europe/Oslo",
            "theme": "light",
            "style": "1",
            "locale": "no",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "range": "3M",
            "hide_side_toolbar": true,
            "allow_symbol_change": false,
            "details": false,
            "calendar": false,
            /* Correct study identifiers with vendor namespace */
            "studies": [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "BollingerBands@tv-basicstudies"
            ],
            "container_id": "tradingview_technical_widget",
            "onChartReady": function() {
                console.log('‚úÖ TradingView technical analysis loaded successfully');
                if (loading) loading.style.display = 'none';
                technicalWidgetLoaded = true;
                updateTechnicalSummary();
            }
        });
    } catch (error) {
        console.error('‚ùå Error creating TradingView technical widget:', error);
        showTechnicalError(container, loading);
        const fb = document.getElementById('technical-fallback');
        if (fb) fb.style.display = 'block';
    }
}

let technicalSummaryInitialized = false;
function updateTechnicalSummary() {
    const timeSpan = document.getElementById('tech-update-time');
    const summaryText = document.getElementById('technical-summary-text');
    const indicatorsWrapper = document.getElementById('technical-indicators');
    const indicatorTags = document.querySelectorAll('#technical-indicators .indicator-tag');
    const fallback = document.getElementById('indicator-fallback');

    if (timeSpan) {
        timeSpan.textContent = new Date().toLocaleTimeString('no-NO');
    }

    // Only run indicator detection once per successful load
    if (technicalSummaryInitialized) return;

    // Simulated detection: if widget loaded we show all configured studies; otherwise fallback
    if (technicalWidgetLoaded && window.TradingView) {
        if (summaryText) summaryText.textContent = 'TradingView-widget lastet';
        if (indicatorsWrapper) indicatorsWrapper.style.display = 'block';
        indicatorTags.forEach(tag => { tag.style.display = 'inline-block'; });
        if (fallback) fallback.style.display = 'none';
    } else {
        if (summaryText) summaryText.textContent = 'Fors√∏ker √• laste TradingView-widget';
        if (indicatorsWrapper) indicatorsWrapper.style.display = 'block';
        if (fallback) fallback.style.display = 'inline';
    }
    technicalSummaryInitialized = true;
}

// Safety timeout: if technical widget not loaded after 12s, show fallback
setTimeout(() => {
    if (!technicalWidgetLoaded) {
        technicalSummaryInitialized = false; // allow execution
        updateTechnicalSummary();
    }
}, 12000);

// Utility functions
function loadTradingViewScript(callback) {
    if (document.querySelector('script[src*="tradingview"]')) {
        if (window.TradingView) {
            callback();
        } else {
            // Script loaded but TradingView not ready yet, wait a bit
            setTimeout(() => {
                if (window.TradingView) {
                    callback();
                } else {
                    console.error('‚ùå TradingView script loaded but not ready');
                }
            }, 1000);
        }
        return;
    }
    
    console.log('üì• Loading TradingView script...');
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.onload = function() {
        console.log('‚úÖ TradingView script loaded successfully');
        // Wait for TradingView to be available
        setTimeout(() => {
            if (window.TradingView) {
                callback();
            } else {
                console.error('‚ùå TradingView not available after script load');
            }
        }, 500);
    };
    script.onerror = function() {
        console.error('‚ùå Failed to load TradingView script');
    };
    document.head.appendChild(script);
}

function showChartError(container, loading) {
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Kunne ikke laste graf</strong>
                    <p>TradingView graf er midlertidig utilgjengelig. Pr√∏v √• oppdatere siden.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Oppdater siden
                    </button>
                </div>
            </div>
        `;
    }
    if (loading) loading.style.display = 'none';
}

function showTechnicalError(container, loading) {
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Kunne ikke laste teknisk analyse</strong>
                    <p>Teknisk analyse er midlertidig utilgjengelig. Pr√∏v √• oppdatere siden.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Oppdater siden
                    </button>
                </div>
            </div>
        `;
    }
    if (loading) loading.style.display = 'none';
}

// Action buttons
function addToWatchlist(symbol) {
    fetch('/add_to_watchlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ symbol: symbol })
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            showToast('‚úÖ Lagt til i favoritter', 'success');
        } else {
            showToast('‚ùå Kunne ikke legge til i favoritter', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Teknisk feil ved adding til favoritter', 'error');
    });
}

function addToPortfolio(symbol) {
    fetch('/add_to_portfolio', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ symbol: symbol })
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            showToast('‚úÖ Lagt til i portef√∏lje', 'success');
        } else {
            showToast('‚ùå Kunne ikke legge til i portef√∏lje', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Teknisk feil ved adding til portef√∏lje', 'error');
    });
}

// External buy button functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.external-buy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticker = this.dataset.ticker;
            if (!ticker) return;
            
            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>√Öpner...';
            this.disabled = true;
            
            let externalUrl;
            if (ticker.endsWith('.OL')) {
                const norwegianTicker = ticker.replace('.OL', '');
                externalUrl = `https://www.dnb.no/portalfront/dnbinvestor/omhandler/kjopselgaksjer?searchString=${norwegianTicker}`;
            } else {
                externalUrl = `https://www.google.com/search?q=${ticker}+stock+buy+broker`;
            }
            
            try {
                window.open(externalUrl, '_blank', 'noopener,noreferrer');
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }, 2000);
                showToast(`√Öpner kj√∏psside for ${ticker}`, 'success');
            } catch (error) {
                console.error('Error opening external URL:', error);
                this.innerHTML = originalHtml;
                this.disabled = false;
                showToast('Kunne ikke √•pne kj√∏psside', 'error');
            }
        });
    });
});

// Toast notification function
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}
</script>

<style>
/* Compact layout adjustments */
.stock-details-container { max-width: 1400px; }
.compact-tabs .nav-link { padding: 0.55rem 0.85rem; font-size: 0.95rem; }
#stockTabs { margin-bottom: 0.85rem !important; }
.compact-card .card-header { padding: 0.55rem 0.85rem; }
.compact-card .card-header h5 { margin: 0; font-size: 1rem; }
.compact-card .card-body { padding: 0.85rem 0.95rem; }
#overview .card-body { padding: 0.9rem 1rem; }
#overview .card + .card { margin-top: 0.85rem; }
#key-metrics-card { margin-top: 1.25rem !important; }
#technical-summary { margin-top: 0.65rem !important; }
.metric { padding: 0.7rem 0.5rem; }
.metric .h6 { margin: 0; }
.tradingview-widget-container { margin-bottom: 0; }
#chart .card-body, #technical .card-body, #fundamentals .card-body { padding-top: 0.7rem; padding-bottom: 0.7rem; }
.tab-content > .tab-pane { padding-top: 0.25rem; }
@media (max-width: 768px) {
    .compact-tabs .nav-link { padding: 0.45rem 0.65rem; font-size: 0.8rem; }
    .compact-card .card-header { padding: 0.5rem 0.65rem; }
    .compact-card .card-body { padding: 0.65rem 0.7rem; }
    .metric { padding: 0.55rem 0.4rem; }
    #overview .card-body { padding: 0.7rem 0.65rem; }
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 2px solid transparent;
    background: none;
    color: #6c757d;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #007bff;
    color: #007bff;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    color: #007bff;
}

.metric {
    text-align: center;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: #f8f9fa;
}

.stock-price {
    font-weight: bold;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .stock-header .row {
        text-align: center;
    }
    
    .stock-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stock-price {
        font-size: 1.75rem !important;
        margin-top: 0.5rem;
    }
    
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    
    .nav-tabs .nav-item {
        white-space: nowrap;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}
