{% extends "base.html" %}

{% block title %}{{ stock.symbol }} - {{ stock.name }} | Aksjeradar{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Stock Header -->
            <div class="stock-header mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-1">{{ stock.name or 'Ukjent Selskap' }}</h1>
                        <p class="text-muted mb-2">{{ stock.symbol }} • {{ stock.exchange or 'OSE' }}</p>
                        {% if stock.sector %}
                        <span class="badge bg-secondary">{{ stock.sector }}</span>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="stock-price text-primary h2 mb-0">{{ "%.2f"|format(stock.price or 0) }} NOK</div>
                        <div class="
                            {% if stock.change and stock.change > 0 %}text-success
                            {% elif stock.change and stock.change < 0 %}text-danger
                            {% else %}text-muted{% endif %}">
                            {% if stock.change %}{{ "%.2f"|format(stock.change) }} ({{ "%.2f"|format(stock.change_percent or 0) }}%){% endif %}
                        </div>
                        <small class="text-muted">Sist oppdatert: {{ stock.last_updated or 'Ikke tilgjengelig' }}</small>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="stockTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-home me-1"></i>Oversikt
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">
                        <i class="fas fa-chart-line me-1"></i>Graf
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab">
                        <i class="fas fa-cogs me-1"></i>Teknisk Analyse
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fundamentals-tab" data-bs-toggle="tab" data-bs-target="#fundamentals" type="button" role="tab">
                        <i class="fas fa-calculator me-1"></i>Fundamental
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="stockTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Selskapsinfo</h5>
                                </div>
                                <div class="card-body">
                                    <p>{{ stock.description or 'Equinor ASA (tidligere Statoil) er et norsk multinasjonalt energiselskap som primært opererer innen olje- og gassutvinning. Selskapet har hovedkontor i Stavanger og er et av Norges største selskaper målt etter omsetning og markedsverdi.' }}</p>
                                    
                                    <h6 class="mt-3">Nøkkeldata</h6>
                                    <table class="table table-sm">
                                        <tr><td>Sektor:</td><td>{{ stock.sector or 'Energi' }}</td></tr>
                                        <tr><td>Industri:</td><td>{{ stock.industry or 'Olje og gass' }}</td></tr>
                                        <tr><td>Ansatte:</td><td>{{ stock.employees or '20,000+' }}</td></tr>
                                        <tr><td>Land:</td><td>{{ stock.country or 'Norge' }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Resultatsammendrag</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td>Omsetning (TTM):</td><td class="text-end">{{ stock.revenue or '855 mrd NOK' }}</td></tr>
                                        <tr><td>Netto resultat:</td><td class="text-end">{{ stock.net_income or '125 mrd NOK' }}</td></tr>
                                        <tr><td>Resultat pr aksje:</td><td class="text-end">{{ stock.eps or '42.50 NOK' }}</td></tr>
                                        <tr><td>EBITDA:</td><td class="text-end">{{ stock.ebitda or '285 mrd NOK' }}</td></tr>
                                        <tr><td>ROE:</td><td class="text-end">{{ stock.roe or '18.5%' }}</td></tr>
                                        <tr><td>Gjeldsgrad:</td><td class="text-end">{{ stock.debt_ratio or '25%' }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Metrics - Only shown on overview tab -->
                    <div class="card mt-4" id="key-metrics-card">
                        <div class="card-header">
                            <h5 class="mb-0">Nøkkeltall</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="metric">
                                        <strong>P/E-forhold:</strong>
                                        <div class="h6 text-primary">{{ stock.pe_ratio or '15.2' }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <strong>Markedsverdi:</strong>
                                        <div class="h6 text-primary">{{ stock.market_cap or '1.2T NOK' }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <strong>Utbytte:</strong>
                                        <div class="h6 text-primary">{{ stock.dividend_yield or '3.5%' }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <strong>Beta:</strong>
                                        <div class="h6 text-primary">{{ stock.beta or '1.15' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Tab -->
                <div class="tab-pane fade" id="chart" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Kursgraf - {{ stock.symbol }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="tradingview-widget-container" style="min-height: 400px;">
                                <div id="tradingview_widget_details" style="height: 400px;"></div>
                                <div id="chart-loading" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Laster graf...</span>
                                    </div>
                                    <div class="mt-2">Laster TradingView graf...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- Technical Analysis Tab -->
                <div class="tab-pane fade" id="technical" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Teknisk Analyse - {{ stock.symbol }}</h5>
                        </div>
                        <div class="card-body">
                            {% if stock.rsi or stock.macd or stock.bb %}
                            <div class="tradingview-widget-container" style="min-height: 400px;">
                                <div id="tradingview_technical_widget" style="height: 400px;"></div>
                                <div id="technical-loading" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Laster teknisk analyse...</span>
                                    </div>
                                    <div class="mt-2">Laster teknisk analyse...</div>
                                </div>
                            </div>
                            <div id="technical-summary" class="alert alert-info mt-3 mb-0">
                                <strong>Teknisk sammendrag:</strong> Detaljert teknisk analyse vises i grafen ovenfor med RSI, MACD og Bollinger Bands.
                                <br><small class="text-muted">Sist oppdatert: <span id="tech-update-time">{{ stock.last_updated or 'Ikke tilgjengelig' }}</span></small>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">Ingen tekniske indikatorer tilgjengelig.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            <!-- Fundamentals Tab -->
                <div class="tab-pane fade" id="fundamentals" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Resultatregnskap</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td>Omsetning:</td><td class="text-end">{{ stock.revenue or '855 mrd NOK' }}</td></tr>
                                        <tr><td>Netto resultat:</td><td class="text-end">{{ stock.net_income or '125 mrd NOK' }}</td></tr>
                                        <tr><td>Resultat pr aksje:</td><td class="text-end">{{ stock.eps or '42.50 NOK' }}</td></tr>
                                        <tr><td>EBITDA:</td><td class="text-end">{{ stock.ebitda or '285 mrd NOK' }}</td></tr>
                                        <tr><td>Bruttomargin:</td><td class="text-end">{{ stock.gross_margin or '65%' }}</td></tr>
                                        <tr><td>Driftsmargin:</td><td class="text-end">{{ stock.operating_margin or '25%' }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Balanse</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td>Total gjeld:</td><td class="text-end">{{ stock.total_debt or '95 mrd NOK' }}</td></tr>
                                        <tr><td>Kontanter:</td><td class="text-end">{{ stock.cash or '65 mrd NOK' }}</td></tr>
                                        <tr><td>Egenkapital:</td><td class="text-end">{{ stock.equity or '385 mrd NOK' }}</td></tr>
                                        <tr><td>Bok verdi pr aksje:</td><td class="text-end">{{ stock.book_value or '128 NOK' }}</td></tr>
                                        <tr><td>Arbeidskapital:</td><td class="text-end">{{ stock.working_capital or '45 mrd NOK' }}</td></tr>
                                        <tr><td>Enterprise Value:</td><td class="text-end">{{ stock.enterprise_value or '1.1T NOK' }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Verdsettelse</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>P/E-forhold:</strong><br>
                                            <span class="h6 text-primary">{{ stock.pe_ratio or '15.2' }}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>P/B-forhold:</strong><br>
                                            <span class="h6 text-primary">{{ stock.pb_ratio or '2.1' }}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>EV/EBITDA:</strong><br>
                                            <span class="h6 text-primary">{{ stock.ev_ebitda or '8.5' }}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>ROE:</strong><br>
                                            <span class="h6 text-primary">{{ stock.roe or '18.5%' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Handlinger</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="addToWatchlist('{{ stock.symbol }}')">
                            <i class="fas fa-star me-1"></i>Legg til favoritter
                        </button>
                        <button class="btn btn-outline-info" onclick="addToPortfolio('{{ stock.symbol }}')">
                            <i class="fas fa-briefcase me-1"></i>Legg til portefølje
                        </button>
                        <button class="btn btn-success external-buy-btn" data-ticker="{{ stock.symbol }}">
                            <i class="fas fa-shopping-cart me-1"></i>Kjøp
                        </button>
                        <a href="{{ url_for('analysis.ai', ticker=stock.symbol or stock.ticker) }}" class="btn btn-info">
                            <i class="fas fa-robot me-1"></i>Vis AI analyse
                        </a>
                        <a href="{{ url_for('analysis.technical', ticker=stock.symbol) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-line me-1"></i>Full teknisk analyse
                        </a>
                    </div>
                </div>
            </div>

            <!-- Similar Stocks -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Relaterte Aksjer</h5>
                </div>
                <div class="card-body">
                    {% if similar_stocks %}
                        {% for similar in similar_stocks[:5] %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <a href="{{ url_for('stocks.details', symbol=similar.symbol) }}" class="text-decoration-none">
                                    <strong>{{ similar.symbol }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">{{ similar.name[:30] }}...</small>
                            </div>
                            <div class="text-end">
                                <strong>{{ "%.2f"|format(similar.price or 0) }}</strong>
                                <br>
                                <small class="
                                    {% if similar.change and similar.change > 0 %}text-success
                                    {% elif similar.change and similar.change < 0 %}text-danger
                                    {% else %}text-muted{% endif %}">
                                    {{ "%.2f"|format(similar.change_percent or 0) }}%
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Ingen relaterte aksjer funnet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Latest News -->
            {% if stock_news %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Siste Nyheter</h5>
                </div>
                <div class="card-body">
                    {% for news in stock_news[:3] %}
                    <div class="border-bottom py-2">
                        <a href="{{ news.url }}" target="_blank" class="text-decoration-none">
                            <h6 class="mb-1">{{ news.title }}</h6>
                        </a>
                        <small class="text-muted">{{ news.published_at }} • {{ news.source }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let tradingViewLoaded = false;
let currentSymbol = '{{ stock.symbol }}';

// Show/hide key metrics based on active tab

// Key metrics should only be visible on overview tab
function toggleKeyMetrics() {
    const keyMetricsCard = document.getElementById('key-metrics-card');
    const overviewTabButton = document.getElementById('overview-tab');
    
    if (keyMetricsCard && overviewTabButton) {
        if (overviewTabButton.classList.contains('active')) {
            keyMetricsCard.style.display = 'block';
        } else {
            keyMetricsCard.style.display = 'none';
        }
    }
}


// Tab event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Listen for tab changes
    const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target');
            toggleKeyMetrics();
            
            // Initialize specific content based on tab
            switch(targetTab) {
                case '#chart':
                    initChart();
                    break;
                case '#technical':
                    initTechnicalAnalysis();
                    break;
            }
        });
    });
    
    // Initial state
    toggleKeyMetrics();
});

// Chart initialization

// Enhanced chart initialization with better error handling
function initChart() {
    console.log('🔄 Initializing chart for symbol:', currentSymbol);
    
    if (tradingViewLoaded) {
        console.log('✅ TradingView already loaded');
        return;
    }
    
    const container = document.getElementById('tradingview_widget_details');
    const loading = document.getElementById('chart-loading');
    
    if (!container) {
        console.error('❌ Chart container not found');
        return;
    }
    
    // Show loading immediately
    if (loading) {
        loading.style.display = 'block';
        console.log('📊 Showing chart loading indicator');
    }
    
    // Convert symbol for TradingView with better mapping
    let tvSymbol = currentSymbol;
    if (currentSymbol.endsWith('.OL')) {
        tvSymbol = 'OSE:' + currentSymbol.replace('.OL', '');
    } else if (currentSymbol.endsWith('.ST')) {
        tvSymbol = 'OMXSTO:' + currentSymbol.replace('.ST', '');
    } else if (currentSymbol.match(/^[A-Z]{1,5}$/)) {
        tvSymbol = 'NASDAQ:' + currentSymbol;
    } else if (currentSymbol.includes('-USD')) {
        // Crypto handling
        tvSymbol = 'BINANCE:' + currentSymbol.replace('-USD', 'USDT');
    }
    
    console.log(`📈 Using TradingView symbol: ${tvSymbol}`);
    
    // Shorter timeout and better fallback
    const loadTimeout = setTimeout(() => {
        console.warn('⚠️ TradingView loading timeout, showing fallback');
        showChartFallback(container, loading);
    }, 8000); // Reduced to 8 seconds
    
    if (!window.TradingView) {
        loadTradingViewScript(() => {
            clearTimeout(loadTimeout);
            createChart(tvSymbol, container, loading);
        });
    } else {
        clearTimeout(loadTimeout);
        createChart(tvSymbol, container, loading);
    }
}

function createChart(symbol, container, loading) {
    try {
        console.log('🎯 Creating TradingView chart with symbol:', symbol);
        
        new TradingView.widget({
            "autosize": true,
            "symbol": symbol,
            "interval": "D",
            "timezone": "Europe/Oslo",
            "theme": "light",
            "style": "1",
            "locale": "no",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "range": "6M",
            "hide_side_toolbar": false,
            "allow_symbol_change": false,
            "details": true,
            "calendar": false,
            "studies": [],
            "container_id": "tradingview_widget_details",
            "onChartReady": function() {
                console.log('✅ TradingView chart loaded successfully');
                if (loading) loading.style.display = 'none';
                tradingViewLoaded = true;
            },
            "loading_screen": {
                "backgroundColor": "#ffffff",
                "foregroundColor": "#007bff"
            }
        });
    } catch (error) {
        console.error('❌ Error creating TradingView chart:', error);
        showChartError(container, loading);
    }
}

function showChartFallback(container, loading) {
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="alert alert-info">
                    <i class="fas fa-chart-line me-2"></i>
                    <strong>Graf ikke tilgjengelig</strong>
                    <p class="mb-2">TradingView graf kunne ikke lastes for øyeblikket.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Prøv igjen
                    </button>
                </div>
            </div>
        `;
    }
    if (loading) loading.style.display = 'none';
}
function createChart(symbol, container, loading) {
    try {
        new TradingView.widget({
            "autosize": true,
            "symbol": symbol,
            "interval": "D",
            "timezone": "Europe/Oslo",
            "theme": "light",
            "style": "1",
            "locale": "no",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "range": "6M",
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "details": true,
            "calendar": true,
            "container_id": "tradingview_widget_details",
            "onChartReady": function() {
                console.log('✅ TradingView chart loaded successfully');
                if (loading) loading.style.display = 'none';
                tradingViewLoaded = true;
            }
        });
    } catch (error) {
        console.error('❌ Error creating TradingView chart:', error);
        showChartError(container, loading);
    }
}

// Technical analysis initialization
function initTechnicalAnalysis() {
    const container = document.getElementById('tradingview_technical_widget');
    const loading = document.getElementById('technical-loading');
    
    if (!container) return;
    
    // Show loading
    if (loading) loading.style.display = 'block';
    
    // Convert symbol for TradingView
    let tvSymbol = currentSymbol;
    if (currentSymbol.endsWith('.OL')) {
        tvSymbol = 'OSE:' + currentSymbol.replace('.OL', '');
    } else if (currentSymbol.match(/^[A-Z]{1,5}$/)) {
        tvSymbol = 'NASDAQ:' + currentSymbol;
    }
    
    // Load TradingView script if needed
    if (!window.TradingView) {
        loadTradingViewScript(() => createTechnicalWidget(tvSymbol, container, loading));
    } else {
        createTechnicalWidget(tvSymbol, container, loading);
    }
}

function createTechnicalWidget(symbol, container, loading) {
    try {
        new TradingView.widget({
            "autosize": true,
            "symbol": symbol,
            "interval": "1D",
            "timezone": "Europe/Oslo",
            "theme": "light",
            "style": "1",
            "locale": "no",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "range": "3M",
            "hide_side_toolbar": true,
            "allow_symbol_change": false,
            "details": false,
            "calendar": false,
            "studies": ["RSI", "MACD", "BB"],
            "container_id": "tradingview_technical_widget",
            "onChartReady": function() {
                console.log('✅ TradingView technical analysis loaded successfully');
                if (loading) loading.style.display = 'none';
                updateTechnicalSummary();
            }
        });
    } catch (error) {
        console.error('❌ Error creating TradingView technical widget:', error);
        showTechnicalError(container, loading);
    }
}

function updateTechnicalSummary() {
    const summary = document.getElementById('technical-summary');
    const timeSpan = document.getElementById('tech-update-time');
    
    if (timeSpan) {
        timeSpan.textContent = new Date().toLocaleTimeString('no-NO');
    }
    
    if (summary) {
        summary.innerHTML = `
            <strong>Teknisk sammendrag:</strong> Teknisk analyse vises i TradingView widget ovenfor med RSI, MACD og Bollinger Bands.
            <br><small class="text-muted">Sist oppdatert: ${new Date().toLocaleTimeString('no-NO')}</small>
        `;
    }
}

// Utility functions
function loadTradingViewScript(callback) {
    if (document.querySelector('script[src*="tradingview"]')) {
        callback();
        return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.onload = callback;
    script.onerror = function() {
        console.error('❌ Failed to load TradingView script');
    };
    document.head.appendChild(script);
}

function showChartError(container, loading) {
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Kunne ikke laste graf</strong>
                    <p>TradingView graf er midlertidig utilgjengelig. Prøv å oppdatere siden.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Oppdater siden
                    </button>
                </div>
            </div>
        `;
    }
    if (loading) loading.style.display = 'none';
}

function showTechnicalError(container, loading) {
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Kunne ikke laste teknisk analyse</strong>
                    <p>Teknisk analyse er midlertidig utilgjengelig. Prøv å oppdatere siden.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>Oppdater siden
                    </button>
                </div>
            </div>
        `;
    }
    if (loading) loading.style.display = 'none';
}

// Action buttons
function addToWatchlist(symbol) {
    fetch('/add_to_watchlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ symbol: symbol })
    })
    .then(response => response.json())
    .then data => {
        if (data.success) {
            showToast('✅ Lagt til i favoritter', 'success');
        } else {
            showToast('❌ Kunne ikke legge til i favoritter', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Teknisk feil ved adding til favoritter', 'error');
    });
}

function addToPortfolio(symbol) {
    fetch('/add_to_portfolio', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ symbol: symbol })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Lagt til i portefølje', 'success');
        } else {
            showToast('❌ Kunne ikke legge til i portefølje', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Teknisk feil ved adding til portefølje', 'error');
    });
}

// External buy button functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.external-buy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticker = this.dataset.ticker;
            if (!ticker) return;
            
            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Åpner...';
            this.disabled = true;
            
            let externalUrl;
            if (ticker.endsWith('.OL')) {
                const norwegianTicker = ticker.replace('.OL', '');
                externalUrl = `https://www.dnb.no/portalfront/dnbinvestor/omhandler/kjopselgaksjer?searchString=${norwegianTicker}`;
            } else {
                externalUrl = `https://www.google.com/search?q=${ticker}+stock+buy+broker`;
            }
            
            try {
                window.open(externalUrl, '_blank', 'noopener,noreferrer');
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }, 2000);
                showToast(`Åpner kjøpsside for ${ticker}`, 'success');
            } catch (error) {
                console.error('Error opening external URL:', error);
                this.innerHTML = originalHtml;
                this.disabled = false;
                showToast('Kunne ikke åpne kjøpsside', 'error');
            }
        });
    });
});

// Toast notification function
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}
</script>

<style>
.nav-tabs .nav-link {
    border: none;
    border-bottom: 2px solid transparent;
    background: none;
    color: #6c757d;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #007bff;
    color: #007bff;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    color: #007bff;
}

.metric {
    text-align: center;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: #f8f9fa;
}

.stock-price {
    font-weight: bold;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .stock-header .row {
        text-align: center;
    }
    
    .stock-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stock-price {
        font-size: 1.75rem !important;
        margin-top: 0.5rem;
    }
    
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    
    .nav-tabs .nav-item {
        white-space: nowrap;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}
