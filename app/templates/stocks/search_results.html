{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Søkeresultater for "{{ query }}"</h1>
  
  {% if results %}
    <div class="card mb-4">
      <div class="card-header">
        <h2>Resultater ({{ results|length }})</h2>
      </div>
      <div class="card-body">
        <div class="list-group">
          {% for ticker in results %}
            <div class="list-group-item d-flex justify-content-between align-items-center" style="background: #007bff; color: #fff;">
              <div>
                <a href="{{ url_for('stocks.details', symbol=ticker) }}" class="text-white text-decoration-none">
                  <strong>{{ ticker }}</strong>
                </a>
              </div>
              <button class="btn btn-sm btn-star-favorite text-white" style="background: transparent; border: none;" title="Legg til favoritt" onclick="toggleFavorite('{{ ticker }}', this)">
                <i class="bi bi-star"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      <p>Ingen resultater funnet for "{{ query }}".</p>
    </div>
  {% endif %}
  
  <a href="{{ url_for('stocks.list_oslo') }}" class="btn btn-secondary">Tilbake til aksjeliste</a>
</div>
{% endblock %}
{% block scripts %}
<script>
function toggleFavorite(ticker, btn) {
  {% if current_user.is_authenticated %}
  fetch(`/api/favorites/check/${ticker}`)
    .then(response => response.json())
    .then(data => {
      if (data.favorited) {
        fetch('/api/favorites/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
          },
          body: JSON.stringify({ symbol: ticker })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            btn.innerHTML = '<i class="bi bi-star"></i>';
            btn.classList.remove('bg-warning');
            btn.classList.add('text-white');
            showToast(`${ticker} fjernet fra favoritter`, 'danger');
          } else {
            showToast(data.error || 'Kunne ikke fjerne favoritt', 'danger');
          }
        });
      } else {
        fetch('/api/favorites/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
          },
          body: JSON.stringify({ symbol: ticker })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            btn.innerHTML = '<i class="bi bi-star-fill"></i>';
            btn.classList.add('bg-warning');
            btn.classList.remove('text-white');
            showToast(`${ticker} lagt til i favoritter`, 'success');
          } else {
            showToast(data.error || 'Kunne ikke legge til favoritt', 'danger');
          }
        });
      }
    });
  {% else %}
    alert('ℹ️ Du må logge inn for å legge til favoritter');
    window.location.href = '/auth/login';
  {% endif %}
}
function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  let container = document.querySelector('.toast-container');
  if (!container) {
    container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
  }
  container.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  toast.addEventListener('hidden.bs.toast', () => toast.remove());
}
</script>
{% endblock %}