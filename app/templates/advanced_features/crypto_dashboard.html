{% extends "base.html" %}

{% block title %}{{ t('features.crypto_dashboard', fallback='Krypto Dashboard') }} - Aksjeradar{% endblock %}

{% block extra_css %}
<style>
.crypto-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: transform 0.3s ease;
}

.crypto-card:hover {
    transform: translateY(-5px);
}

.crypto-card.bitcoin {
    background: linear-gradient(135deg, #f7931e 0%, #ff9500 100%);
}

.crypto-card.ethereum {
    background: linear-gradient(135deg, #627eea 0%, #3c4dc7 100%);
}

.market-stat-card {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.positive { color: #4caf50; }
.negative { color: #f44336; }
.neutral { color: #ffa726; }

.crypto-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.2);
    font-weight: bold;
}

.volume-bar {
    background: rgba(255,255,255,0.3);
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
}

.volume-fill {
    background: rgba(255,255,255,0.8);
    height: 100%;
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-3">
                <i class="bi bi-currency-bitcoin me-2"></i>
                {{ t('features.crypto_dashboard', fallback='Krypto Dashboard') }}
            </h1>
            <p class="text-muted">{{ t('features.crypto_description', fallback='Omfattende cryptocurrency tracking med sanntidsdata og markedsanalyse.') }}</p>
        </div>
    </div>

    {% if market_stats %}
    <!-- Market Statistics Row -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="market-stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Total Market Cap</h6>
                        <div class="h5 mb-0">${{ "{:,.0f}".format(market_stats.get('total_market_cap', 0) / 1000000000) }}B</div>
                    </div>
                    <i class="bi bi-globe fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="market-stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">24h Volume</h6>
                        <div class="h5 mb-0">${{ "{:,.0f}".format(market_stats.get('total_volume_24h', 0) / 1000000000) }}B</div>
                    </div>
                    <i class="bi bi-bar-chart fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="market-stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">BTC Dominance</h6>
                        <div class="h5 mb-0">{{ "{:.1f}".format(market_stats.get('btc_dominance', 0)) }}%</div>
                    </div>
                    <i class="bi bi-currency-bitcoin fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="market-stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Fear & Greed</h6>
                        <div class="h5 mb-0">{{ market_stats.get('fear_greed_index', 'N/A') }} <small class="text-light">(Greed)</small></div>
                    </div>
                    <i class="bi bi-speedometer2 fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if crypto_data %}
    <div class="row">
        {% for name, data in crypto_data.items() %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="crypto-card {{ name.lower() }}">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center">
                        <div class="crypto-icon me-3">
                            {{ data.get('symbol', 'N/A')[:3] }}
                        </div>
                        <div>
                            <h6 class="mb-0">{{ name }}</h6>
                            <small class="opacity-75">{{ data.get('symbol', 'N/A') }}</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-light add-to-watchlist" data-ticker="{{ data.get('symbol', 'N/A') }}-USD">
                        <i class="bi bi-star"></i>
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="h4 mb-1">${{ "{:,.2f}".format(data.get('price', 0)) if data.get('price', 0) < 1000 else "{:,.0f}".format(data.get('price', 0)) }}</div>
                        <div class="{{ 'positive' if data.get('change_percent', 0) > 0 else 'negative' if data.get('change_percent', 0) < 0 else 'neutral' }}">
                            {% if data.get('change_percent', 0) > 0 %}+{% endif %}{{ "{:.2f}".format(data.get('change_percent', 0)) }}%
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="small mb-1">24h Change</div>
                        <div class="{{ 'positive' if data.get('change_24h', 0) > 0 else 'negative' if data.get('change_24h', 0) < 0 else 'neutral' }}">
                            {% if data.get('change_24h', 0) > 0 %}+{% endif %}{{ '${:,.2f}'.format(data.get('change_24h', 0)) if data.get('change_24h', 0) < 1000 else '${:,.0f}'.format(data.get('change_24h', 0)) }}
                        </div>
                    </div>
                </div>
                
                {% if data.get('volume') %}
                <div class="mt-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Volume (24h)</span>
                        <span>${{ "{:,.0f}".format(data.volume / 1000000) }}M</span>
                    </div>
                    <div class="volume-bar">
                        <div class="volume-fill" style="width: {{ [100, (data.volume / 20000000000) * 100]|min }}%"></div>
                    </div>
                </div>
                {% endif %}
                
                {% if data.get('market_cap') %}
                <div class="mt-2">
                    <div class="d-flex justify-content-between small">
                        <span>Market Cap</span>
                        <span>${{ "{:,.0f}".format(data.market_cap / 1000000000) }}B</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                {{ t('common.loading', fallback='Laster kryptovaluta data...') }}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('advanced_features.index') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>{{ t('common.back', fallback='Tilbake') }}
            </a>
        </div>
    </div>
</div>

<script>
// Add to watchlist functionality for crypto
document.querySelectorAll('.add-to-watchlist').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const ticker = this.dataset.ticker;
        
        fetch('/api/watchlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ticker: ticker,
                type: 'crypto'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.innerHTML = '<i class="bi bi-star-fill"></i>';
                this.classList.remove('btn-outline-light');
                this.classList.add('btn-warning');
                
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>${ticker} lagt til i watchlist!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error adding to watchlist:', error);
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>Kunne ikke legge til i watchlist
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        });
    });
});
</script>
{% endblock %}
