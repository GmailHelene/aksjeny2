{% extends "base.html" %}

{% block title %}Priser - Aksjeradar{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Spar mer med √•rlig betaling</h1>
        <p class="lead text-muted">Velg mellom m√•nedlig og √•rlig abonnement - √•rlig gir deg kraftig rabatt</p>
    </div>

    <!-- Savings Highlight -->
    <div class="alert alert-success mb-5" role="alert">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="alert-heading mb-2">üí∞ Stor besparelse med √•rlig betaling!</h4>
                <p class="mb-0">Velg √•rlig abonnement og spar <strong>kr 1,789</strong> sammenlignet med m√•nedlig betaling. Det tilsvarer 37% rabatt!</p>
            </div>
            <div class="col-md-4 text-center">
                <div class="badge bg-success fs-5 px-3 py-2">
                    <i class="bi bi-piggy-bank me-2"></i>Spar kr 1,789
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Comparison -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <h2 class="mb-0">M√•nedlig vs √Örlig - Se forskjellen</h2>
                </div>
                <div class="card-body p-5">
                    <div class="row text-center">
                        <!-- Monthly Option -->
                        <div class="col-md-6">
                            <div class="border rounded p-4 h-100" style="border-color: #dc3545 !important; border-width: 2px !important;">
                                <i class="bi bi-calendar-month text-danger" style="font-size: 3rem;"></i>
                                <h3 class="mt-3 text-danger">M√•nedlig</h3>
                                <div class="mb-3">
                                    <span class="display-4 fw-bold">kr 399</span>
                                    <span class="text-muted h5">/mnd</span>
                                </div>
                                <div class="mb-3">
                                    <strong class="text-danger">Totalt per √•r: kr 4,788</strong>
                                </div>
                                <ul class="list-unstyled text-start mb-4">
                                    <li class="mb-2">‚úì Full tilgang til alle funksjoner</li>
                                    <li class="mb-2">‚úì Ingen bindingstid</li>
                                    <li class="mb-2">‚úì Kanseller n√•r som helst</li>
                                    <li class="mb-2 text-danger">‚úó Dyrere p√• lang sikt</li>
                                </ul>
                                {% if current_user.is_authenticated %}
                                <a href="https://buy.stripe.com/eVq14ng2x8kT1kH9tUfYY00" target="_blank" class="btn btn-outline-danger btn-lg w-100">
                                    Velg m√•nedlig - kr 399/mnd
                                </a>
                                {% else %}
                                <a href="{{ url_for('auth.login', next=request.url) }}" class="btn btn-outline-danger btn-lg w-100">
                                    Logg inn for √• kj√∏pe
                                </a>
                                <div class="mt-2">
                                    <small class="text-muted">Ikke medlem? <a href="{{ url_for('main.register', next=request.url) }}" class="text-decoration-none">Registrer deg her</a></small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Annual Option -->
                        <div class="col-md-6">
                            <div class="border rounded p-4 h-100 position-relative" style="border-color: #28a745 !important; border-width: 3px !important; background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);">
                                <div class="position-absolute top-0 start-50 translate-middle">
                                    <span class="badge bg-success px-4 py-2 fs-6">üíé BEST VERDI</span>
                                </div>
                                <i class="bi bi-calendar-check text-success" style="font-size: 3rem;"></i>
                                <h3 class="mt-3 text-success">√Örlig</h3>
                                <div class="mb-3">
                                    <span class="display-4 fw-bold text-success">kr 2,999</span>
                                    <span class="text-muted h5">/√•r</span>
                                </div>
                                <div class="mb-3">
                                    <strong class="text-success">Du sparer kr 1,789!</strong>
                                    <br><small class="text-muted">Kun kr 250/mnd</small>
                                </div>
                                <ul class="list-unstyled text-start mb-4">
                                    <li class="mb-2">‚úì Full tilgang til alle funksjoner</li>
                                    <li class="mb-2">‚úì Ingen bindingstid</li>
                                    <li class="mb-2">‚úì Kanseller n√•r som helst</li>
                                    <li class="mb-2 text-success"><strong>‚úì Spar kr 1,789 per √•r</strong></li>
                                </ul>
                                {% if current_user.is_authenticated %}
                                <a href="https://buy.stripe.com/7sYfZhbMh9oX4wT6hIfYY01" target="_blank" class="btn btn-success btn-lg w-100 shadow">
                                    <i class="bi bi-star-fill me-2"></i>Velg √•rlig - kr 2999/√•r
                                </a>
                                {% else %}
                                <a href="{{ url_for('auth.login', next=request.url) }}" class="btn btn-success btn-lg w-100 shadow">
                                    <i class="bi bi-star-fill me-2"></i>Logg inn for √• kj√∏pe
                                </a>
                                <div class="mt-2">
                                    <small class="text-muted">Ikke medlem? <a href="{{ url_for('main.register', next=request.url) }}" class="text-decoration-none">Registrer deg her</a></small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enterprise Option -->
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header text-center py-4 bg-light">
                    <h3 class="mb-0">Teams & Bedrifter</h3>
                    <p class="text-muted mb-0">Tilpassede l√∏sninger</p>
                </div>
                <div class="card-body text-center">
                    <i class="bi bi-building text-primary" style="font-size: 3rem;"></i>
                    <div class="mt-3 mb-4">
                        <span class="display-5 fw-bold">Kontakt oss</span>
                        <p class="text-muted">For skreddersydde l√∏sninger</p>
                    </div>
                    <ul class="list-unstyled mb-4">
                        <li>‚úì Alt fra √•rlig plan</li>
                        <li>‚úì Flere brukere per konto</li>
                        <li>‚úì Sentralisert administrasjon</li>
                        <li>‚úì Tilpassede rapporter</li>
                        <li>‚úì Dedikert kundeservice</li>
                    </ul>
                    <a href="mailto:kontakt@aksjeradar.trade?subject=Teams%20abonnement" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-envelope me-2"></i>Kontakt oss
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Savings Comparison -->
    <div class="mt-5">
        <h2 class="text-center mb-4">Spar penger med √•rlig abonnement</h2>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h4 class="text-success mb-3">√Örlig vs. M√•nedlig Besparelse</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded">
                                    <h5 class="text-muted">M√•nedlig</h5>
                                    <div class="h4">kr 399 √ó 12 = <span class="text-danger">kr 4,788</span></div>
                                    <small class="text-muted">Per √•r med m√•nedlig betaling</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-success text-white rounded">
                                    <h5>√Örlig</h5>
                                    <div class="h4">kr 2,999</div>
                                    <small>Betalt √•rlig</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="h3 text-success">Du sparer kr 1,789 per √•r!</div>
                            <p class="text-muted">Det tilsvarer 37% rabatt sammenlignet med m√•nedlig betaling</p>
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar bg-success" style="width: 63%;">
                                    √Örlig: kr 2,999
                                </div>
                                <div class="progress-bar bg-danger" style="width: 37%;">
                                    Du sparer: kr 1,789
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">Sammenligning av totalkostnad per √•r</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="mt-5">
        <h2 class="text-center mb-4">Ofte stilte sp√∏rsm√•l</h2>
        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <strong>Hvordan fungerer plattformen med abonnement?</strong>
                    <p>Du f√•r full tilgang til alle funksjoner med ditt abonnement, og det er ingen forskjell i tilgang til full funksjonalitet om du har Premium m√•neds-abonnement, eller Premium √•rs-abonnement.</p>
                </div>
                <div class="mb-4">
                    <strong>Hvordan betaler jeg?</strong>
                    <p>Du kan betale med kort (Visa, Mastercard). Alle priser vises i norske kroner (kr) og er inkl. mva.</p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="mb-4">
                    <strong>Er det bindingstid og kan jeg si opp n√•r som helst?</strong>
                    <p>Ditt abonnement fortsetter til slutten av betalingsperioden. Hvis du avslutter abonnementet ditt, l√∏per det ut perioden du har betalt for (m√•nedlig eller √•rlig), og fornyes automatisk neste periode hvis det ikke sies opp i forkant av utl√∏psdato for abonnert periode.</p>
                </div>
                <div class="mb-4">
                    <strong>Hva f√•r jeg med Premium?</strong>
                    <p>Full tilgang til alle analyser, real-time data, AI-verkt√∏y, portfolio tracking, varsler og alle premium funksjoner uten begrensninger.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Stripe Demo Modal -->
{% include 'pricing/stripe_demo_modal.html' %}

<style>
.card {
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.badge {
    font-size: 0.875rem;
    font-weight: 500;
}
</style>

<script>
// Enhanced Stripe form handling
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[action*="stripe"]');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starter betaling...';
            button.disabled = true;
            
            // Get form data - ensure CSRF token is fresh
            const formData = new FormData(form);
            
            // Double-check CSRF token exists
            if (!formData.get('csrf_token')) {
                console.warn('No CSRF token found, attempting to get from meta tag');
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                if (csrfToken) {
                    formData.set('csrf_token', csrfToken);
                }
            }
            
            // Send request to Stripe endpoint
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.demo_mode) {
                    // Show demo modal
                    const modal = new bootstrap.Modal(document.getElementById('stripeDemoModal'));
                    modal.show();
                    
                    // Reset button
                    button.innerHTML = originalText;
                    button.disabled = false;
                } else if (data.sessionId) {
                    // Redirect to Stripe Checkout (real payment)
                    button.innerHTML = '<i class="bi bi-arrow-right me-2"></i>Omdirigerer til betaling...';
                    window.location.href = `https://checkout.stripe.com/pay/${data.sessionId}`;
                } else if (data.error) {
                    // Show error
                    showErrorAlert(data.error);
                    
                    // Reset button
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Stripe error:', error);
                
                // Check if it's a CSRF error
                if (error.message.includes('401') || error.message.includes('403')) {
                    showErrorAlert('Sikkerhetssession utl√∏pt. Siden oppdateres automatisk...');
                    // Reload page after delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showErrorAlert('Det oppstod en teknisk feil. Pr√∏v igjen senere eller kontakt support.');
                }
                
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            });
        });
    });
});

function showErrorAlert(message) {
    const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Feil:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert at top of container
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert-danger');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 10000);
}
</script>
{% endblock %}
