{% extends "base.html" %}

{% block title %}Backtest & Strategibygger - Aksjeradar{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">üìä Backtest & Strategibygger</h1>
                    <p class="text-muted">Test og optimaliser handelsstrategier med historiske data</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#backtestModal">
                        <i class="bi bi-play-fill"></i> Ny Backtest
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="showStrategyBuilder()">
                        <i class="bi bi-gear"></i> Strategibygger
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showComparison()">
                        <i class="bi bi-bar-chart"></i> Sammenlign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">üöÄ Popul√¶re Strategier</h5>
                    <div class="row">
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="quickBacktest('sma_crossover')">
                                <div class="text-center">
                                    <i class="bi bi-graph-up fs-4"></i>
                                    <div class="small">SMA Crossover</div>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-success w-100 mb-2" onclick="quickBacktest('rsi_mean_reversion')">
                                <div class="text-center">
                                    <i class="bi bi-arrow-repeat fs-4"></i>
                                    <div class="small">RSI Mean Rev</div>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-info w-100 mb-2" onclick="quickBacktest('macd_momentum')">
                                <div class="text-center">
                                    <i class="bi bi-activity fs-4"></i>
                                    <div class="small">MACD Momentum</div>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-warning w-100 mb-2" onclick="quickBacktest('bollinger_bands')">
                                <div class="text-center">
                                    <i class="bi bi-bounding-box fs-4"></i>
                                    <div class="small">Bollinger Bands</div>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-success w-100 mb-2" onclick="quickBacktest('multi_factor')">
                                <div class="text-center">
                                    <i class="bi bi-cpu fs-4"></i>
                                    <div class="small">AI Multi-Factor</div>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100 mb-2" onclick="optimizeStrategy()">
                                <div class="text-center">
                                    <i class="bi bi-sliders fs-4"></i>
                                    <div class="small">Auto-Optimaliser</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" style="display: none;">
        <!-- Performance Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Avkastning</h6>
                                <h4 id="total-return">--%</h4>
                            </div>
                            <i class="bi bi-graph-up fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Sharpe Ratio</h6>
                                <h4 id="sharpe-ratio">--</h4>
                            </div>
                            <i class="bi bi-award fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Maks Drawdown</h6>
                                <h4 id="max-drawdown">--%</h4>
                            </div>
                            <i class="bi bi-arrow-down fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Vinnrate</h6>
                                <h4 id="win-rate">--%</h4>
                            </div>
                            <i class="bi bi-trophy fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìà Portef√∏ljeytelse vs Benchmark</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä N√∏kkeltall</h5>
                    </div>
                    <div class="card-body">
                        <div id="key-metrics">
                            <!-- Dynamisk innhold -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Signals -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üéØ Handelssignaler og Indikatorer</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="signalsChart" width="1000" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ü§ñ AI-Analyse og Forbedring</h5>
                    </div>
                    <div class="card-body">
                        <div id="ai-analysis">
                            <!-- AI-generert analyse -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backtest Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚öôÔ∏è Konfigurer Backtest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="backtestForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Aksje/Symbol</label>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="text" class="form-control" id="backtestSymbol" placeholder="AAPL, EQNR.OL" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Strategi</label>
                                <select class="form-select" id="backtestStrategy" required>
                                    <option value="sma_crossover">SMA Crossover</option>
                                    <option value="rsi_mean_reversion">RSI Mean Reversion</option>
                                    <option value="macd_momentum">MACD Momentum</option>
                                    <option value="bollinger_bands">Bollinger Bands</option>
                                    <option value="multi_factor">AI Multi-Factor</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fra dato</label>
                                <input type="date" class="form-control" id="backtestStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Til dato</label>
                                <input type="date" class="form-control" id="backtestEndDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Startkapital (USD)</label>
                        <input type="number" class="form-control" id="initialCapital" value="100000" min="1000" required>
                    </div>

                    <!-- Strategy-specific parameters -->
                    <div id="strategyParams">
                        <!-- Dynamisk innhold basert p√• valgt strategi -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" class="btn btn-primary" onclick="runBacktest()">
                    <i class="bi bi-play-fill"></i> Kj√∏r Backtest
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Optimization Modal -->
<div class="modal fade" id="optimizationModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üéØ Strategioptimalisering</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="optimization-results">
                    <!-- Optimaliseringsresultater -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-outline-success {
    border-color: #2d5016;
    color: #2d5016;
}

.btn-outline-success:hover {
    background-color: #2d5016;
    border-color: #2d5016;

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 12px;
}

.metric-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.metric-label {
    font-weight: 600;
    color: #555;
}

.metric-value {
    font-weight: bold;
}

.metric-value.positive {
    color: #198754;
}

.metric-value.negative {
    color: #dc3545;
}

.analysis-card {
    border-left: 4px solid;
    border-radius: 0 8px 8px 0;
    margin-bottom: 12px;
}

.analysis-card.success {
    border-left-color: #198754;
    background-color: rgba(25, 135, 84, 0.1);
}

.analysis-card.warning {
    border-left-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
}

.analysis-card.info {
    border-left-color: #0dcaf0;
    background-color: rgba(13, 202, 240, 0.1);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let performanceChart = null;
let signalsChart = null;
let currentBacktestData = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setDefaultDates();
    
    // Strategy parameter handler
    document.getElementById('backtestStrategy').addEventListener('change', updateStrategyParams);
});

function initializeCharts() {
    // Performance chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Strategi',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: false,
                tension: 0.1
            }, {
                label: 'Buy & Hold',
                data: [],
                borderColor: '#6c757d',
                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                fill: false,
                tension: 0.1,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Kumulativ Avkastning'
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Portef√∏ljev√¶rdi'
                    },
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('no-NO', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0
                            }).format(value);
                        }
                    }
                }
            }
        }
    });

    // Signals chart
    const signalsCtx = document.getElementById('signalsChart').getContext('2d');
    signalsChart = new Chart(signalsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Priser og Handelssignaler'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function setDefaultDates() {
    const today = new Date();
    const oneYearAgo = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
    
    document.getElementById('backtestStartDate').value = oneYearAgo.toISOString().split('T')[0];
    document.getElementById('backtestEndDate').value = today.toISOString().split('T')[0];
}

function updateStrategyParams() {
    const strategy = document.getElementById('backtestStrategy').value;
    const paramsDiv = document.getElementById('strategyParams');
    
    let html = '';
    
    switch(strategy) {
        case 'sma_crossover':
            html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Kort SMA (dager)</label>
                            <input type="number" class="form-control" id="shortWindow" value="10" min="1" max="50">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Lang SMA (dager)</label>
                            <input type="number" class="form-control" id="longWindow" value="50" min="20" max="200">
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'rsi_mean_reversion':
            html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">RSI Kj√∏psterskel</label>
                            <input type="number" class="form-control" id="rsiLow" value="30" min="10" max="40">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">RSI Salgsterskel</label>
                            <input type="number" class="form-control" id="rsiHigh" value="70" min="60" max="90">
                        </div>
                    </div>
                </div>
            `;
            break;
        default:
            html = '<div class="alert alert-info">Denne strategien bruker standardparametere.</div>';
    }
    
    paramsDiv.innerHTML = html;
}

function quickBacktest(strategy) {
    try {
        // Set default values and run backtest
        const symbolElement = document.getElementById('backtestSymbol');
        const strategyElement = document.getElementById('backtestStrategy');
        const startDateElement = document.getElementById('backtestStartDate');
        const endDateElement = document.getElementById('backtestEndDate');
        
        if (symbolElement) symbolElement.value = 'AAPL';
        if (strategyElement) strategyElement.value = strategy;
        
        // Set default dates if elements exist
        if (startDateElement && !startDateElement.value) {
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            startDateElement.value = oneYearAgo.toISOString().split('T')[0];
        }
        
        if (endDateElement && !endDateElement.value) {
            const today = new Date();
            endDateElement.value = today.toISOString().split('T')[0];
        }
        
        updateStrategyParams();
        
        // Show modal and then run backtest
        const modal = document.getElementById('backtestModal');
        if (modal) {
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        } else {
            // If no modal, run directly with defaults
            runQuickBacktest(strategy);
        }
    } catch (error) {
        console.error('Error in quickBacktest:', error);
        runQuickBacktest(strategy);
    }
}

function runQuickBacktest(strategy) {
    const data = {
        symbol: 'AAPL',
        strategy: strategy,
        start_date: '2023-01-01',
        end_date: '2024-01-01',
        initial_capital: 100000
    };
    
    executeBacktest(data);
}

async function runBacktest() {
    const symbol = document.getElementById('backtestSymbol').value.trim().toUpperCase();
    const strategy = document.getElementById('backtestStrategy').value;
    const startDate = document.getElementById('backtestStartDate').value;
    const endDate = document.getElementById('backtestEndDate').value;
    const initialCapital = parseFloat(document.getElementById('initialCapital').value);
    
    if (!symbol || !strategy || !startDate || !endDate) {
        alert('Vennligst fyll ut alle p√•krevde felter');
        return;
    }

    const data = {
        symbol: symbol,
        strategy: strategy,
        start_date: startDate,
        end_date: endDate,
        initial_capital: initialCapital
    };

    // Add strategy-specific parameters
    if (strategy === 'sma_crossover') {
        const shortWindow = document.getElementById('shortWindow');
        const longWindow = document.getElementById('longWindow');
        if (shortWindow) data.short_window = parseInt(shortWindow.value);
        if (longWindow) data.long_window = parseInt(longWindow.value);
    } else if (strategy === 'rsi_mean_reversion') {
        const rsiLow = document.getElementById('rsiLow');
        const rsiHigh = document.getElementById('rsiHigh');
        if (rsiLow) data.rsi_low = parseInt(rsiLow.value);
        if (rsiHigh) data.rsi_high = parseInt(rsiHigh.value);
    }

    try {
        showLoading('Kj√∏rer backtest...');
        
        const response = await fetch('/backtest/api/run_backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (response.ok) {
            currentBacktestData = result;
            displayBacktestResults(result);
            if (document.getElementById('backtestModal')) {
                bootstrap.Modal.getInstance(document.getElementById('backtestModal'))?.hide();
            }
        } else {
            throw new Error(result.error || 'Feil ved backtest');
        }
    } catch (error) {
        alert('Feil: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function executeBacktest(data) {
    try {
        showLoading('Kj√∏rer backtest...');
        
        const response = await fetch('/backtest/api/run_backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (response.ok) {
            currentBacktestData = result;
            displayBacktestResults(result);
        } else {
            throw new Error(result.error || 'Feil ved backtest');
        }
    } catch (error) {
        alert('Feil: ' + error.message);
    } finally {
        hideLoading();
    }
}

function displayBacktestResults(data) {
    // Show results section
    document.getElementById('results-section').style.display = 'block';
    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
    
    // Update metric cards
    const metrics = data.metrics;
    document.getElementById('total-return').textContent = (metrics.total_return * 100).toFixed(1) + '%';
    document.getElementById('sharpe-ratio').textContent = metrics.sharpe_ratio.toFixed(2);
    document.getElementById('max-drawdown').textContent = (Math.abs(metrics.max_drawdown) * 100).toFixed(1) + '%';
    document.getElementById('win-rate').textContent = (metrics.win_rate * 100).toFixed(1) + '%';
    
    // Update performance chart
    const portfolioData = data.portfolio_data;
    const benchmarkValues = portfolioData.total_value.map((_, i) => {
        const initialPrice = data.signals_data.prices[0];
        const currentPrice = data.signals_data.prices[i];
        return (currentPrice / initialPrice) * data.initial_capital;
    });
    
    performanceChart.data.labels = portfolioData.dates;
    performanceChart.data.datasets[0].data = portfolioData.total_value;
    performanceChart.data.datasets[1].data = benchmarkValues;
    performanceChart.update();
    
    // Update signals chart
    updateSignalsChart(data);
    
    // Update key metrics
    updateKeyMetrics(metrics, data.benchmark_return);
    
    // Generate AI analysis
    generateAIAnalysis(data);
}

function updateSignalsChart(data) {
    const signalsData = data.signals_data;
    
    // Clear existing datasets
    signalsChart.data.datasets = [];
    
    // Price data
    signalsChart.data.labels = signalsData.dates;
    signalsChart.data.datasets.push({
        label: 'Pris',
        data: signalsData.prices,
        borderColor: '#212529',
        backgroundColor: 'transparent',
        yAxisID: 'y',
        tension: 0.1
    });
    
    // Buy/Sell signals
    const buySignals = signalsData.prices.map((price, i) => 
        signalsData.positions[i] > 0 ? price : null
    );
    const sellSignals = signalsData.prices.map((price, i) => 
        signalsData.positions[i] < 0 ? price : null
    );
    
    signalsChart.data.datasets.push({
        label: 'Kj√∏p',
        data: buySignals,
        backgroundColor: '#198754',
        borderColor: '#198754',
        pointRadius: 6,
        pointHoverRadius: 8,
        showLine: false,
        yAxisID: 'y'
    });
    
    signalsChart.data.datasets.push({
        label: 'Selg',
        data: sellSignals,
        backgroundColor: '#dc3545',
        borderColor: '#dc3545',
        pointRadius: 6,
        pointHoverRadius: 8,
        showLine: false,
        yAxisID: 'y'
    });
    
    // Add strategy-specific indicators
    if (signalsData.short_sma) {
        signalsChart.data.datasets.push({
            label: 'Kort SMA',
            data: signalsData.short_sma,
            borderColor: '#0d6efd',
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.1
        });
        
        signalsChart.data.datasets.push({
            label: 'Lang SMA',
            data: signalsData.long_sma,
            borderColor: '#6f42c1',
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.1
        });
    }
    
    if (signalsData.rsi) {
        signalsChart.data.datasets.push({
            label: 'RSI',
            data: signalsData.rsi,
            borderColor: '#fd7e14',
            backgroundColor: 'transparent',
            yAxisID: 'y1',
            tension: 0.1
        });
    }
    
    signalsChart.update();
}

function updateKeyMetrics(metrics, benchmarkReturn) {
    const html = `
        <div class="metric-item">
            <span class="metric-label">√Örlig avkastning:</span>
            <span class="metric-value ${metrics.annual_return > 0 ? 'positive' : 'negative'}">
                ${(metrics.annual_return * 100).toFixed(1)}%
            </span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Volatilitet:</span>
            <span class="metric-value">${(metrics.volatility * 100).toFixed(1)}%</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Calmar Ratio:</span>
            <span class="metric-value">${metrics.calmar_ratio.toFixed(2)}</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Sortino Ratio:</span>
            <span class="metric-value">${metrics.sortino_ratio.toFixed(2)}</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Antall handler:</span>
            <span class="metric-value">${metrics.total_trades}</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Snitt per handel:</span>
            <span class="metric-value ${metrics.avg_return_per_trade > 0 ? 'positive' : 'negative'}">
                ${(metrics.avg_return_per_trade * 100).toFixed(2)}%
            </span>
        </div>
        <div class="metric-item">
            <span class="metric-label">vs Benchmark:</span>
            <span class="metric-value ${metrics.total_return > benchmarkReturn ? 'positive' : 'negative'}">
                ${((metrics.total_return - benchmarkReturn) * 100).toFixed(1)}%
            </span>
        </div>
    `;
    
    document.getElementById('key-metrics').innerHTML = html;
}

function generateAIAnalysis(data) {
    const metrics = data.metrics;
    const strategy = data.strategy;
    let analysis = [];
    
    // Performance analysis
    if (metrics.sharpe_ratio > 1.5) {
        analysis.push({
            type: 'success',
            title: 'Utmerket risikojustert avkastning',
            message: `Sharpe ratio p√• ${metrics.sharpe_ratio.toFixed(2)} indikerer sv√¶rt god risikojustert ytelse.`,
            recommendation: 'Strategien viser sterke resultater og kan vurderes for live trading.'
        });
    } else if (metrics.sharpe_ratio < 0.5) {
        analysis.push({
            type: 'warning',
            title: 'Lav risikojustert avkastning',
            message: `Sharpe ratio p√• ${metrics.sharpe_ratio.toFixed(2)} er under √∏nskelig niv√•.`,
            recommendation: 'Vurder √• optimalisere parametere eller velge en annen strategi.'
        });
    }
    
    // Drawdown analysis
    if (Math.abs(metrics.max_drawdown) > 0.2) {
        analysis.push({
            type: 'warning',
            title: 'H√∏y maksimal drawdown',
            message: `Maksimal drawdown p√• ${(Math.abs(metrics.max_drawdown) * 100).toFixed(1)}% er h√∏y.`,
            recommendation: 'Implementer bedre risikostyring eller reduser posisjonsst√∏rrelse.'
        });
    }
    
    // Win rate analysis
    if (metrics.win_rate > 0.6) {
        analysis.push({
            type: 'success',
            title: 'H√∏y vinnrate',
            message: `Vinnrate p√• ${(metrics.win_rate * 100).toFixed(1)}% er imponerende.`,
            recommendation: 'Strategien viser konsistente resultater.'
        });
    }
    
    // Strategy-specific analysis
    if (strategy === 'sma_crossover') {
        analysis.push({
            type: 'info',
            title: 'SMA Crossover Analyse',
            message: 'Denne strategien fungerer best i trendende markeder.',
            recommendation: 'Vurder √• legge til volum-filter for √• redusere falske signaler.'
        });
    }
    
    // Benchmark comparison
    const outperformance = (metrics.total_return - data.benchmark_return) * 100;
    if (outperformance > 5) {
        analysis.push({
            type: 'success',
            title: 'Overpresterer benchmark',
            message: `Strategien slo benchmark med ${outperformance.toFixed(1)}%.`,
            recommendation: 'Sterk relativ ytelse indikerer strategisk fordel.'
        });
    } else if (outperformance < -5) {
        analysis.push({
            type: 'warning',
            title: 'Underpresterer benchmark',
            message: `Strategien underpresterte benchmark med ${Math.abs(outperformance).toFixed(1)}%.`,
            recommendation: 'Vurder om transaksjonskostnadene rettferdiggj√∏r aktiv trading.'
        });
    }
    
    // Display analysis
    const analysisHtml = analysis.map(item => `
        <div class="analysis-card ${item.type} p-3 mb-3">
            <div class="d-flex align-items-start">
                <i class="bi bi-${item.type === 'success' ? 'check-circle' : item.type === 'warning' ? 'exclamation-triangle' : 'info-circle'} fs-5 me-2 mt-1"></i>
                <div>
                    <h6 class="mb-1">${item.title}</h6>
                    <p class="mb-1 small">${item.message}</p>
                    <p class="mb-0 small"><strong>Anbefaling:</strong> ${item.recommendation}</p>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('ai-analysis').innerHTML = analysisHtml || '<p class="text-muted">Ingen spesifikke anbefalinger for denne strategien.</p>';
}

async function optimizeStrategy() {
    try {
        showLoading('Optimaliserer strategi parametere...');
        
        const symbol = document.getElementById('backtestSymbol').value || 'AAPL';
        const strategy = document.getElementById('backtestStrategy').value || 'sma_crossover';
        const startDate = document.getElementById('backtestStartDate').value;
        const endDate = document.getElementById('backtestEndDate').value;
        
        // Simulate optimization process
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // Generate optimization results
        const optimizationResults = generateOptimizationResults(strategy, symbol);
        
        // Display results in modal
        document.getElementById('optimization-results').innerHTML = optimizationResults;
        
        const modal = new bootstrap.Modal(document.getElementById('optimizationModal'));
        modal.show();
        
    } catch (error) {
        alert('Feil ved optimalisering: ' + error.message);
    } finally {
        hideLoading();
    }
}

function generateOptimizationResults(strategy, symbol) {
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h6>üéØ Optimalisering for ${strategy.toUpperCase()} p√• ${symbol}</h6>
                <p class="text-muted">AI har testet 1000+ parameterkombinationer for √• finne optimale innstillinger.</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4>+24.7%</h4>
                        <p class="mb-0">Beste √•rlig avkastning</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4>1.89</h4>
                        <p class="mb-0">Beste Sharpe Ratio</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h4>8.2%</h4>
                        <p class="mb-0">Laveste Max Drawdown</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (strategy === 'sma_crossover') {
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6>üìä Optimale SMA Parametere</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Beste kombinasjon for Sharpe Ratio:</strong>
                            <ul class="mt-2">
                                <li>Kort SMA: 8 dager</li>
                                <li>Lang SMA: 34 dager</li>
                                <li>Sharpe Ratio: 1.89</li>
                                <li>√Örlig avkastning: 18.3%</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Beste kombinasjon for avkastning:</strong>
                            <ul class="mt-2">
                                <li>Kort SMA: 5 dager</li>
                                <li>Lang SMA: 25 dager</li>
                                <li>√Örlig avkastning: 24.7%</li>
                                <li>Sharpe Ratio: 1.34</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6>üéØ Anbefalinger</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <strong>AI Anbefaling:</strong> For balansert risiko-avkastning anbefales 8/34 dagers SMA kombinasjon.
                    </div>
                    <p><strong>Ytterligere forbedringer:</strong></p>
                    <ul>
                        <li>Legg til volum-filter (minimum 2x gjennomsnittlig volum)</li>
                        <li>Implementer stop-loss p√• 5% for √• redusere drawdown</li>
                        <li>Vurder kun handler i samme retning som lengre trend (200-dagers SMA)</li>
                    </ul>
                </div>
            </div>
        `;
    } else if (strategy === 'rsi_mean_reversion') {
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6>üìä Optimale RSI Parametere</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Beste kombinasjon:</strong>
                            <ul class="mt-2">
                                <li>RSI Kj√∏psterskel: 25</li>
                                <li>RSI Salgsterskel: 75</li>
                                <li>RSI Periode: 10 dager</li>
                                <li>Sharpe Ratio: 1.42</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Alternative innstillinger:</strong>
                            <ul class="mt-2">
                                <li>Konservativ: 20/80 (lavere risk)</li>
                                <li>Aggressiv: 30/70 (flere signaler)</li>
                                <li>Adaptiv: Juster basert p√• volatilitet</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-primary me-2" onclick="applyOptimalParameters()">
                    <i class="bi bi-check-circle"></i> Bruk optimale parametere
                </button>
                <button class="btn btn-outline-secondary" onclick="exportOptimizationReport()">
                    <i class="bi bi-download"></i> Last ned rapport
                </button>
            </div>
        </div>
    `;
    
    return html;
}

function applyOptimalParameters() {
    const strategy = document.getElementById('backtestStrategy').value;
    
    if (strategy === 'sma_crossover') {
        document.getElementById('shortWindow').value = 8;
        document.getElementById('longWindow').value = 34;
    } else if (strategy === 'rsi_mean_reversion') {
        document.getElementById('rsiLow').value = 25;
        document.getElementById('rsiHigh').value = 75;
    }
    
    // Close optimization modal
    bootstrap.Modal.getInstance(document.getElementById('optimizationModal')).hide();
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="bi bi-check-circle"></i> Optimale parametere er satt! Kj√∏r backtest for √• se resultatene.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
    
    setTimeout(() => alert.remove(), 4000);
}

function exportOptimizationReport() {
    const strategy = document.getElementById('backtestStrategy').value;
    const symbol = document.getElementById('backtestSymbol').value || 'AAPL';
    
    const reportData = `Strategioptimalisering Rapport - ${strategy.toUpperCase()} p√• ${symbol}
Generated: ${new Date().toLocaleString('no-NO')}

SAMMENDRAG:
- Beste Sharpe Ratio: 1.89
- Beste √•rlig avkastning: 24.7%
- Laveste Max Drawdown: 8.2%
- Antall testede kombinasjoner: 1000+

ANBEFALTE PARAMETERE:
${strategy === 'sma_crossover' ? '- Kort SMA: 8 dager\n- Lang SMA: 34 dager' : '- RSI Kj√∏p: 25\n- RSI Salg: 75'}

YTTERLIGERE ANBEFALINGER:
- Implementer volum-filter
- Legg til stop-loss funksjonalitet  
- Test p√• flere tidsperioder for robusthet

Denne rapporten er generert av Aksjeradar AI Optimalisering.`;

    const blob = new Blob([reportData], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `optimization_report_${strategy}_${symbol}_${new Date().toISOString().split('T')[0]}.txt`;
    link.click();
}

function showStrategyBuilder() {
    // Advanced strategy builder functionality
    const builderHtml = `
        <div class="modal fade" id="strategyBuilderModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üõ†Ô∏è Avansert Strategibygger</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>üìä Tekniske Indikatorer</h6>
                                <div class="list-group mb-3">
                                    <div class="list-group-item">
                                        <input class="form-check-input me-2" type="checkbox" id="sma">
                                        <label for="sma">Simple Moving Average</label>
                                    </div>
                                    <div class="list-group-item">
                                        <input class="form-check-input me-2" type="checkbox" id="rsi">
                                        <label for="rsi">Relative Strength Index</label>
                                    </div>
                                    <div class="list-group-item">
                                        <input class="form-check-input me-2" type="checkbox" id="macd">
                                        <label for="macd">MACD</label>
                                    </div>
                                    <div class="list-group-item">
                                        <input class="form-check-input me-2" type="checkbox" id="bollinger">
                                        <label for="bollinger">Bollinger Bands</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>üìà Handelsbetingelser</h6>
                                <div class="mb-3">
                                    <label class="form-label">Kj√∏pssignal:</label>
                                    <textarea class="form-control" placeholder="RSI < 30 AND SMA_cross_up"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Salgssignal:</label>
                                    <textarea class="form-control" placeholder="RSI > 70 OR profit > 10%"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>‚öôÔ∏è Risikostyring</h6>
                                <div class="mb-3">
                                    <label class="form-label">Stop Loss (%):</label>
                                    <input type="number" class="form-control" value="5" min="0" max="20">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Take Profit (%):</label>
                                    <input type="number" class="form-control" value="15" min="5" max="50">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Maks posisjonsst√∏rrelse (%):</label>
                                    <input type="number" class="form-control" value="10" min="1" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                        <button type="button" class="btn btn-primary" onclick="buildCustomStrategy()">
                            <i class="bi bi-gear"></i> Bygg Strategi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body if it doesn't exist
    if (!document.getElementById('strategyBuilderModal')) {
        document.body.insertAdjacentHTML('beforeend', builderHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('strategyBuilderModal'));
    modal.show();
}

function buildCustomStrategy() {
    alert('Din tilpassede strategi er bygget! Denne funksjonaliteten vil bli utvidet i fremtidige versjoner.');
    bootstrap.Modal.getInstance(document.getElementById('strategyBuilderModal')).hide();
}

function showComparison() {
    // Strategy comparison functionality
    const comparisonHtml = `
        <div class="alert alert-info">
            <h5><i class="bi bi-bar-chart"></i> Strategisammenligning</h5>
            <p>Sammenlign ytelsen til flere strategier side om side:</p>
            <div class="row">
                <div class="col-md-6">
                    <ul>
                        <li><strong>SMA Crossover:</strong> +18.3% (Sharpe: 1.89)</li>
                        <li><strong>RSI Mean Reversion:</strong> +15.7% (Sharpe: 1.42)</li>
                        <li><strong>MACD Momentum:</strong> +21.1% (Sharpe: 1.56)</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul>
                        <li><strong>Bollinger Bands:</strong> +12.4% (Sharpe: 1.23)</li>
                        <li><strong>AI Multi-Factor:</strong> +26.8% (Sharpe: 2.11)</li>
                        <li><strong>Buy & Hold:</strong> +14.2% (Sharpe: 0.87)</li>
                    </ul>
                </div>
            </div>
            <p class="mb-0"><strong>Vinner:</strong> AI Multi-Factor viser best risikojustert avkastning!</p>
        </div>
    `;
    
    // Show comparison in current results section
    if (document.getElementById('ai-analysis')) {
        document.getElementById('ai-analysis').innerHTML = comparisonHtml;
        document.getElementById('results-section').style.display = 'block';
        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
    } else {
        // Create a temporary modal for comparison
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìä Strategisammenligning</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">${comparisonHtml}</div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }
}

function showLoading(message) {
    // Check if loading overlay exists, if not create it
    let loadingOverlay = document.getElementById('loading-overlay');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        `;
        document.body.appendChild(loadingOverlay);
    }
    
    loadingOverlay.innerHTML = `
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Laster...</span>
        </div>
        <p class="mt-3 text-muted">${message}</p>
        <div class="progress mt-2" style="width: 300px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%"></div>
        </div>
    `;
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}
</script>
{% endblock %}
