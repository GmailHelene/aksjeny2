{% extends 'base.html' %}

{% block title %}Min portefølje{% endblock %}

{% block content %}
<div class="container mt-4">
  {# Flash / error message #}
  {% if error_message %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>{{ error_message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  {# Primary empty state #}
  {% if not portfolios or portfolios|length == 0 %}
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-briefcase display-1 text-muted"></i>
      </div>
      <h3 class="text-muted">Ingen porteføljer ennå</h3>
      <p class="text-muted">Kom i gang ved å opprette din første portefølje!</p>
      <a href="{{ url_for('portfolio.create_portfolio') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Opprett din første portefølje
      </a>
    </div>
  {% else %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2 mb-0">Mine porteføljer</h1>
      <a href="{{ url_for('portfolio.create_portfolio') }}" class="btn btn-success">
        <i class="bi bi-plus-circle me-2"></i>Opprett ny portefølje
      </a>
    </div>

    {# Portfolio selector if multiple #}
    {% if portfolios|length > 1 %}
      <div class="row mb-4">
        <div class="col-md-6">
          <label for="portfolioSelect" class="form-label">Velg portefølje:</label>
          <select class="form-select" id="portfolioSelect" onchange="switchPortfolio(this.value)">
            {% for p in portfolios %}
              <option value="{{ p.id }}" {% if portfolio and p.id == portfolio.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
    // Modal-based portfolio deletion with typed confirmation
    let deletePortfolioId = null;
    function deletePortfolio(portfolioId) {
      deletePortfolioId = portfolioId;
      const modalEl = document.getElementById('confirmDeletePortfolioModal');
      if (!modalEl) return;
      const portfolioName = document.querySelector('h2.mb-1')?.innerText || 'porteføljen';
      modalEl.querySelector('#deletePortfolioName').innerText = portfolioName;
      modalEl.querySelector('#confirmPortfolioName').value = '';
      modalEl.querySelector('#confirmDeleteBtn').disabled = true;
      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    }

    function onPortfolioNameInput(ev) {
      const input = ev.target.value.trim();
      const expected = document.getElementById('deletePortfolioName').innerText.trim();
      document.getElementById('confirmDeleteBtn').disabled = (input !== expected);
    }

    function submitPortfolioDeletion() {
      if (!deletePortfolioId) return;
      const portfolioCard = document.querySelector(`[data-portfolio-id="${deletePortfolioId}"]`);
      if (portfolioCard) {
        portfolioCard.style.opacity = '0.5';
        portfolioCard.style.pointerEvents = 'none';
      }
      fetch(`/portfolio/delete/${deletePortfolioId}`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(data.message || 'Portefølje slettet', 'success');
          setTimeout(() => window.location.href = '/portfolio/overview', 600);
        } else {
          if (portfolioCard) {
            portfolioCard.style.opacity = '1';
            portfolioCard.style.pointerEvents = 'auto';
          }
          showToast(data.error || 'Kunne ikke slette portefølje', 'error');
        }
      })
      .catch(err => {
        console.error('Delete portfolio error', err);
        if (portfolioCard) {
          portfolioCard.style.opacity = '1';
          portfolioCard.style.pointerEvents = 'auto';
        }
        showToast('Teknisk feil ved sletting av portefølje', 'error');
      });
    }
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th><i class="bi bi-tag me-1"></i>Ticker</th>
                <th><i class="bi bi-hash me-1"></i>Antall</th>
                <th><i class="bi bi-currency-exchange me-1"></i>Kjøpspris</th>
                <th><i class="bi bi-graph-up me-1"></i>Nåværende pris</th>
                <th><i class="bi bi-wallet me-1"></i>Verdi</th>
                <th><i class="bi bi-calculator me-1"></i>Gevinst/Tap</th>
                <th><i class="bi bi-percent me-1"></i>%</th>
                <th><i class="bi bi-gear me-1"></i>Handlinger</th>
              </tr>
            </thead>
            <tbody>
              {% for ticker, data in stocks.items() %}
              <tr>
                <td><strong>{{ ticker }}</strong></td>
                <td>{{ data.shares }}</td>
                <td>{{ data.purchase_price|round(2) }} NOK</td>
                <td>
                  {% if data.last_price != 'N/A' %}
                    {{ data.last_price|round(2) }} NOK
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if data.last_price != 'N/A' %}
                    {{ (data.last_price * data.shares)|round(2) }} NOK
                  {% else %}
                    {{ (data.shares * data.purchase_price)|round(2) }} NOK
                  {% endif %}
                </td>
                <td class="{% if data.profit_loss > 0 %}text-success{% elif data.profit_loss < 0 %}text-danger{% endif %}">
                  {% if data.profit_loss > 0 %}
                    <i class="bi bi-arrow-up"></i> +{{ data.profit_loss|round(2) }}
                  {% elif data.profit_loss < 0 %}
                    <i class="bi bi-arrow-down"></i> {{ data.profit_loss|round(2) }}
                  {% else %}
                    <i class="bi bi-dash"></i> 0.00
                  {% endif %}
                  NOK
                </td>
                <td class="{% if data.profit_loss_percent > 0 %}text-success{% elif data.profit_loss_percent < 0 %}text-danger{% endif %}">
                  {% if data.profit_loss_percent > 0 %}
                    <i class="bi bi-arrow-up"></i> +{{ data.profit_loss_percent|round(2) }}%
                  {% elif data.profit_loss_percent < 0 %}
                    <i class="bi bi-arrow-down"></i> {{ data.profit_loss_percent|round(2) }}%
                  {% else %}
                    <i class="bi bi-dash"></i> 0.00%
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group" role="group">
                    <a href="{{ url_for('stocks.details', symbol=ticker) }}" class="btn btn-sm btn-outline-primary" title="Se detaljer">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('portfolio.edit_stock', ticker=ticker) }}" class="btn btn-sm btn-outline-secondary" title="Rediger">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeStock({{ data.stock_id }})" title="Fjern">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Portfolio Actions -->
    <div class="d-flex justify-content-between mb-4">
      <div>
        <a href="{{ url_for('portfolio.add_stock_to_portfolio', id=portfolio.id) }}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>Legg til aksje
        </a>
        <a href="{{ url_for('portfolio.transactions') }}" class="btn btn-outline-info">
          <i class="bi bi-list-ul me-2"></i>Transaksjoner
        </a>
      </div>
      <div>
        <button class="btn btn-outline-danger" onclick="deletePortfolio({{ portfolio.id }})">
          <i class="bi bi-trash me-2"></i>Slett portefølje
        </button>
      </div>
    </div>
    
    {% elif portfolios %}
      <div class="alert alert-warning">
        <h4><i class="bi bi-exclamation-triangle me-2"></i>Porteføljen er tom</h4>
        <p>Du har opprettet porteføljer, men de inneholder ingen aksjer ennå.</p>
        <a href="{{ url_for('portfolio.add_stock_to_portfolio', id=portfolios[0].id) }}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>Legg til din første aksje
        </a>
      </div>
    {% endif %}
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function deletePortfolio(portfolioId) {
    if (confirm('Er du sikker på at du vil slette denne porteføljen? Denne handlingen kan ikke angres.')) {
        // Show loading state
        const portfolioCard = document.querySelector(`[data-portfolio-id="${portfolioId}"]`);
        if (portfolioCard) {
            portfolioCard.style.opacity = '0.5';
            portfolioCard.style.pointerEvents = 'none';
        }

  fetch(`/portfolio/delete/${portfolioId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Animate removal of the portfolio card
                if (portfolioCard) {
                    portfolioCard.style.transition = 'all 0.3s ease';
                    portfolioCard.style.opacity = '0';
                    portfolioCard.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        portfolioCard.remove();
                        
                        // Show success toast
                        showToast(data.message || 'Portefølje slettet', 'success');
                        
                        // Check if no portfolios remain
                        const remainingCards = document.querySelectorAll('[data-portfolio-id]');
                        if (remainingCards.length === 0) {
                            location.reload(); // Reload to show "no portfolios" message
                        }
                    }, 300);
                }
            } else {
                // Reset card state and show error
                if (portfolioCard) {
                    portfolioCard.style.opacity = '1';
                    portfolioCard.style.pointerEvents = 'auto';
                }
                showToast(data.error || 'Kunne ikke slette portefølje', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting portfolio:', error);
            // Reset card state and show error
            if (portfolioCard) {
                portfolioCard.style.opacity = '1';
                portfolioCard.style.pointerEvents = 'auto';
            }
            showToast('Teknisk feil ved sletting av portefølje', 'error');
    });
  }

function removeStock(stockId) {
    if (confirm('Er du sikker på at du vil fjerne denne aksjen fra porteføljen?')) {
        // Find portfolio ID from current context
        const portfolioId = {{ portfolio.id if portfolio else 'null' }};
        if (!portfolioId) {
            alert('Kunne ikke identifisere portefølje-ID');
            return;
        }
        
        fetch(`/portfolio/${portfolioId}/remove/${stockId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Aksjen ble fjernet fra porteføljen.');
                window.location.reload();
            } else {
                alert('Kunne ikke fjerne aksjen: ' + (data.error || 'Ukjent feil'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Det oppstod en feil ved fjerning av aksjen: ' + error.message);
        });
    }
}

function switchPortfolio(portfolioId) {
    // Redirect to the same page with selected portfolio
    window.location.href = `/portfolio?selected=${portfolioId}`;
}

// Dynamic widget display based on user preferences
document.addEventListener('DOMContentLoaded', function() {
    // Load user preferences for dashboard widgets
    fetch('/api/user/preferences')
        .then(response => {
            if (!response.ok) {
                throw new Error('Could not load preferences');
            }
            return response.json();
        })
        .then(data => {
            let widgets = [];
            try { 
                widgets = JSON.parse(data.dashboard_widgets || '[]'); 
            } catch(e) {
                // Default widgets if parsing fails
                widgets = ['total-value', 'profit-loss', 'alerts'];
            }
            
            // Show widgets based on preferences
            if (widgets.includes('total-value')) {
                document.getElementById('widget-total-value').style.display = '';
            }
            if (widgets.includes('profit-loss')) {
                document.getElementById('widget-profit-loss').style.display = '';
            }
            if (widgets.includes('alerts')) {
                document.getElementById('widget-alerts').style.display = '';
            }
        })
        .catch(error => {
            console.log('Could not load widget preferences, showing defaults');
            // Show all widgets by default if preferences can't be loaded
            document.getElementById('widget-total-value').style.display = '';
            document.getElementById('widget-profit-loss').style.display = '';
            document.getElementById('widget-alerts').style.display = '';
        });
});
</script>

<!-- Delete Portfolio Confirmation Modal -->
<div class="modal fade" id="confirmDeletePortfolioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Bekreft sletting</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>For å bekrefte sletting, skriv navnet på porteføljen nedenfor:</p>
        <p class="fw-bold text-danger" id="deletePortfolioName">(navn)</p>
        <input type="text" id="confirmPortfolioName" oninput="onPortfolioNameInput(event)" class="form-control" placeholder="Skriv porteføljenavnet" autocomplete="off" />
        <div class="form-text">Denne handlingen kan ikke angres.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-danger" onclick="submitPortfolioDeletion()" disabled>Slett</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
